function JavaStringHashCode(e){for(var n=0,t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n&=n;return n}function OSTHash(e,n){function t(n,t,r){var s=new FileReader;s.onload=function(e){r.call(s,o(e.target.result))},s.readAsBinaryString(void 0===t?e.slice(n):e.slice(n,t))}function o(e){for(var n=0;n<e.length;n++)i[(n+8)%8]+=e.charCodeAt(n)}function r(e){var n=255,t="0123456789abcdef",o="",r=7;for(e[1]+=e[0]>>8,e[0]=e[0]&n,e[2]+=e[1]>>8,e[1]=e[1]&n,e[3]+=e[2]>>8,e[2]=e[2]&n,e[4]+=e[3]>>8,e[3]=e[3]&n,e[5]+=e[4]>>8,e[4]=e[4]&n,e[6]+=e[5]>>8,e[5]=e[5]&n,e[7]+=e[6]>>8,e[6]=e[6]&n,e[7]=e[7]&n,r;r>-1;r--)o+=t.charAt(e[r]>>4&15)+t.charAt(15&e[r]);return o}console.log("compute OST hash",e);for(var s=65536,i=[],a=e.size,c=0;8>c;c++)i[c]=255&a,a>>=8;t(0,s,function(){t(e.size-s,void 0,function(){n.call(null,e,r(i))})})}function create_hidden(){function e(e){e.outerBounds.setPosition(screen.width-n,screen.availHeight-t-60),e.outerBounds.setSize(n,t),e.show(),e.minimize(),e.onClosed.addListener(function(){var n=chrome.app.window.getAll(),t=!1;for(var o in webapp.streams){t=!0;break}t&&(1==n.length&&"hidden"==e.id||0==n.length)&&setTimeout(function(){create_hidden()},1e3)})}if(console.log("create_hidden"),"Chrome"==OS&&!chrome.app.window.get("hidden")){console.log("creating hidden window");var n=300,t=120,o={id:"hidden",hidden:!0};chrome.app.window.create("hidden.html",o,e)}}function initialize_ga(e){return}function onPlatformInfo(e){var n=navigator.userAgent.match("Chrome/([0-9]+)"),t="?";n&&(t=n[1]);var o="OS="+e.os+",ARCH="+e.arch+",VER="+t;tracker.sendEvent("Platform",o)}function on_ga(){chrome.runtime.getPlatformInfo(onPlatformInfo)}function things(){window.tracker||initialize_ga(on_ga),THINGS=!0,console.log=function(){var e="%cBG",n="color:white;background:green";return Function.prototype.bind.call(console.log,console,e,n)}(),console.log("Things!"),window.BG_START_TIME=(new Date).getTime(),window.STREAMCTR=1,window.WEBAPP_PORT=8643,window.MANIFEST=chrome.runtime.getManifest(),window.STATE={},chrome.storage.local.get("STREAMST",function(e){e.STREAMST&&(window.STREAMST=e.STREAMST)}),window.DEVMODE=!1,chrome.runtime.getManifest().update_url||(console.log("UNPACKED - DEV MODE!"),DEVMODE=!0),window.VALID_REFERERS=["http://www.mp4cast.com","http://local.mp4cast.com","https://www.mp4cast.com"],window.WEB_URL=DEVMODE?"http://local.mp4cast.com:8887":"http://www.mp4cast.com",window.OS=null,OS=navigator.userAgent.match("OS X")?"Mac":navigator.userAgent.match("Windows")?"Win":"Chrome",window.webapp=null}function ondisconnect(e){console.log("port disconnected",e)}function onmessage(e,n){console.log("onmessage",e,n)}function sentmessage(e){console.log("sentmessage",e)}function get_status(){var e={uptime:new Date-BG_START_TIME,version:MANIFEST.version};return e.webapp=webapp?webapp.get_info():null,e}function getOMDBInfo(e,n,t,o){if(n=n||{},!n.nocache){var r=getOMDBInfo_cache[e];if(r)return console.log("using cached omdb info",e,r),o(r)}getOMDBInfo_queue.push([e,n,t,o]),getOMDBInfo_processqueue()}function getOMDBInfo_processqueue(){function e(e){getOMDBInfo_queue_running=!1,r.nocache||(console.log("set OMDB cache",o),getOMDBInfo_cache[o]=e),i(e),getOMDBInfo_processqueue()}function n(n){200==n.target.status?n.target.response.Error?(console.error("OMDB error:",n.target.response),e({error:n.target.status,evt:n})):e(n.target.response):(console.error("OMDB request error",n),e({error:n.target.status,evt:n}))}if(0!=getOMDBInfo_queue.length&&!getOMDBInfo_queue_running){var t=getOMDBInfo_queue.shift(1),o=t[0],r=t[1],s=t[2],i=t[3];getOMDBInfo_queue_running=!0,console.log("omdb queue popping",o);var a=s.ptn.title||s.ptn.episodeName||s.name,c=new XMLHttpRequest;if(s.ptn.episode)var l=s.ptn.season||1,d="http://www.omdbapi.com/?t="+encodeURIComponent(a)+"&y=&plot=short&r=json&season="+l+"&episode="+s.ptn.episode;else var d="http://www.omdbapi.com/?t="+encodeURIComponent(a)+"&y=&plot=short&r=json";c.open("GET",d),console.log("OMDB query",s,d),c.responseType="json",c.onload=n,c.onerror=n,c.send()}}function getdummy(e){var n=chrome.app.window.get("dummy");n?e(n):chrome.app.window.create("dummy.html",{hidden:!0,id:"dummy"},function(n){e(n)})}function proxyValidation(e){return!1}function StreamHandler(e){WSC.DirectoryEntryHandler.prototype.constructor.call(this,null,e)}function StatusHandler(){WSC.BaseHandler.prototype.constructor.call(this)}function startWebApp(e){function n(e){console.log("webapp stopped",e);for(var n in allconns)allconns[n].port.postMessage({type:"broadcast",webapp:webapp.get_info()})}function t(n){console.log("sending broadcast message");for(var t in allconns)allconns[t].port.postMessage({type:"broadcast",webapp:webapp.get_info()});e&&e(n)}if(webapp)return void(webapp.starting?e(webapp.get_info()):webapp.started?e(webapp.get_info()):webapp.start(t,!1));var o={};o.port=WEBAPP_PORT,o.optPreventSleep=!0,o.optAllInterfaces=!0,o.optTryOtherPorts=!0,o.optRetryInterfaces=!0,o.useCORSHeaders=!0,o.optStopIdleServer=3e4,o.handlers=[],o.handlers.push(["/proxy",WSC.ProxyHandler.bind(null,proxyValidation)]),o.handlers.push(["/status",StatusHandler]),o.handlers.push(["/stream.*",StreamHandler]),window.webapp=new WSC.WebApplication(o),webapp._stop_callback=n,webapp.start(t)}function collectAllFileInfo(e,n,t){function o(e){i.imdb_info=e,t(i)}function r(n){i.metadata=n;var t=chrome.runtime.lastError;(t||!n)&&console.error("mediaGalliers fetch error",t,n),getOMDBInfo(e,{},i,o)}function s(e){e||(console.error("entry.file() onfile error",e),r()),i.size=e.size,i.modified=e.lastModified,chrome.mediaGalleries.getMetadata(e,{},r)}var i={name:n.name,retainstr:e,fullPath:n.fullPath,ptn:ptn(n.name)};n.file(s,s)}function getEntry(e,n){chrome.fileSystem.restoreEntry(e,function(e){if(void 0===e){var t=chrome.runtime.lastError;console.log("getEntry(restore) lasterr:",t),n({error:"file not found",message:t.message})}else n(e)})}function getSubtitles(e,n){getEntry(e,function(e){function t(e){OSTHash(e,function(t,o){console.log("got opensubtitle hash",o);var r="http://www.opensubtitles.org/search/sublanguageid-eng/moviebytesize-"+e.size+"/moviehash-"+o;console.log("OPENSUBTITLE URL",r),n(r)})}e.file(t,t)})}function getURL(e,n){function t(e){n(e)}var o=new WSC.ChromeSocketXMLHttpRequest;o.open("GET",e),o.onload=o.onerror=o.ontimeout=t,o.send()}function onconnectexternal(e){THINGS||things();new WebsiteConnection(e)}function hasKey(e){for(var n in e)return!0;return!1}function launch(e){if(THINGS||things(),console.log("Launch with opts",e),"reload"!=e.source){var n=0;for(var t in allconns)console.log("closing tab",t),allconns[t].port.postMessage({command:"onLaunchClose"}),n++;chrome.browser.openTab({url:WEB_URL})}}function notifyHiddenWindow(){function e(){}var n={type:"basic",iconUrl:"/icons/icon-128.png",title:"MP4Cast",message:"For this app to work, we need a window to be open."};chrome.notifications.create("hidden",n,e)}function createReallyHiddenWindow(){function e(e){var n=e||chrome.app.window.get("hidden");console.log("resetting bounds"),n.setBounds({left:0,top:s,width:r,height:r}),n.show()}function n(){console.log("onrestored"),setTimeout(function(){e()},1)}function t(t){e(t),t.show(),t.onRestored.addListener(n),t.onClosed.addListener(notifyHiddenWindow)}if("Chrome"==OS){var o=chrome.app.window.get("hidden");if(o)return e(o);var r=1,s=0;screen.availHeight>0&&(s=screen.availHeight-r),console.log("create really hidden window");var i={frame:"none",id:"hidden",hidden:!0,state:"minimized",resizable:!1,focused:!1};chrome.app.window.create("hidden.html",i,t)}}!function(){function e(e){var o=[];if(void 0===e||0==e)return"";for(var r=t.length-1;r>=0;r--)e>t[r]&&(o.push(Math.floor(e/t[r])+n[r]),e%=t[r]);return o.join(" ")}var n=["s","m","h","d"],t=[1,60,3600,86400];window.formatValTime=e}(),function(){"use strict";function e(e){this.port=e,this.thisportid=n++,allconns[this.thisportid]=this,console.log("received onconnection request on port",e,e.sender.url),e.postMessage(get_status()),this._setup()}var n=1;window.allconns={},window.urlcache={},e.prototype={onDisconnect:function(e){console.warn("port disconnected",e,e.sender.url),delete allconns[this.thisportid],this._cleanup()},onMessage:function(e,n){function t(t){n.postMessage({reqid:e.reqid,body:t})}function o(e){var n=function(e){function n(e){e.retainstr=o,STREAMST.push({time:(new Date).getTime(),size:e.size,name:e.name,retainstr:e.retainstr}),STREAMST.length>500&&(STREAMST=STREAMST.slice(1,STREAMST.length)),chrome.storage.local.set({STREAMST:STREAMST}),t(e)}if(e){var o=chrome.fileSystem.retainEntry(e);if("subtitle"!=s.type)collectAllFileInfo(o,e,n);else{var o=chrome.fileSystem.retainEntry(e);t({retainstr:o})}}else t(e)};if("subtitle"==s.type)var o={type:"openFile",accepts:[{extensions:["srt","vtt"],mimeTypes:["text/vtt","application/x-subrip"]}]};else var o={type:"openFile",accepts:[{extensions:["mkv","mp4"],mimeTypes:["video/*"]}]};var r=e.contentWindow;r.selectFile?r.selectFile(o,n):r._after_load=[o,n]}function r(e){console.log("server status check result",e),t("timeout"==e.type?{error:"timeout"}:200==e.target.status?e.target.response:{error:"unknown",status:e.target.status})}if(console.log("portMsg",e.body),e.reqid){var s=e.body;if("status"==s.command)n.postMessage({reqid:e.reqid,body:get_status()});else if("selectFile"==s.command)getdummy(o);else if("getMediaInfo"==s.command)chrome.fileSystem.restoreEntry(s.retainstr,function(e){if(void 0===e){var n=chrome.runtime.lastError;console.log("getMediaInfo->restoreEntry lasterr:",n),t({error:"file not found",message:n.message})}else collectAllFileInfo(s.retainstr,e,t)});else if("getPreviousStreams"==s.command)t(STREAMST);else if("ensureFirewallOpen"==s.command)window.create_hidden&&create_hidden(),t("ok");else if("clearHistory"==s.command)STREAMST=[],chrome.storage.local.set({STREAMST:STREAMST}),t(STREAMST);else if("getSubtitles"==s.command)getSubtitles(s.retainstr,t);else if("getURL"==s.command){if(console.log("get url",s.url),!s.nocache){var i=urlcache[s.url];if(i)return console.log("using cached url",s.url),void t(i)}getURL(s.url,function(e){if(200==e.target.code){var n=e.target.response,o=new Blob([n]),r=new FileReader,i=function(n){var o=n.target.result,r={data:o,headers:e.target.responseHeadersParsed};s.nocache||(urlcache[s.url]=r),t(r)};r.onload=r.onerror=i,r.readAsBinaryString(o)}else t({error:e.target.code})})}else if("checkForUpdate"==s.command)DEVMODE?t({error:"devmode"}):(console.log("requesting app update check"),chrome.runtime.requestUpdateCheck(function(e,n){var o={status:e,details:n};console.log("requested app update info",o),t(o)}));else if("checkServerStatus"==s.command){var a=new XMLHttpRequest;a.open("GET",s.URL),a.responseType="json",a.timeout=1e3,a.onload=a.onerror=a.ontimeout=r;try{a.send()}catch(e){t({error:e})}}else if("refreshNetworkInterfaces"==s.command)window.webapp&&webapp.refreshNetworkInterfaces(t);else if("prepareStream"==s.command){var c=s.retainstr;createReallyHiddenWindow(),prepareStream(c,t)}else if("reload"==s.command)n.postMessage({reqid:e.reqid,body:"restarting..."}),setTimeout(chrome.runtime.reload,500);else{if("stopWebServer"==s.command)return window.webapp?(webapp.stop(),n.postMessage({reqid:e.reqid,body:{success:!0}})):n.postMessage({reqid:e.reqid,body:{error:"did not have webapp"}});"startWebServer"==s.command?startWebApp(t):n.postMessage({reqid:e.reqid,body:"unknown command"})}}else console.warn("unhandled message from port",n)},_setup:function(){this._boundOnDisconnect=this.onDisconnect.bind(this),this._boundOnMessage=this.onMessage.bind(this),this.port.onDisconnect.addListener(this._boundOnDisconnect),this.port.onMessage.addListener(this._boundOnMessage)},_cleanup:function(){this.port.onDisconnect.removeListener(this._boundOnDisconnect),this.port.onMessage.removeListener(this._boundOnMessage),this.port=null}},window.WebsiteConnection=e}(),console.log("BACKGROUND.JS");var THINGS=!1,STREAMST=[],opts={},retaincache={},reload=chrome.runtime.reload,getOMDBInfo_queue=[],getOMDBInfo_queue_running=!1,getOMDBInfo_cache={};_.extend(StreamHandler.prototype,{before_get:function(){var e=this.request.arguments.retainstr;"string"==typeof e?chrome.fileSystem.restoreEntry(this.request.arguments.retainstr,function(e){this.fs=e,this.get()}.bind(this)):(this.write("need to supply retainstr query parameter"),this.finish())}},WSC.DirectoryEntryHandler.prototype),_.extend(StatusHandler.prototype,{get:function(){this.setHeader("content-type","application/json"),this.write(JSON.stringify({status:"ok"})),this.finish()}},WSC.BaseHandler.prototype),chrome.runtime.onInstalled.addListener(function(e,n){var t=e.reason;console.log("onInstalled",e,t,n),"install"==t&&chrome.storage.sync.get("everInstalled",function(e){console.log("everInstalled",e),e.everInstalled||chrome.storage.sync.set({everInstalled:!0})})}),chrome.runtime.onUpdateAvailable.addListener(function(e){console.log("update available",e),window.mp4cast&&window.webapp&&hasKey(window.webapp.streams)?console.log("dont update now. looks like we're busy"):(console.log("going to reload app now."),chrome.runtime.reload())}),chrome.runtime.onMessageExternal.addListener(function(e,n,t){console.log("onMessageExternal",e,n),t("ok")}),chrome.runtime.onConnectExternal.addListener(onconnectexternal),chrome.app.runtime.onLaunched.addListener(launch);