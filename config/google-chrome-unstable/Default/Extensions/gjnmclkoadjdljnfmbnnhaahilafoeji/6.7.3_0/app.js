// Version: 6.7.3
// Date: Nov 22, 2020
//
// TeX for Gmail written by Valery Alexeev <va.email.tex@gmail.com> (C)2010-... 
// License: http://creativecommons.org/licenses/by-nc-sa/3.0/
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
      
var va_cae,va_ce,va_cf,va_ccf,va_vae,va_vm,va_vf,va_vcf,va_vg,va_am,va_tn,va_csf,va_vsf,va_mv,va_tv,va_ve;var va_d;var va_rt;InboxSDK.load(2,"sdk_texforgmail_a2d0abfc3d").then(function(sdk){sdk.Compose.registerComposeViewHandler(function(composeView){va_rt=function(){var i=this;var r,o;if(i.style.display=="block"){i.style.display="inline";r="$$";o=va_tn?"$":"$$"}else{r="$";o=va_tn?"":"$"}var ae=document.activeElement;var modal=sdk.Widgets.showModalView({el:"<div style='font-size:13px'>Replace "+i.outerHTML+" with <p><font color='blue'>"+i.alt+"</font></p></div>",title:"TeX for Gmail asks",buttons:[{text:"Yes",title:"",onClick:function(){var t=document.createTextNode(r+i.alt+o);var p=i.parentNode;p.replaceChild(t,i);if(p.className=="va_le"){p.outerHTML=p.innerHTML}while(t.previousSibling&&(t.previousSibling.nodeType==3)){t.nodeValue=t.previousSibling.nodeValue+t.nodeValue;t.parentNode.removeChild(t.previousSibling)}while(t.nextSibling&&(t.nextSibling.nodeType==3)){t.nodeValue=t.nodeValue+t.nextSibling.nodeValue;t.parentNode.removeChild(t.nextSibling)}modal.close()},type:"PRIMARY_ACTION",orderHint:0},{text:"No",title:"",onClick:function(){modal.close()},orderHint:1}]})};composeView.on("destroy",function(event){va_sa()});va_sa();va_tn=false;va_cae=composeView.getBodyElement();va_alt(va_cae);va_cae.addEventListener("keydown",va_lt,false);va_cae.addEventListener("keyup",va_lt_2,false);var ctrlDown=false;function va_lt(e){var k=e.keyCode;var isShift=!!e.shiftKey;if(k==119){va_d=undefined;if(isShift){va_cfn2()}else{va_cfn0()}}if(k==120){va_d=undefined;if(isShift){va_cfn3()}else{va_cfn1()}}if(k==121){va_d=undefined;if(isShift){va_cfn5()}}if(k==17||k==91){ctrlDown=true}if(k==86||k==90){setTimeout(function(){va_alt(va_cae)},3000)}}function va_lt_2(e){var k=e.keyCode;if(k==17||k==91){ctrlDown=false}}var info;function va_cfnCommon(now){va_cae=composeView.getBodyElement();va_si(info,sdk.ButterBar);va_sa();va_tn=now;if(va_d!==undefined){va_d.close()}va_cae.focus()}function va_cfn0(){info="TeX once, Rich math";va_cfnCommon(false);va_cu(0)}function va_cfn1(){info="TeX once, Simple math";va_cfnCommon(false);va_cu(1)}function va_cfn2(){info="TeX nonstop, Rich math";va_cfnCommon(true);va_cu(2)}function va_cfn3(){info="TeX nonstop, Simple math";va_cfnCommon(true);va_cu(3)}function va_cfn4(){info="Stopping TeX";va_cfnCommon(false)}function va_cfn5(){info="Guess naive TeX";va_cfnCommon(false);va_cu(5)}if(typeof composeView.addButton=="function"&&!va_scb){composeView.addButton({title:"TeX this message",hasDropdown:true,iconUrl:chrome.extension.getURL("logo128.png"),onClick:function(event){var va_cpo='<!DOCTYPE HTML><html>  <head>    <link  type="text/css" href="popups.css"/>  </head>  <body style="overflow:hidden;">    <div id="wrapper">      <div class="menu-items">        <div class="menu-entry" id="va_cme0">	  once, Rich math (F8)       </div>        <div class="menu-entry" id="va_cme1">	  once, Simple math (F9)       </div>	<div class="separator"></div>	        <div class="menu-entry"  id="va_cme2">	  nonstop, Rich math (&#8679;F8)       </div>        <div class="menu-entry"  id="va_cme3">	  nonstop, Simple math (&#8679;F9) </div>';if(va_sft==0){va_cpo+='<div class="separator"></div>	<div class="menu-entry"  id="va_cme5">Guess naive TeX (&#8679;F10)      </div>'}va_cpo+="</div> <!-- menu-items-->    </div> <!-- wrapper -->  </body></html>";var va_csp='<!DOCTYPE HTML><html>  <head>    <link  type="text/css" href="popups.css"/>  </head>  <body style="overflow:hidden;">    <div id="wrapper">      <div class="menu-items">        <div class="menu-entry" id="va_csm">	  Stop TeX        </div>      </div> <!-- menu-items-->    </div> <!-- wrapper -->  </body></html>';if(va_tn){event.dropdown.el.innerHTML=va_csp;va_d=event.dropdown;document.getElementById("va_csm").addEventListener("click",va_cfn4,false)}else{event.dropdown.el.innerHTML=va_cpo;va_d=event.dropdown;document.getElementById("va_cme0").addEventListener("click",va_cfn0);document.getElementById("va_cme1").addEventListener("click",va_cfn1);document.getElementById("va_cme2").addEventListener("click",va_cfn2);document.getElementById("va_cme3").addEventListener("click",va_cfn3);if(va_sft==0){document.getElementById("va_cme5").addEventListener("click",va_cfn5)}}}})}});function va_cu(mode){chrome.runtime.sendMessage({va_o:"update?"},function(response){var update=response.answer=="no"?false:true;va_got(update,function(){va_tcv(mode)})})}var messages,info;function va_vfn0(){info="Simple math + guess naive TeX";va_si(info,sdk.ButterBar);va_th(messages,0);if(va_ve&&va_ve.dropdown){va_ve.dropdown.close()}}function va_vfn1(){info="Simple math";va_si(info,sdk.ButterBar);va_th(messages,1);if(va_ve&&va_ve.dropdown){va_ve.dropdown.close()}}function va_vfn2(){info="Rich math";va_si(info,sdk.ButterBar);va_th(messages,2);if(va_ve&&va_ve.dropdown){va_ve.dropdown.close()}}function va_gm(){try{messages=va_tv.getMessageViews()}catch(err){messages=[va_mv]}if(messages.length==0){messages=[va_mv]}}sdk.Conversations.registerMessageViewHandler(function(messageView){va_mv=messageView;va_gm();try{if(!va_svm){messageView.addToolbarButton({section:"MORE",title:"Simple math + guess naive TeX",iconUrl:chrome.extension.getURL("logo128.png"),onClick:function(){va_vfn0()}});messageView.addToolbarButton({section:"MORE",title:"Simple math",onClick:function(){va_vfn1()}});messageView.addToolbarButton({section:"MORE",title:"Rich math",onClick:function(){va_vfn2()}})}}catch(err){}});try{sdk.Conversations.registerThreadViewHandler(function(threadView){va_tv=threadView})}catch(err){}if(!va_svb){sdk.Toolbars.registerThreadButton({positions:["THREAD"],title:"View mail with",hasDropdown:true,iconUrl:chrome.extension.getURL("logo128.png"),onClick:function(event){va_gm();var va_vpo='<!DOCTYPE HTML><html>  <head>    <link  type="text/css" href="popups.css"/>     </head>  <body style="overflow:hidden;">    <div id="wrapper">      <div class="menu-items">        <div class="menu-entry" id="va_vme0">	  Simple math + guess naive TeX        </div>        <div class="menu-entry" id="va_vme1">	  Simple math        </div>        <div class="menu-entry"  id="va_vme2">	  Rich math        </div>      </div> <!-- menu-items-->    </div> <!-- wrapper -->  </body></html>';event.dropdown.el.innerHTML=va_vpo;va_ve=event;document.getElementById("va_vme0").addEventListener("click",va_vfn0);document.getElementById("va_vme1").addEventListener("click",va_vfn1);document.getElementById("va_vme2").addEventListener("click",va_vfn2)}})}});function va_si(info,bar){bar.showMessage({text:info,time:3000})}function va_th(messages,mode){chrome.runtime.sendMessage({va_o:"update?"},function(response){var update=response.answer=="no"?false:true;va_got(update,function(){for(var k=0;k<messages.length;k++){var message=messages[k];va_vae=message.getBodyElement();va_tmv(mode)}})})}function va_rha(request,sender,sendResponse){var action=request.action;if(action==="context-rich"){va_tcv()}if(action==="context-simple"){chrome.runtime.sendMessage({va_o:"update?"},function(response){if(response.answer=="no"){va_tae(va_tc,1,va_csf)}else{va_got(true,function(){if(va_tc){va_tc.normalize();va_tae(va_tc,1,va_csf)}},null)}})}if(action==="context-guess"){va_go(va_tc)}}chrome.extension.onMessage.addListener(va_rha);