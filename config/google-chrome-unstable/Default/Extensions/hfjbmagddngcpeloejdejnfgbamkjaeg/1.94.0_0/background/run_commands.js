"use strict";__filename="background/run_commands.js",define(["require","exports","./store","./utils","./browser","./ports","./i18n","./key_mappings"],function(n,u,t,e,r,l,i,o){var f,c,a,s,v,m,d,p,$,_,h,g,y,b,T,j,k,w,M,N,O,C,q,x;Object.defineProperty(u,"__esModule",{value:true}),u.waitAndRunKeyReq=u.runNextOnTabLoaded=u.runNextCmdBy=u.getRunNextCmdBy=u.runNextCmd=u.wrapFallbackOptions=u.parseFallbackOptions=u.hasFallbackOptions=u.executeExternalCmd=u.executeShortcut=u.portSendFgCmd=u.sendFgCmd=u.onConfirmResponse=u.nu=u.uu=u.executeCommand=u.fillOptionWithMask=u.overrideOption=u.overrideCmdOptions=u.copyCmdOptions=u.replaceCmdOptions=void 0,e=__importStar(e),f=Math.abs,c=0,v=1,u.replaceCmdOptions=function(n){t.set_cOptions(e.qt(n))},u.copyCmdOptions=function(n,u){for(var t in u)("$"!==t[0]||"$then=$else=$retry=$f=".includes(t+"=")&&!t.includes("="))&&(t in n||(n[t]=u[t]));return n},u.overrideCmdOptions=function(n,u,r){var l=r||t.get_cOptions();e.Ot(e.qt(n),l),u?delete n.$o:n.$o=l,r||t.set_cOptions(n)},m=function(n,e,r){(r=r||t.get_cOptions())[n]=e;var l=r.$o;null!=l&&u.overrideOption(n,e,l)},u.overrideOption=m,d=function(n,e,r,l){var i,o,f,c=-1,a=e;if(true!==a&&""!==a||(a=n.includes("$s")?"$s":"%s"),a&&"string"==typeof a&&n.includes(a)){if(o=r&&t.get_cOptions()[r])i=r;else{if(1!==(f=Object.keys(t.get_cOptions()).filter(function(n){return"$"!==n[0]&&!l.includes(n)})).length&&""!==e)return{ok:0,result:f.length};o=1===f.length?i=f[0]:""}n=n.replace(a,function(){return""+o}),c=1}return a&&(u.overrideCmdOptions({}),t.get_cOptions().$masked=true,i&&delete t.get_cOptions()[i]),{ok:c,result:n}},u.fillOptionWithMask=d,p=function(n){var u,l,i=a;return a=null,i&&(s?(l=(u=e.s()).Nt,i(n,u.Tt),l.then(C)):i(n,t.B)),t.set_cEnv(null),n?void 0:r.ae()},$=function(n){u.executeCommand(n,1,t.cKey,t.cPort,t.cRepeat)},_=function(n,i,c,v,m,d){var _,h,g,b,T,j,k,w,N,O,q,x;if(y(0),a)return a=null,void t.set_cEnv(null);if(h=o.Xt(n),g=n.da,h&&(_=h.$count)&&(i=i*_||1),1===(i=m||(i>=1e4?9999:i<=-1e4?-9999:0|i||1)));else if(1===g)i=1;else if(g>0&&(i>g||i<-g)){if(null!=d)i=i<0?-1:1;else if(!(m||h&&true===h.confirmed))return t.set_cKey(c),t.set_cOptions(null),t.set_cPort(v),t.set_cRepeat(i),t.set_cEnv(null),void u.nu(n.ca,f(i)).then($.bind(null,n))}else i=i||1;if(null!=d){if(b=0|d.r,b=Math.max(1,b>=0&&b<100?Math.min(b||6,20):f(b)),d.c&&d.c.i>=b&&(!h||"showTip"!==h.$else))return t.set_cPort(v),l.showHUD("Has run sequential commands for "+b+" times"),void t.set_cEnv(null);T=M(d.c,1,d.u),h&&(36===n.ma||u.hasFallbackOptions(h)||T.t&&n.pa)&&(j={},h?u.overrideCmdOptions(j,false,h):e.qt(j),j.$retry=-b,j.$f=T,T.t&&n.pa&&!h.$else&&(j.$else="showTip"),h=j)}if(!n.pa)return w=4620>>(k=n.ma)&1||4===k&&!!h&&false===h.keepHover,t.set_cPort(v),t.set_cEnv(null),void(null==v||u.portSendFgCmd(v,k,w,h,i));O=t.ln[N=n.ma],null===(s=n.ba)&&(s=n.ba=null!=h&&u.hasFallbackOptions(h)),t.set_cKey(c),t.set_cOptions(h||(n.ra=e.Lt())),t.set_cPort(v),t.set_cRepeat(i),i=t.rn[N],null==v&&N<11&&N>0||(i<1?(s?(x=(q=e.s()).Nt,O(q.Tt),x.then(C)):O(t.B),t.set_cEnv(null)):(s=n.ba,a=O,(i<2||2===i&&f(t.cRepeat)<2?r.getCurTab:r.fe)(p)))},u.executeCommand=_,u.uu=function(){return v&&true!==t.get_cOptions().confirmed},h=function(n,r){var l,o,f,s,m,d,p,$;return t.cPort?t.Nn&&t.Nn[1]?(o=i._r("cmdConfirm",[r,t.Nn[1][n]||"### "+n+" ###"]),s=(f=e.s()).Nt,m=f.Tt,d=t.cRepeat,p=t.get_cOptions(),$=t.cPort,y(setTimeout(g,3e3,0)),a=function(n){t.set_cKey(0),t.set_cOptions(p),t.set_cPort($),t.set_cRepeat(n?d>0?1:-1:d),v=0,m(n),setTimeout(function(){v=1},0)},((null===(l=t.Pn.get(t.cPort.s.ur))||void 0===l?void 0:l.ar)||t.cPort).postMessage({N:13,c:"",i:c,m:o}),s):i.getI18nJson("help_dialog").then(function(e){return t.Nn?t.Nn[1]=e:t.Z([null,e,null]),u.nu(n,r)}):(a=null,t.set_cRepeat(t.cRepeat>0?1:-1),Promise.resolve(t.cRepeat>0))},u.nu=h,g=function(n){var u=a;a=null,n>1&&u&&u(n<3)},y=function(n){c&&clearTimeout(c),c=n},b=function(n,t){var e=n.c,r=n.i;r>=-1&&c!==r||(y(0),n.r?g(n.r):u.executeCommand(o.aa.get(e),n.n,0,t,0))},u.onConfirmResponse=b,T=function(n,e,r){u.portSendFgCmd(t.cPort,n,e,r,1)},u.sendFgCmd=T,u.portSendFgCmd=function(n,u,t,e,r){n.postMessage({N:10,H:t?l.ensureInnerCSS(n.s):null,c:u,n:r,a:e})},j=function(n,t){var i,f,a,s,v,m;if(y(0),t)return i=t.cr,y(setTimeout(u.executeShortcut,100,n,null)),i.postMessage({N:13,c:n,i:c,m:""}),void l.ensuredExitAllGrab(t);if(s=0,v=f=o.aa.get(n),"goBack"===(a=f.ca)||"goForward"===a?r.ve.goBack&&(s=21):"autoOpen"===a&&(s=12),m=o.Xt(f),s)v={ma:s,pa:1,ca:a,sa:null,ra:m,ba:null,da:f.da};else{if(!f.pa)return;s=f.ma}s>10||s<1?u.executeCommand(v,1,0,null,0):m&&m.$noWarn||((m||(f.ra=e.Lt())).$noWarn=true,console.log("Error: Command",a,"must run on pages which have run Vimium C"))},u.executeShortcut=j,k=function(n,r){var i,f,c,a,s,v,m,d=n.command;(i=(d=d?d+"":"")?o.Qt[d]:null)&&((c=r.tab?l.indexFrame(r.tab.id,r.frameId||0)||((f=t.Pn.get(r.tab.id))?f.cr:null):null)||i[1])&&(s=n.key,v=o.Yt(d,a=n.options||null),m=n.count,v&&(m="-"!==m?parseInt(m,10)||1:-1,a&&"object"==typeof a?e.qt(a):a=null,u.executeCommand(v,m,s|=0,c,0)))},u.executeExternalCmd=k,u.hasFallbackOptions=function(n){return!!(n.$then||n.$else)},u.parseFallbackOptions=function(n){var u=n.$then,t=n.$else;return u||t?{$then:u,$else:t,$retry:n.$retry,$f:n.$f}:null},w=function(n){var e=u.parseFallbackOptions(t.get_cOptions());return e&&Object.assign(n,e),n},u.wrapFallbackOptions=w,M=function(n,u,t){return{i:(n?n.i:0)+u,t:t&&2!==t?t:n?n.t:0}},N=function(n){return u.runNextCmdBy(n,t.get_cOptions())},u.runNextCmd=N,O=function(n){return u.hasFallbackOptions(t.get_cOptions())?function(e){var l=2&n?void 0===e:r.ae(),i=t.get_cOptions();return l?u.runNextCmdBy(0,i):u.runNextOnTabLoaded(i,1&n?e:null),2&n?void 0:l}:2&n?t.B:r.ae},u.getRunNextCmdBy=O,C=function(n){"object"==typeof n?u.runNextOnTabLoaded(t.get_cOptions(),n):"boolean"==typeof n?u.runNextCmdBy(n?1:0,t.get_cOptions(),null):n<0||u.runNextCmdBy(n?1:0,t.get_cOptions(),n>1?n:null)},u.runNextCmdBy=function(n,u,e){var r,i=n?u.$then:u.$else,o=!!i&&"string"==typeof i;return o&&(r={c:u.$f,r:u.$retry,u:0,w:0},y(setTimeout(function(){var n=t.Pn.get(t.Cn),u=t.cPort&&t.cPort.s.ur===t.Cn&&n&&n.oo.indexOf(t.cPort)>0?t.cPort:n?2===n.cr.s.Wn&&n.oo.filter(function(n){return 2!==n.s.Wn}).sort(function(n,u){return n.s.or-u.s.or})[0]||n.cr:null;n&&l.ensuredExitAllGrab(n),t.cn(i,u,r)},e||50))),o},q=function(n,e,l){var i,o,f,s,v=n.$then;(v&&"string"==typeof v||l)&&(i=function(e){var i=Date.now(),m=i<s-500||i-s>=o;if(!e||!c)return f=-1,r.ae();if(m||"complete"===e.status){if(l&&!m&&!t.Pn.has(e.id))return;y(0),a=null,l&&l(),v&&u.runNextCmdBy(1,n,l?67:0)}},o=false!==e?1500:500,f=e?e.id:false!==e?-1:t.Cn,s=Date.now(),y(setInterval(function(){r.tabsGet(-1!==f?f:t.Cn,i)},100)))},u.runNextOnTabLoaded=q,x=function(n,e){var r=n.f,l={$then:n.k,$else:null,$retry:r.r,$f:M(r.c,0,r.u)};t.set_cPort(e),false===r.u?u.runNextOnTabLoaded(l,null):u.runNextCmdBy(1,l,r.w)},u.waitAndRunKeyReq=x});