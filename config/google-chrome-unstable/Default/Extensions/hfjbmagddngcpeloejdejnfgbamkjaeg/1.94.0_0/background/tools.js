"use strict";__filename="background/tools.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./parse_urls","./settings","./ports","./ui_css","./i18n","./run_commands","./open_urls","./tab_commands"],function(n,t,e,r,o,i,u,a,c,l,f,s,_,v){Object.defineProperty(t,"__esModule",{value:true}),t.mr=t.pr=t.gr=t.hr=t.wr=void 0,r=__importStar(r),a=__importStar(a),t.wr={yr:function(n,t){return"vimiumContent|"+n+(t?"|"+t:"")},Sr:function(n,t){var i=o.me.contentSettings;try{i&&i.images.get({primaryUrl:"https://127.0.0.1/"},o.ae)}catch(n){i=null}return i?i[n]&&!/^[A-Z]/.test(n)&&i[n].get?!(!t.startsWith("read:")&&r.Dt.test(t)&&!t.startsWith(e.u.ut))&&(c.complainLimits(f._r("changeItsCS")),true):(c.showHUD(f._r("unknownCS",[n])),true):(c.showHUD("Has not permitted to set contentSettings"),true)},kr:function(n,t){var o,u,a,l,s,_,v,d,m,p;if(n.startsWith("file:"))return(o=e.Un>=56?1:t>1?2:0)?(c.complainLimits(1===o?f._r("setFileCS",[56]):f._r("setFolderCS")),[]):[n.split(/[?#]/,1)[0]];if(n.startsWith("ftp"))return c.complainLimits(f._r("setFTPCS")),[];if(u=n.match(/^([^:]+:\/\/)([^\/]+)/),a=i.Ie.exec(u[2]),l=[(n=u[1])+(s=a[3]+(a[4]||""))+"/*"],t<2||r.zt(a[3],0))return l;for(a=null,v=(_=r.Rt(s))[0],d=_[1],m=Math.min(v.length-d,t-1),p=0;p<m;p++)s=s.slice(v[p].length+1),l.push(n+s+"/*");return l.push(n+"*."+s+"/*"),m===v.length-d&&"http://"===n&&l.push("https://*."+s+"/*"),l},Cr:function(n){var t,e,r;for(e of n.oo){if(r=new URL(e.s.Ae).host,t&&t!==r)return true;t=r}return false},Mr:function(n,e){var r=o.me.contentSettings[n];null==e?(r.clear({scope:"regular"}),r.clear({scope:"incognito_session_only"},o.ae),localStorage.removeItem(t.wr.yr(n))):r.clear({scope:e?"incognito_session_only":"regular"})},Ir:function(n,r){var o=n.type?""+n.type:"images";return!t.wr.Sr(o,"http://a.cc/")&&(t.wr.Mr(o,r?r.s.sr:2===e.wn),c.showHUD(f._r("csCleared",["images"===o&&f._r(o)||o[0].toUpperCase()+o.slice(1)])),true)},Tr:function(n,e,r,o){var i=n.type?""+n.type:"images",u=r[0];n.incognito?t.wr.Nr(e,i,u,o):t.wr.Or(i,e,u,"reopen"===n.action,o)},Or:function(n,r,u,a,c){var l=i.ge(u.url);t.wr.Sr(n,l)?c(0):o.me.contentSettings[n].get({primaryUrl:l,incognito:u.incognito},function(i){t.wr.Ar(n,l,r,{scope:u.incognito?"incognito_session_only":"regular",setting:i&&"allow"===i.setting?"block":"allow"},function(r){var i,l,f;r?c(0):(u.incognito||(i=t.wr.yr(n),"1"!==localStorage.getItem(i)&&localStorage.setItem(i,"1")),f=!o.se()||e.Un>=70&&(l=e.Pn.get(u.id))&&l.oo.length>1&&t.wr.Cr(l),u.incognito||a?v.Lr(u):u.index>0?v.Lr(u,f?0:2):o.getCurWnd(true,function(n){return n&&"normal"===n.type?v.Lr(u,f?0:n.tabs.length>1?2:1):o.ve.reload(s.getRunNextCmdBy(0)),o.ae()}))})})},Nr:function(n,r,u,a){if(e.u.rt)return c.complainLimits("setIncogCS"),void a(0);var l=i.ge(u.url);t.wr.Sr(r,l)?a(0):o.me.contentSettings[r].get({primaryUrl:l,incognito:true},function(e){return o.ae()?(o.me.contentSettings[r].get({primaryUrl:l},function(e){e&&"allow"===e.setting?a(1):o.de.create({type:"normal",incognito:true,focused:false,url:"about:blank"},function(e){var i=e.tabs[0].id;return t.wr.Ur(n,r,u,l,e.id,true,function(){o.ve.remove(i)})})}),o.ae()):e&&"allow"===e.setting&&u.incognito?t.wr.Rr(u):void o.de.getAll(function(o){var i,a,c;if((o=o.filter(function(n){return n.incognito&&"normal"===n.type})).length)return i=_.preferLastWnd(o),e&&"allow"===e.setting?t.wr.Rr(u,i.id):(a=u.windowId,c=u.incognito&&o.some(function(n){return n.id===a}),t.wr.Ur(n,r,u,l,c?void 0:i.id));console.log("%cContentSettings.ensure","color:red","get incognito content settings",e," but can not find an incognito window.")})})},Ur:function(n,e,r,i,u,a,c){var l=t.wr.Wr.bind(null,r,u,c);return t.wr.Ar(e,i,n,{scope:"incognito_session_only",setting:"allow"},a&&u!==r.windowId?function(n){if(n)return l(n);o.de.get(r.windowId,l)}:l)},Ar:function(n,e,i,u,a){var c,l=false,f=o.me.contentSettings[n],s=function(){var n=o.ae();return n&&console.log("[%o]",Date.now(),n),l||(--v,((l=!!n)||0===v)&&setTimeout(a,0,l)),n},_=t.wr.kr(e,0|i),v=_.length;if(v<=0)return a(true);for(c of(r.qt(u),_))f.set(Object.assign({primaryPattern:c},u),s)},Wr:function(n,e,r,i){true!==i&&t.wr.Rr(n,e),r&&r(),true!==i?e&&o.de.update(e,{focused:true,state:i?i.state:void 0}):s.runNextCmd(0)},Rr:function(n,t){n.active=true,"number"==typeof t&&n.windowId!==t&&(n.index=void 0,n.windowId=t),v.Lr(n)}},t.hr={qr:localStorage,Ve:function(n,r,o){var i,u,a,c=n.l,l=n.n,f=n.u,s=n.s;c&&0===s[0]&&0===s[1]&&(2===s.length?(i=f.indexOf("#"))>0&&i<f.length-1&&s.push(f.slice(i)):(s[2]||"").length<2&&s.pop()),u=t.hr.Fr(l,c?f:""),a=JSON.stringify(c?s:{tabId:o,url:f,scroll:s}),r?(e.gn||(d.Jr(),e.$(new Map))).set(u,a):t.hr.qr.setItem(u,a)},Pr:function(n,r){var o,i=r.s.ur;n.s?t.hr.Ve(n,r.s.sr,i):(r=(null===(o=e.Pn.get(i))||void 0===o?void 0:o.ar)||r)&&r.postMessage({N:11,n:n.n})},Dr:function(n,i){var u,a,l,v,d,m,p,g=n.n,h=t.hr.Fr(g,n.u),b=i.s.sr&&(null==e.gn?void 0:e.gn.get(h))||t.hr.qr.getItem(h),w=n.c;n.l&&((u=b?JSON.parse(b):null)||(l=void 0,v=void 0,(a=n.o)&&(l=+a.x)>=0&&(v=+a.y)>=0&&(u=[l,v,a.h])),u)?i.postMessage({N:15,l:2,n:g,s:u,f:w}):b?(m=+(d=JSON.parse(b)).tabId,(p={u:d.url,s:d.scroll,t:d.tabId,n:g,p:true,q:_.parseOpenPageUrlOptions(w),f:s.parseFallbackOptions(w)}).p=false!==w.prefix&&0===p.s[1]&&0===p.s[0]&&!!r.v(p.u),m>=0&&e.Pn.has(m)?o.tabsGet(m,t.hr.Gr.bind(0,p)):e.fn[20](p)):c.showHUD(f._r("noMark",[f._r(n.l?"Local_":"Global_"),g]))},Gr:function(n,r){var i=o.getTabUrl(r).split("#",1)[0];if(i===n.u||n.p&&n.u.startsWith(i))return e.fn[5]({s:r.id}),t.hr.Kr(n,r);e.fn[20](n)},Fr:function(n,t){return t?"vimiumMark|"+u.ke(t.split("#",1)[0])+(t.length>1?"|"+n:""):"vimiumGlobalMark|"+n},Kr:function(n,r){var o,i=r.id,u=null===(o=e.Pn.get(i))||void 0===o?void 0:o.ar;if(u&&u.postMessage({N:15,l:0,n:n.n,s:n.s,f:n.f}),n.t!==i&&n.n)return t.hr.Ve(n,2===e.wn,i)},xr:function(n){var r,o,i,u,a,l=t.hr.Fr("",n),s=[],_=t.hr.qr;for(r=0,o=_.length;r<o;r++)(i=_.key(r)).startsWith(l)&&s.push(i);for(i of s)_.removeItem(i);return u=s.length,(a=e.gn)&&a.forEach(function(n,t){t.startsWith(l)&&(u++,a.delete(t))}),c.showHUD(f._r("markRemoved",[u,f._r(n?"#"===n?"allLocal":"41":"39"),f._r(1!==u?"have":"has")]))}},t.gr={la:"findModeRawQueryList",zr:null,Hr:0,Qr:function(){var n=a.Xe(t.gr.la);t.gr.zr=n?n.split("\n"):[],t.gr.Qr=null},Zr:function(n,o,i){var u,c,l=t.gr;if(l.Qr&&l.Qr(),u=n?e.bn||(d.Jr(),e.nn(l.zr.slice(0))):l.zr,!o)return u[u.length-(i||1)]||"";o=o.replace(/\n/g," "),n?l.Br(o,u,true):(o=r.Et(o,0,99),(c=l.Br(o,u))&&a.Ve(l.la,c),e.bn&&l.Br(o,e.bn,true))},Br:function(n,t,e){var r=t.lastIndexOf(n);if(r>=0){if(r===t.length-1)return;t.splice(r,1)}else t.length>=50&&t.shift();if(t.push(n),!e)return t.join("\n")},Er:function(n){n?e.bn&&e.nn([]):(t.gr.Qr=null,t.gr.zr=[],a.Ve(t.gr.la,""))}};var d={Vr:false,Hr:0,Jr:function(){d.Vr||(o.de.onRemoved.addListener(d.Xr),d.Vr=true)},Xr:function(){d.Vr&&(d.Hr=d.Hr||setTimeout(d.Yr,34))},Yr:function(){var n;if(d.Hr=0,e.Un>51)for(n of e.Pn.values())if(n.cr.s.sr)return;o.de.getAll(function(n){n.some(function(n){return n.incognito})||d.no()})},no:function(){e.nn(null),e.$(null),o.de.onRemoved.removeListener(d.Xr),d.Vr=false}};t.pr={to:[e.Un>=74?2:0,e.Un>=76?2:0],ro:0,Xe:function(n){var e=t.pr.to[n];return"object"==typeof e?e.matches:null},io:function(n,e){var r,o=t.pr,i=o.to,u=i[n],a=n?"prefers-color-scheme":"prefers-reduced-motion";1===u&&e&&(i[n]=u=matchMedia("("+a+")").matches?2:0),e&&2===u?((r=matchMedia("("+a+": "+(n?"dark":"reduce")+")")).onchange=o.uo,i[n]=r,o.ro=o.ro||setInterval(t.pr.co,6e4),o.lo(n,0)):e||"object"!=typeof u||(u.onchange=null,i[n]=2,o.ro>0&&i.every(function(n){return"object"!=typeof n})&&(clearInterval(o.ro),o.ro=0),o.lo(n,0))},lo:function(n,r){var o,i,u,c,f=t.pr.to[n];o=n?"dark":"less-motion",c=a.Ke(u=n?"d":"m",i=!!("object"==typeof f)&&f.matches),e.yn[u]!==c&&(e.yn[u]=c,r||a.Qe({N:6,d:[u]})),l.ii({t:o,e:i||(" "+e.An.vomnibarOptions.styles+" ").includes(" "+o+" "),b:!r})},co:function(){var n,e;for(e=(n=t.pr.to).length;0<=--e;)"object"==typeof n[e]&&t.pr.lo(e)},uo:function(){t.pr.ro>0&&clearInterval(t.pr.ro),t.pr.ro=-1;var n=t.pr.to.indexOf(this);n>=0&&t.pr.lo(n)}},t.mr={fo:null,so:e.B},setTimeout(function(){function n(n){var t,i,u;n.windowId===e.vn?((t=performance.now())-f>666&&(i=c.get(e.Cn),u=1===e.yn.o?Date.now():t,i?(i.i=++l,i.t=u):c.set(e.Cn,{i:++l,t:u}),l>2037&&o.ve.query({},s)),e.en(n.tabId),f=t):o.de.get(n.windowId,r)}function r(n){if(n.focused){var t=n.id;t!==e.vn&&(e.un(e.vn),e.in(t)),o.ve.query({windowId:t,active:true},function(n){n&&n.length>0&&t===e.vn&&i(n)})}}function i(r){if(!r||0===r.length)return o.ae();var i=r[0],u=i.windowId,a=e.vn;u!==a&&(e.in(u),e.un(a)),e.on(i.incognito?2:1),t.mr.so(),n({tabId:i.id,windowId:u})}var u,a=e.vn,c=e.jn,l=1,f=0,s=function(n){var t=n?n.map(function(n){return[n.id,c.get(n.id)]}).filter(function(n){return n[1]}).sort(function(n,t){return n[1].i-t[1].i}):[];t.length>1023&&t.splice(0,t.length-1023),t.forEach(function(n,t){return n[1].i=t+2}),(l=t.length>0?t[t.length-1][1].i:1)>1?e.tn(c=new Map(t)):(c.forEach(function(n,t){n.i<1026?c.delete(t):n.i-=1024}),l=1024)};for(u of(o.ve.onActivated.addListener(n),o.de.onFocusChanged.addListener(function(n){n!==a&&o.ve.query({windowId:n,active:true},i)}),o.getCurTab(function(n){f=performance.now();var t=n&&n[0];if(!t)return o.ae();e.en(t.id),e.in(t.windowId),e.on(t.incognito?2:1)}),t.mr.fo=function(n,t){return c.get(t.id).i-c.get(n.id).i},["images","plugins","javascript","cookies"]))null!=localStorage.getItem(t.wr.yr(u))&&o.me.contentSettings&&setTimeout(t.wr.Mr,100,u)},120),a.Je.autoDarkMode=a.Je.autoReduceMotion=function(n,e){t.pr.io(e.length>12?0:1,n)},a.Je.vomnibarOptions=function(n){var r,o,i,u,c,l,f=a.Ne.vomnibarOptions,s=e.qn,_=true,v=f.actions,d=f.maxMatches,m=f.queryInterval,p=f.styles,g=f.sizes;n!==f&&n&&"object"==typeof n&&(r=Math.max(3,Math.min(0|n.maxMatches||d,25)),o=((n.actions||"")+"").trim(),i=+n.queryInterval,u=((n.sizes||"")+"").trim(),c=((n.styles||"")+"").trim(),l=Math.max(0,Math.min(i>=0?i:m,1200)),(_=d===r&&m===l&&u===g&&v===o&&p===c)||(d=r,m=l,g=u,p=c),n.actions=o,n.maxMatches=r,n.queryInterval=l,n.sizes=u,n.styles=c),e.An.vomnibarOptions=_?f:n,s.n=d,s.t=m,s.l=g,s.s=p,t.pr.lo(0,1),t.pr.lo(1,1),a.Ye({N:47,d:{n:d,t:m,l:g,s:s.s}})}});