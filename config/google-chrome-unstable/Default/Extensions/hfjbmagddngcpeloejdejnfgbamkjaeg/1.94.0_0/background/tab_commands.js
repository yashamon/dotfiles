"use strict";__filename="background/tab_commands.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./parse_urls","./ports","./i18n","./run_commands","./clipboard","./open_urls","./frame_commands","./filter_tabs","./tools"],function(n,e,r,u,i,t,o,f,l,a,c,d,s,v,w){var m,p,b,I,_,g,x,T,h;Object.defineProperty(e,"__esModule",{value:true}),e.Lr=e.toggleTabUrl=e.togglePinTab=e.toggleMuteTab=e.removeTab=e.reloadTab=e.moveTabToNextWindow=e.moveTabToNewWindow=e.joinTabs=e.copyWindowInfo=void 0,u=__importStar(u),m=Math.abs,p=function(){r.cPort&&s.focusFrame(r.cPort,false,0)},e.copyWindowInfo=function(n){var e,t=r.get_cOptions().filter,o=!!(r.get_cOptions().decoded||r.get_cOptions().decode),a=r.get_cOptions().type,d="tab"===a&&(m(r.cRepeat)>1||!!t),s=c.eu(r.get_cOptions());if("frame"===a&&r.cPort)return e=void 0,128&r.cPort.s.fr?(r.cPort.postMessage({N:3,H:16,d:o,e:s}),e=1):e=f.nr({H:16,u:"",d:o,e:s}),void(1!==e&&(e&&e instanceof Promise?e.then(function(){n(1)}):n(1)));i.ve.query("browser"===a?{windowType:"normal"}:{active:"window"!==a&&!d||void 0,currentWindow:true},function(e){var c,w,m,p,b,I,_,g,x,T,h,y;if(!a||"title"===a||"frame"===a||"url"===a)return r.fn[16]({u:"title"===a?e[0].title:i.getTabUrl(e[0]),d:o,e:s},r.cPort),void n(1);c=r.cPort?r.cPort.s.sr:2===r.wn,w=r.get_cOptions().format,m=""+(w||"${title}: ${url}"),p=r.get_cOptions().join,b="json"===p&&!w,d?(I=e.length<2?0:i.selectFrom(e).index,_=v.getTabRange(I,e.length),e=e.slice(_[0],_[1])):e=e.filter(function(n){return n.incognito===c}),t&&(g=r.cPort?r.cPort.s.ur:r.Cn,x=e.find(function(n){return n.id===g}),e=v.hu(x,e,t,T={}),t=T.known?t:null),e.length?("browser"===a&&e.sort(function(n,e){return n.windowId-e.windowId||n.index-e.index}),h=e.map(function(n){return b?{title:n.title,url:o?u.yt(i.getTabUrl(n)):i.getTabUrl(n)}:m.replace(/\$\{([^}]+)\}/g,function(e,r){var t;return o&&"url"===r?u.yt(i.getTabUrl(n)):"__proto__"!==r&&((t=n[r])&&"object"==typeof t?JSON.stringify(t):t||"")})}),y=r.I(h,p,s),f.showHUD("tab"===a&&e.length<2?y:l._r("copiedWndInfo"),15),n(1)):n(0)})},e.joinTabs=function(n){var e,u=null!=r.get_cOptions().order?r.get_cOptions().order:r.get_cOptions().sort,t=r.get_cOptions().windows,o="current"===t;e=function(e){var f,l,a,c,d;f=2===r.wn,e=o?e:e.filter(function(n){return n.incognito===f}),l=o?e:e.filter(function(n){return n.id===r.vn}),a=l.length?l[0]:null,o||a?(c=function(t){var f,l,a,c,d,s,w,p,b,I=[],_=function(n){I.push(n)};if(e.sort(function(n,e){return n.id-e.id}).forEach(function(n){n.tabs.forEach(_)}),f=r.get_cOptions().filter,o&&m(r.cRepeat)>1&&I.length>1&&(l=i.selectFrom(I).index,a=v.getTabRange(l,I.length),I=I.slice(a[0],a[1])),f&&(c=r.cPort?r.cPort.s.ur:r.Cn,d=I.find(function(n){return n.id===c}),I=v.hu(d,I,f,s={}),f=s.known?f:null),I.length){for(b of(u&&(I=v.vu(I,u)),w=t?t.tabs.length:0,p=t?t.id:r.vn,f&&(w=I.reduce(function(n,e){return e.windowId===p?Math.min(e.index,n):n},I.length)),I))i.ve.move(b.id,{windowId:p,index:w++});for(b of I)b.pinned&&i.tabsUpdate(b.id,{pinned:true});n(1)}else n(0)},a&&"popup"===a.type&&a.tabs.length?(d=a.tabs[0].id,a.tabs=a.tabs.filter(function(n){return n.id!==d}),i.makeWindow({tabId:d,incognito:a.incognito},a.state,c)):(e=o||!a||"all"===t?e:e.filter(function(n){return n.id!==a.id}),c(a))):n(0)},o?i.getCurWnd(true,function(n){return n?e([n]):i.ae()}):(r.set_cRepeat(1),i.de.getAll({populate:true,windowTypes:["normal","popup"]},e))},b=function(n){var u="hasIncog",t=function(e){var u,o,c,d,s,w,b=e.tabs,I=b.length,_=!!r.get_cOptions().all,g=false!==r.get_cOptions().focused,x=i.selectFrom(b),T=x.incognito;if(!_&&I<=1&&(!I||0===x.index&&m(r.cRepeat)>1))n(0);else{if(_){for(o of b)if(null!=i.getGroupId(o))return f.showHUD("Can not keep groups info during this command"),void n(0);u=[0,I]}else u=1===I?[0,1]:v.getTabRange(x.index,I);if(c=r.get_cOptions().filter,d=b.slice(u[0],u[1]),(d=c?v.hu(x,d,c):d).length){if(!_){if((s=d.length)>=I&&I>1)return n(0),void f.showHUD(l._r("moveAllTabs"));if(s>30&&a.uu())return void a.nu("moveTabToNewWindow",s).then(t.bind(null,e));if(1===I&&0===x.index&&1===m(r.cRepeat))return void i.te(i.ve.query,{windowId:e.id,index:1}).then(function(r){if(!r||!r.length)return n(0),void f.showHUD(l._r("moveAllTabs"));e.tabs=[e.tabs[0],r[0]],t(e)})}w=!c||d.includes(x)?x:d[0],i.makeWindow({tabId:w.id,incognito:T,focused:g},"normal"===e.type?e.state:"",d.length<2?p:function(u){var t,o,f,l,a,c,s,v;if(u){for(v of(p(),t=d.indexOf(w),o=d.slice(0,t),f=d.slice(t+1),e.incognito&&r.Un<52&&(o=o.filter(l=function(n){return n.incognito===T}),f=f.filter(l)),c=f.length,s=function(n){return n.id},(a=o.length)&&(i.ve.move(o.map(s),{index:0,windowId:u.id},i.ae),a>1&&i.ve.move(d[t].id,{index:a})),c&&i.ve.move(f.map(s),{index:a+1,windowId:u.id},i.ae),d))v.pinned&&i.tabsUpdate(v.id,{pinned:true});n(1)}else n(0)})}else n(0)}},o=function(t){var o,c,s,v=i.selectFrom(t.tabs);if(t.incognito&&v.incognito)return n(0),f.showHUD(l._r(u));if(o=v.id,c={incognito:true},s=i.getTabUrl(v),v.incognito);else{if(t.incognito)return i.re(s)?(n(0),f.showHUD(l._r(u))):e.Lr(v);if(i.re(s))return n(0),f.complainLimits(l._r("openIncog"));c.url=s}t.tabs=null,i.de.getAll(function(e){var u,f,l=false!==r.get_cOptions().focused;(e=e.filter(function(n){return n.incognito&&"normal"===n.type})).length?i.ve.query({windowId:d.preferLastWnd(e).id,active:true},function(n){var e=n[0];i.tabsCreate({url:s,windowId:e.windowId,active:false!==r.get_cOptions().active,index:d.newTabIndex(e,r.get_cOptions().position,false,false)},a.getRunNextCmdBy(3)),l&&i.selectWnd(e),i.ve.remove(o)}):(u="normal"===t.type?t.state:"",(f=null!=c.url)?r.u.rt&&(l=true,u=""):c.tabId=o,c.focused=l,i.makeWindow(c,u,function(e){f||e&&p(),f&&e?a.getRunNextCmdBy(0)(e.tabs&&e.tabs[0]||null):n(!!e)}),f&&i.ve.remove(o))})},c=!!r.get_cOptions().incognito;c&&(r.cPort?r.cPort.s.sr:2===r.wn)?(f.showHUD(l._r(u)),n(0)):(1===m(r.cRepeat)||c?i.te(i.getCurWnd,false).then(function(n){return n&&i.te(i.ve.query,{windowId:n.id,active:true}).then(function(e){return n.tabs=e,e&&e.length?n:void 0})}):i.te(i.getCurWnd,true)).then(function(e){e?(c?o:t)(e):n(0)})},e.moveTabToNewWindow=b,I=function(n,u){var t=n[0];i.de.getAll(function(n){var o,f,l,a,c,s,w,b=false===r.get_cOptions().minimized||false===r.get_cOptions().min,I=false!==r.get_cOptions().focused,_=n.filter(function(n){return n.incognito===t.incognito&&"normal"===n.type&&(!b||"minimized"!==n.state)});if(_.length>0){if(o=_.map(function(n){return n.id}),f=o.indexOf(t.windowId),o.length>=2||f<0)return l=r.get_cOptions().filter,a=!!(r.get_cOptions().tabs||l),c=o.indexOf(r.Mn),s=r.get_cOptions().last&&c>=0?c:f>=0?f+1:0,void i.ve.query({windowId:o[w=((w=(w=((w=a?s:r.cRepeat>0?s+r.cRepeat-1:s+r.cRepeat)%o.length+o.length)%o.length)!==f?w:w+(r.cRepeat>0?1:-1))%o.length+o.length)%o.length],active:true},function(n){var e=n[0],o=r.get_cOptions().end?null:null!=r.get_cOptions().position?d.newTabIndex(e,r.get_cOptions().position,false,false):e.index+(false!==r.get_cOptions().right?1:0),c=null==o||o>e.index,s=null,w=function(){-1!==b?(i.ve.move(t.id,{index:null!=o?o:-1,windowId:e.windowId},function(n){var e,t;if(i.ae())return u(0),i.ae();if(s)for(e=s.findIndex(function(e){return e.id===n.id}),t=0;t<s.length;t++)t!==e&&i.ve.move(s[t].id,{index:n.index+t,windowId:n.windowId},i.ae);r.cPort&&r.cPort.s.ur===n.id&&p()}),I&&i.selectWnd(e),false!==r.get_cOptions().active&&i.selectTab(t.id,i.ue(u)),b>0&&i.selectTab(b)):i.ve.query({windowId:t.windowId,index:t.index+(c?-1:1)},function(n){return b=n&&n[0]&&n[0].id||-9,w(),i.ae()})},b=c&&!t.index?-9:-1;a&&(f>=0||r.Un>=52)&&1!==m(r.cRepeat)?v.ku(true,0,function(n,e){if(t=n[e[1]],n=n.slice(e[0],e[2]),r.Un<52&&(n=n.filter(function(n){return n.incognito===t.incognito})),l){if(!(n=v.hu(t,n,l)).length)return void u(0);t=n.includes(t)?t:n[0]}s=n,b=-9,w()},[],u):f>=0||r.Un>=52?w():(b=-9,i.makeTempWindow_r(t.id,t.incognito,w))})}else _=n.filter(function(n){return n.id===t.windowId});m(r.cRepeat)>1?e.moveTabToNewWindow(u):i.makeWindow({tabId:t.id,incognito:t.incognito,focused:I},1===_.length&&"normal"===_[0].type?_[0].state:"",function(n){n&&p(),u(!!n)})})},e.moveTabToNextWindow=I,_=function(n,u,t,o){var f,l,c,d=u[0],s=u[1],w=u[2],p={bypassCache:true===(r.get_cOptions().hard||r.get_cOptions().bypassCache)},b=i.ve.reload,I=n;if(m(r.cRepeat)<2||r.get_cOptions().single)b(n[o?s:d].id,p,a.getRunNextCmdBy(0));else{if(f=n[s],l=r.get_cOptions().filter,n=n.slice(d,w),l){if(!(n=v.hu(f,n,l)).length)return void t(0);f=n.includes(f)?f:n[0]}if(n.length>20&&a.uu())a.nu("reloadTab",n.length).then(e.reloadTab.bind(null,I,[d,s,w],t));else for(c of(b(f.id,p,a.getRunNextCmdBy(0)),n))c!==f&&b(c.id,p)}},e.reloadTab=_,g=function(n,u,t){var o,f,l,c,d,s,p,b,I,_,g,h,y,k,j,O,A=r.get_cOptions().highlighted,M=r.get_cOptions().goto||(r.get_cOptions().left?"left":""),N=(M+"").split(/[\/,;\s]/),R=N.length>1?N[m(r.cRepeat)>1?1:0]:M+"",S="near"===R||"reverse"===R||R.startsWith("back"),W=R.startsWith("forw"),$=S?r.cRepeat>0:W?r.cRepeat<0:"left"===R,z=S?r.cRepeat<0:W?r.cRepeat>0:"right"===R,C=R.includes("previous"),H=C&&R.includes("only");if(u){if(!t||!t.length)return n(0),i.ae();if(f=t.length,l=i.selectFrom(t),d=1,s=c=l.index,p=c+1,m(r.cRepeat)>1&&f>1){if(b=0,t[0].pinned!==l.pinned&&!(r.cRepeat<0&&t[c-1].pinned))for(;t[b].pinned;)b++;if((d=(I=v.getTabRange(c,f-b,f))[1]-I[0])>20&&a.uu()&&u<3)return void a.nu("removeTab",d).then(e.removeTab.bind(null,n,2,t));d>1&&(s=b+I[0],p=b+I[1])}else if(A){if(g="no-current"===A,(d=(_=t.filter(function(n){return n.highlighted&&n!==l})).length+1)>1&&(g||d<f)&&i.ve.remove(_.map(function(n){return n.id}),i.ae),g)return void n(d>1)}else if(r.get_cOptions().filter&&0==v.hu(l,[l],r.get_cOptions().filter).length)return void n(0);if(!s&&d>=f&&true!==(null!=r.get_cOptions().mayClose?r.get_cOptions().mayClose:r.get_cOptions().allow_close))u<2?i.getCurTabs(e.removeTab.bind(null,n,3)):i.de.getAll(x.bind(null,n,l,t));else if(u<2&&(H?(y=v.gu())>=0&&(h=i.te(i.tabsGet,y)):(z||$&&s>0)&&(h=i.te(i.ve.query,{windowId:l.windowId,index:$?s-1:s+1}).then(function(n){return n&&n[0]})),h))h.then(function(r){r&&r.windowId===l.windowId&&i.le(r)?(i.selectTab(r.id),i.ve.remove(l.id,i.ue(n))):i.getCurTabs(e.removeTab.bind(null,n,3))});else{if(k=f,d>=f);else if(C)k=(j=!H&&p<f&&!r.jn.has(t[p].id)?t[p]:t.filter(function(n,e){return(e<s||e>=p)&&r.jn.has(n.id)}).sort(w.mr.fo)[0])?j.index:f;else if($||z){for(O=k=$?s>0?s-1:p:p<f?p:s-1;O>=0&&O<f&&(O<s||O>=p)&&!i.le(t[O]);)O+=O<s?-1:1;k=O>=0&&O<f?O:k}k>=0&&k<f&&i.selectTab(t[k].id),T(l,t,s,p,n)}}else((o=m(r.cRepeat)>1||A||C&&!H)?i.getCurTabs:i.getCurTab)(e.removeTab.bind(null,n,o?2:1))},e.removeTab=g,x=function(n,e,u,t){var o,f,l=false;t=t.filter(function(n){return"normal"===n.type}),"always"===r.get_cOptions().keepWindow?l=!t.length||t.some(function(n){return n.id===e.windowId}):t.length<=1?(l=true,(f=t[0])&&(f.id!==e.windowId?l=false:f.incognito&&!i.re(r.An.newTabUrl_f)&&(o=f.id))):e.incognito||1===(t=t.filter(function(n){return!n.incognito})).length&&t[0].id===e.windowId&&(o=t[0].id,l=true),l&&i.tabsCreate({index:u.length,url:"",windowId:o},a.getRunNextCmdBy(3)),T(e,u,0,u.length,l?null:n)},T=function(n,e,u,t,o){var f,l,a;i.ve.remove(n.id,o?i.ue(o):i.ae),l=e.slice(n.index+1,t),a=e.slice(u,n.index),r.cRepeat<0&&(l=(f=[a,l])[0],a=f[1]),l.length>0&&i.ve.remove(l.map(function(n){return n.id}),i.ae),a.length>0&&i.ve.remove(a.map(function(n){return n.id}),i.ae)},e.toggleMuteTab=function(n){var e,u,t,o;e=r.get_cOptions().filter,r.get_cOptions().all||e||r.get_cOptions().other||r.get_cOptions().others?(t=function(t){var o,a,c,d=r.get_cOptions().other||r.get_cOptions().others?r.cPort?r.cPort.s.ur:r.Cn:-1,s=0===t.length||-1!==d&&1===t.length&&t[0].id===d;if(null!=r.get_cOptions().mute)s=!!r.get_cOptions().mute;else for(o of t)if(o.id!==d&&!i.isTabMuted(o)){s=true;break}if(!e||(t=v.hu(u,t,e)).length){for(o of(a={muted:s},t))o.id!==d&&s!==i.isTabMuted(o)&&i.tabsUpdate(o.id,a);f.showHUD(l._r(s?"mute":"unmute",[l._r(c=-1===d?"All":"Other")||c])),n(1)}else n(0)},(o=v.getNecessaryCurTabInfo(e))?o.then(function(n){u=n,i.ve.query({audible:true},t)}):i.ve.query({audible:true},t)):i.getCurTab(function(e){var u=e[0],t=!i.isTabMuted(u),o=null!=r.get_cOptions().mute?!!r.get_cOptions().mute:t;o===t&&i.tabsUpdate(u.id,{muted:o}),f.showHUD(l._r(o?"muted":"unmuted")),n(1)})},h=function(n,u,t,o){var f,l,c,d,s,w,p,b=u[1],I=n[b],_=!I.pinned,g={pinned:_},x=_?0:1,T=0;if(o&&(u=[b,b,b+1]),m(r.cRepeat)>1&&_)for(;n[T].pinned;)T++;for(l=T+(f=v.getTabRange(b-T,n.length-T,n.length))[x]-x,c=T+f[1-x]-x,d=[];l!==c;l+=_?1:-1)(_||n[l].pinned)&&d.push(n[l]);if((c=(d=(s=r.get_cOptions().filter)?v.hu(I,d,s):d).length)>30&&a.uu())a.nu("togglePinTab",c).then(e.togglePinTab.bind(null,n,u,t));else if(c)for(p of(w=d.includes(I)?I.id:d[0].id,d))i.tabsUpdate(p.id,g,p.id===w?i.ue(t):i.ae);else t(0)},e.togglePinTab=h,e.toggleTabUrl=function(n,e){var c,s=i.getTabUrl(n[0]),v=r.get_cOptions().reader,w=r.get_cOptions().keyword;if(s.startsWith(r.u.ut))return f.complainLimits(l._r(v?"noReader":"openExtSrc")),void e(0);v&&w?(c=o.He({u:s}))&&c.k===w?(a.overrideCmdOptions({keyword:""}),d.openUrlWithActions(c.u,0,n)):(s=t.Ee(c&&r.get_cOptions().parsed?c.u:s,w),d.openUrlWithActions(s,9,n)):v?r.zn&&u.Dt.test(s)?(s=s.startsWith("read:")?u.jt(s.slice(s.indexOf("?url=")+5)):"read://"+new URL(s).origin.replace(/:\/\/|:/g,"_")+"/?url="+u.k(s),d.openUrlWithActions(s,9,n)):(f.complainLimits(l._r("noReader")),e(0)):(s=s.startsWith("view-source:")?s.slice(12):"view-source:"+s,d.openUrlWithActions(s,9,n))},e.Lr=function(n,e,u,t){var o,f,l,c,d,s,v=n.id,w=1===e;if(e&&i.se()&&(false!==t||null==i.getGroupId(n)))return o=0,f=-1,l=function(){var n=i.ae();if(n)return i.se().restore(null,a.getRunNextCmdBy(0)),f>=0&&i.ve.remove(f),f=0,n;(o+=1)>=5||setTimeout(function(){i.tabsGet(v,l)},50*o*o)},w&&i.tabsCreate({url:"about:blank",active:false,windowId:n.windowId},function(n){f?f=n.id:i.ve.remove(n.id)}),void i.ve.remove(v,function(){return i.tabsGet(v,l),i.ae()});d=i.isTabMuted(n),c=function(n){d!==i.isTabMuted(n)&&i.tabsUpdate(n.id,{muted:d})},s={windowId:n.windowId,index:n.index,url:i.getTabUrl(n),active:n.active,pinned:n.pinned,openerTabId:n.openerTabId},u&&(s=Object.assign(u,s)),null!=s.index&&s.index++,i.openMultiTabs(s,1,true,[null],t,n,function(n){n&&c&&c(n),n?a.runNextOnTabLoaded(r.get_cOptions(),n):a.runNextCmd(0)}),i.ve.remove(v)}});