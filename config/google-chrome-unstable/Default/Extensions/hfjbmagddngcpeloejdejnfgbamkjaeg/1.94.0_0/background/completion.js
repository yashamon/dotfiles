"use strict";__filename="background/completion.js",define(["require","exports","./store","./browser","./utils","./normalize_urls","./parse_urls","./completion_utils","./browsing_data_manager"],function(n,r,e,t,u,f,i,o,l){var a,s,c,_,m,v,d,h,p,w,b,g,S,y,x,k,M,T,R,$,z,F,j,A,B,D,E,I;Object.defineProperty(r,"__esModule",{value:true}),u=__importStar(u),a=0,s=false,c=false,_=0,m=0,v=0,d=0,h=0,p=[""],w="",b="",g="",S="",y=0,x=false,k=false,M="",T="",R=0,$=true,z=function(n,r,e,t,u,f){this.e=n,this.u=r,this.t=e,this.title=t,this.r=u(this,f),this.visit=0},F={pu:function(n,r){if(0!==p.length&&1&R)2===e.dn.Wn?F.wu():l.ci.Ti=function(){n.o||F.wu()};else if(E.Su([],1),r)return;0===e.dn.Wn&&l.ci.xi()},wu:function(){var n,r,t,u,f,i,a,s,c,v,w=p.some(function(n){return 47===n.charCodeAt(0)}),b=null===(n=o.wi.yu)||void 0===n?void 0:n.Kn,g=o.wi.xu?[]:null,S=b&&b[0]===w?b[1]:e.dn.Kn,y=S.length,x=[];for(t=0;t<y;t++)if(o.Mu((u=S[t]).t,w?u.Li:u.Ri)&&($||u.ji)){if(null!==g&&g.push(u),T&&u.u.length<T.length+2&&T===(u.u.endsWith("/")?u.u.slice(0,-1):u.u))continue;x.push([-o.Tu(u.t,u.Ri),t])}for(a of(g&&(o.wi.xu.Kn=[w,g]),d+=r=x.length,r?(x.sort(o.sortBy0),h>0&&!(6&R)?(x=x.slice(h,h+m),h=0):r>h+m&&(x.length=h+m)):R^=1,f=[],i=64&_?-.666446:0,x))s=a[0],i&&(s=s<i?s:(s+i)/2),c=new z("bookm",(u=S[t=a[1]]).u,u.t,w?u.Li:u.Ri,o.get2ndArg,-s),v=32&_&&l.li.Mi?l.li.Si(u.u):-1,c.visit=v<0?0:e.hn.Zn[v].Ci,f.push(c),null!==u.Ii&&(c.u=u.Ii,c.title=o.cutTitle(w?u.Li:u.Ri),c.textSplit="javascript: \u2026",c.t=u.Pi);E.Su(f,1)}},j={pu:function(n,r){var t,u,f,i,a;if(!p.length&&1024&_||!(2&R))return E.Su([],2);if(t=p.length>0,e.hn.Zn){if(t)return void E.Su(j.wu(),2);(e.hn.tt>10||e.hn.ot>0)&&l.li.Gi()}else if(u=t?function(){n.o||E.Su(j.wu(),2)}:null,t&&(c||l.li.Ai)?(l.li.Ai>0&&clearTimeout(l.li.Ai),l.li.Ai=0,l.li.Vi(u)):(l.li.Ai||(l.li.Ai=setTimeout(function(){l.li.Ai=0,l.li.Vi(u)},t?200:150)),t&&E.Ru((a=(i=(f=E.$u).length)>0)&&"search"===f[0].t?[f[0]]:[],s&&a,0,0,i,b,y)),t)return;0===r?o.zu(k,_,j.Fu,n):l.ai(h+m,$,j.ju.bind(null,n))},wu:function(){var n,r,t,u,i,a,s=1===p.length?p[0]:"",c=!!s&&("."===s[0]?/^\.[\da-zA-Z]+$/.test(s):(f.Ee(s,null,-2),f._e<=2)),_=c?"."===s[0]||f._e>0?o.Bu.Au[0]:(o.Bu.Du||o.Bu.Eu(),o.Bu.Du[0]):null,v=o.wi.xu?[]:null,w=[-1.1,-1.1],b=[],g=o.Mu,S=c&&s.includes("%")&&!/[^\x21-\x7e]|%[^A-F\da-f]/.test(s),y=m+h,x=-1.1,k=0,T=0,F=0;for(M&&y++,T=y;--T;)w.push(-1.1,-1.1);for(y=2*y-2,t=(r=(null===(n=o.wi.yu)||void 0===n?void 0:n.Zn)||e.hn.Zn).length;k<t;k++)if(u=r[k],(c?_.test(S?u.u:u.t):g(u.t,u.Ri))&&($||u.ji)&&(null!==v&&v.push(u),F++,(i=c?o.ComputeRecency(u.Ci)||1e-16*Math.max(0,u.Ci):o.ComputeRelevancy(u.t,u.Ri,u.Ci))>x)){for(T=y-2;0<=T&&w[T]<i;T-=2)w[T+2]=w[T],w[T+3]=w[T+1];w[T+2]=i,w[T+3]=k,x=w[y]}for(v&&(o.wi.xu.Zn=v),d+=F,F||(R^=2),5&R?k=0:(k=2*h,h=0);k<=y&&!((i=w[k])<=0);k+=2)(u=r[w[k+1]]).u!==M&&((a=new z("history",u.u,S?u.u:u.t,u.Ri,o.get2ndArg,i)).visit=u.Ci,b.push(a));return l.oi.Oi(),b},Fu:function(n,r){var e,u,f,i;if(o.wi.Zi(r),!n.o){for(f of(e=new Set,u=0,r))f.incognito&&o.tabsInNormal||(i=t.getTabUrl(f),e.has(i)||(e.add(i),u++));return j.Iu([],n,e,h,u)}},ju:function(n,r){var e,t,u;if(!n.o)return e=[],t=new Set,u=-h,r.some(function(n){var r,f=n.u;return!t.has(r=f+"\n"+n.Ri)&&(t.add(r),t.add(f),++u>0&&e.push(n),e.length>=m)})?j.Ou(e):j.Iu(e,n,t,-u,0)},Iu:function(n,r,e,u,f){t.me.history.search({text:"",maxResults:h+m*($?1:2)+f},function(t){if(!r.o){t=t.filter(function(n){var r=n.url;return r.length>2e3&&(n.url=r=l.li.qi(r,n)),!e.has(r)&&($||0!==l.fi(n.url,n.title||""))}),u<0?t.length=Math.min(t.length,m-n.length):u>0&&(t=t.slice(u,u+m));var f=t.map(function(n){return{u:n.url,Ri:n.title||"",Ni:n.lastVisitTime,Qi:null}});u<0&&(f=n.concat(f)),j.Ou(f)}})},Ou:function(n){n.forEach(j.Qu),h=0,l.oi.Oi(),E.Su(n,2)},Qu:function(n,r,e){var t=n.u,u=new z("history",t,l.oi.Ei(t,t),n.Ri||"",o.get2ndArg,(99-r)/100),f=n.Qi;u.visit=n.Ni,f&&(u.s=f,u.label='<span class="undo">&#8630;</span>'),e[r]=u}},A={pu:function(n,r){if(1!==p.length||!(16&R)||p[0].lastIndexOf("/",p[0].length-2)>=0)return E.Su([],16);if(l.li.Hi){if(!e.hn.Zn)return r>0?E.Su([],16):l.li.Vi(function(){n.o||A.pu(n,0)});l.li.Hi(e.hn.Zn)}return A.wu()},wu:function(){var n,r,t,f,i,l,a,c,_,v,w,b=e.hn.$n,g=o.Uu,S=16===R&&s?[]:null,y=p[0].replace("/","").toLowerCase(),x=y===p[0],k=[],M="",T=-1.1;for(r of(o.qu(3),b.keys()))r.includes(y)&&(n=b.get(r),($||n.Ji>0)&&(t=o.ComputeRelevancy(r,"",n.Ci),S?S.push({r:t,d:r,m:n}):t>T&&(T=t,M=r)));if(f=M.length===y.length,M&&!f&&(M.startsWith("www.")||M.startsWith(y)||(i=M.slice(M.indexOf(".")+1)).includes(y)&&(l=void 0,(l=b.get(i="www."+i))?($||l.Ji>0)&&(M=i,n=l):(l=b.get(i="m."+i))&&($||l.Ji>0)&&($||l.Ji>0)&&(M=i,n=l)),(a=M.startsWith(y)?0:M.startsWith("www."+y)?4:-1)>=0&&(w=(_=(c=u.Rt(M))[0]).length-1,(v=c[1])>1&&(!(a=M.length-a-y.length-_[w].length-1)||3===v&&a===_[w-1].length+1)&&(f=true))),M)d++,s=!h&&f||s,k=A.Cu(M,n,0,x);else if(S)for(w of(S.sort(A.Gu),(d=S.length)>h+m&&(S.length=h+m),S))k.push(A.Cu(w.d,w.m,w.r,x)[0]);o.qu(g),E.Su(k,16)},Cu:function(n,r,t,f){var i,a,s,c,_,v,d,p,w=r.ye>0,b="";return 2===e.dn.Wn&&(i=new RegExp("^https?://"+u.t(n)+"/?$"),a=e.dn.Kn.filter(function(n){return i.test(n.u)&&($||n.ji)}),a.length>0&&(s=a.filter(function(n){return"s"===n.u[4]}),T=(c=(a=(w=s.length>0)?s:a)[0].u).endsWith("/")?c.slice(0,-1):c,b=a[0].Ri)),_=(w?"https://":"http://")+n+"/",!t&&(M=_,h>0)?(h--,[]):(v=new z("domain",_,f?n:n+"/","",o.get2ndArg,t||2),p=(d=l.li.Mi?l.li.Si(_):-1)>0?e.hn.Zn[d]:null,o.Hu(v),p&&($||p.ji)&&(v.visit=p.Ci,b=b||p.Ri),v.title=o.cutTitle(b,[]),--m,[v])},Gu:function(n,r){return r.r-n.r}},B={pu:function(n,r){!(4&R)||r&&(!p.length||256&_)?E.Su([],4):o.zu(k,_,B.wu,n)},wu:function(n,r){var f,i,a,s,w,b,g,S,y,x,M,T,$,F,j,A,D,I,O,Q,U,q,C,G,H,N,P,W,Z,J,K,L,V,X,Y,nn,rn;if(o.wi.Zi(r),!n.o){if(f=e.Cn,i=p.length<=0,a=3&R,w=[],(s=!!(8&_)&&k&&i&&!c)&&!(128&_)&&r.length>h&&r.length>v){for(g of(b=new Map,r))b.set(g.id,g);for(M=(x=(y=(S=b.get(f))?S.openerTabId:0)?b.get(y):null)?x.index:S?S.index-1:0,T=x?0:v/2|0;1<--T&&M>0&&r[M-1].openerTabId===y;M--);r=M>0?r.slice(M).concat(r.slice(0,M)):r}for(g of($=[],F=[],j=!i&&/^:[a-z]+/gm.test(p.join("\n")),r))!k&&o.tabsInNormal&&g.incognito||(A=t.getTabUrl(g),D=g.text||(g.text=l.oi.Ei(A,g.incognito?"":A)),I=g.title,j&&(1===p.length&&(D=I=""),g.audible&&(I+=" :audible :audio",I+=t.isTabMuted(g)?" :muted":" :unmuted"),g.discarded&&(I+=" :discarded"),g.incognito&&(I+=" :incognito"),g.pinned&&(I+=" :pinned")),(i||o.Mu(D,I))&&(O=g.windowId,!k&&F.lastIndexOf(O)<0&&F.push(O),$.push(g)));if(a&&1===$.length&&$[0].id===f&&($.length=0),d+=Q=$.length,Q||(R^=4),h>=Q&&!a)return h=0,E.Su(w,4);if(F.sort(B.Nu),U=i?s?B.Pu:B.Wu:o.ComputeWordRelevancy,q=s?u.Lt():null,C=F.length>1?e.vn:0,s)for(g of $)q[g.id]=(H=(G=g.openerTabId)&&q[G])?H<5?H+1:5:1;for(N=32&_?1===e.yn.o?0:e.Un<62?Date.now()-performance.now():performance.timeOrigin:0,P=0;P<$.length;)W=(g=$[P++]).id,Z=s?q[W]:1,A=t.getTabUrl(g),J=e.jn.get(W),K=new z("tab",A,g.text,g.title,U,s?P:W),L=C&&g.windowId!==C?F.indexOf(g.windowId)+1+":":"",V="",L+=P,f===W?(s||(K.r=i?1<<31:0),L="("+L+")"):J||(L="**"+L+"**"),!o.tabsInNormal&&g.incognito&&(V+="*"),!!g.discarded&&(V+="~"),g.audible&&(V+=t.isTabMuted(g)?"\u266a":"\u266c"),K.visit=J?J.t+N:0,K.s=W,K.label="#"+L+(V&&" "+V),Z>1&&(K.level=" level-"+Z),w.push(K);if(w.sort(E.Zu),Y=h+m-(X=w.length),a||Y<0||!i)for(h>0&&!a?(w=w.slice(h,h+m),X=m,h=0):X>h+m&&(w.length=X=h+m),T=a?0:X;T<X;T++)w[T].r*=8/(T/4+1);else if(h>0){for(rn of nn=w.slice(0,Y))rn.label+="[r]";for(X=(w=w.slice(h).concat(nn)).length,T=0;T<X;T++)w[T].r=X-T;h=0}l.oi.Oi(),E.Su(w,4)}},Nu:function(n,r){return n-r},Wu:function(n,r){var t=e.jn.get(r);return t?t.i:4&_?2047+r:-r},Pu:function(n,r){return 1/r}},D={Ju:0,pu:e.B,Ku:function(n,r){var t,u,i,l,s,c,_,m,v,d;if(!(8&R))return E.Su([],8);if(i=(u=p).length>0?u[0]:"",0===u.length);else{if(true!==r&&"\\"===i[0]&&"\\"!==i[1])return i.length>1?u[0]=i.slice(1):u.shift(),i=g.slice(1).trimLeft(),$=true,h?(h--,E.Su([],8)):(t=D.Lu(i),E.Su([t],8));l=e.An.searchEngineMap.get(i)}if(true===r){if(!l)return true}else{if(!l&&!i.startsWith("vimium://"))return 0===a&&u.length<=1&&(a=u.length?o.Xu.Vu()?-2:0:-1),E.Su([],8);l&&S&&(u.push(S),h=0,g+=" "+S,S="",y&=-5),u.length>1||(a=-1)}if(u.length>1&&l?(u.shift(),g.length>200&&(u=g.split(" ")).shift()):l&&(u=[]),$=true,l?(_=s=(m=f.we(u,l.Ae,l.B,[])).Ae,c=m.Ce):(_=s=u.join(" "),c=[]),"~"===i);else if(s.startsWith("vimium://")){if(v=e.S(s.slice(9),1,true),d=D.Yu.bind(D,u,s,_,l,c),v instanceof Promise)return v.then(D.nf.bind(D,n,d));if(v instanceof Array)return D.nf(n,d,v);v&&(s=_=v,c=[])}else s=f.Ee(s,null,-2);return t=D.Yu(u,s,_,l,c),E.Su([t],8)},nf:function(n,r,e){var t,f,o,l,s;if(!n.o){switch(e[1]){case 5:case 7:if(a=7===e[1]&&p.length>1?a:-1,!(f=e[0]))break;return S="",(p=((g="\\ "+f).length<201?g:u.Et(g,0,200).trim()).split(" ")).length>1&&(p[1]=i.Me(p[1],p.length>2)),D.Ku(n);case 2:if(p=(o=e[0]).length>1||1===o.length&&o[0]?o:p,(l=D.Ju++)>12)break;if(s=D.Ku(n,true),l<=0&&(D.Ju=0),true!==s)return s;break;case 0:e[0]&&(t=D.rf(r(),e))}E.Su(t||[r()],8)}},Yu:function(n,r,e,t,f){var i=new z("search",r,e,(t?t.De+": ":"")+n.join(" "),o.get2ndArg,9);return n.length>0&&t?(i.t=D.ef(e,f),i.title=o.cutTitle(i.title,[t.De.length+2,i.title.length]),i.textSplit=o.highlight(i.t,f)):(i.t=u.jt(o.shortenUrl(e)),i.title=o.cutTitle(i.title,[]),i.textSplit=u.It(i.t)),i.v=c?"":t&&t.B||o.tf(r),i.p=c&&t?t.De:"",i},rf:function(n,r){var e=r[0],t=new z("math","vimium://copy "+e,e,e,o.get2ndArg,9);return--t.r,t.title='<match style="text-decoration: none;">'+o.cutTitle(t.title,[])+"<match>",t.textSplit=u.It(r[2]),[n,t]},ef:function(n,r){var e,t,f,i=r.length;if(t=u.jt(r.length>0?n.slice(0,r[0]):n),(e=u.v(t))&&(t=t.slice(e),e=0),r.length<=0)return t;for(f=r[0];r[e]=t.length,i>++e;)t+=u.jt(n.slice(f,r[e])),f=r[e];return f<n.length&&(t+=u.jt(n.slice(f))),t},Lu:function(n){var r=f.Ee(n,null,-2),e=4===f._e,t=new z("search",r,u.jt(o.shortenUrl(r)),"",o.get2ndArg,9);return t.title=e?"~: "+o.cutTitle(n,[0,n.length]):o.cutTitle(n,[]),t.textSplit=u.It(t.t),t.v=c?"":o.tf(r),t.p=c&&e?"~":"",t.n=1,t}},E={uf:0,ff:0,$u:null,if:null,Ru:null,pu:function(n){var r,e,t,u;if(E.if&&(E.if.o=true),r=E.if={o:false},E.ff=0,e=1,t=-9&(R&=n[0])?n.length:2,E.$u=[],E.uf=t-1,a=h&&-1,n[1]===D){if(u=D.Ku(r),t<3)return;if(u)return void u.then(E.of.bind(null,n,r,e));e=2}E.of(n,r,e)},of:function(n,r,e){for(o.lf(Date.now()-18144e5),o.qu(3*p.length||.01),p.indexOf("__proto__")>=0&&(p=p.join(" ").replace(/(^| )__proto__(?=$| )/g," __proto_").trimLeft().split(" ")),o.wi.lo($),p.sort(E.af),o.Bu.sf();e<n.length;e++)n[e].pu(r,e-1)},af:function(n,r){return r.length-n.length||(n<r?-1:n===r?0:1)},Su:function(n,r){var e=E.$u,t=n.length;if(t>0&&(E.ff|=r,E.$u=0===e.length?n:e.concat(n),8===r&&(s=!0,m-=t,d+=t)),0==--E.uf)return e=null,E.cf()},cf:function(){var n,r,e,t,u,f,i,l,c,_,m,g,S=E.$u;return E.$u=null,S.sort(E.Zu),h>0?(S=S.slice(h,h+v),h=0):S.length>v&&(S.length=v),o.Bu._f=o.Bu.Du=null,p.length>0&&(r=o.shortenUrl(n=p[0]),((e=n.length!==r.length)||n.endsWith("/")&&n.length>1&&!n.endsWith("//"))&&(p[0]=e?r:n.slice(0,-1),o.Bu.mf(p[0]))),S.forEach(o.Hu),t=S.length>0,u=s&&t,f=d,i=":"===w,c=b,_=y,m=2!=(l=a<0?-2!==a||t||i?0:3:$?p.length<=0||x?0:t?2:i?0:1:0)||i?0:E.ff,g=E.Ru,E.vf(),g(S,u,l,m,f,c,_)},vf:function(){E.if=E.Ru=null,o.set_tabsInNormal(null),o.setupQueryTerms(p=[],c=false,0),w=b=g=S=M=T="",o.Bu.Au=null,o.qu(3),o.lf(0),a=E.ff=_=m=v=d=0,R=0,y=0,s=false,x=k=false,$=true},df:function(){var n,r,e=g;if(h=0,S="",!(0===e.length||(n=(e=e.slice(-5)).lastIndexOf("+"))<0||0!==n&&32!==e.charCodeAt(n-1))){if(e=e.slice(n),n=g.length-e.length,(r=parseInt(e,10))>=0&&"+"+r===e&&r<=(n>0?100:200))h=r;else if("+"!==e)return;g=g.slice(0,n&&n-1),S=e,y|=4}},Zu:function(n,r){return r.r-n.r}},I={__proto__:null,bookm:[1,F],domain:[16,A],history:[2,j],omni:[63,D,A,j,F,B],search:[8,D],tab:[4,B]};e.x.pu=function(n,r,t){var f,l,a,h,S,M,T;(n=n.trim())&&2===e.yn.o&&(/^[a-z]:\\|^\\\\[\w$.-]+(\\|$)|^\\\\$/i.test(n)?n=(":"===n[1]?"":"//")+n.slice(":"===n[1]?0:2).replace(/\\+/g,"/").toLowerCase():"file:"===n.slice(0,5).toLowerCase()&&(n=n.toLowerCase())),w=g=n&&n.replace(u.Mt," "),b="",y=0,E.df(),p=(n=g)?(n=n.length<201?n:u.Et(n,0,200).trimRight()).split(" "):[],(f=0|r.c||128)&&(f-=n.replace(/[\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u9fbf\uf900-\ufaff\ufe30-\ufe4f\uff00-\uffef]/g,"aa").length-n.length),f=Math.max(50,Math.min(f,320)),c=!!(1&(_=r.f)),v=m=Math.min(Math.max(3,0|r.r||10),25),d=0,E.Ru=t,l="bomni"===r.o?(_|=64,I.omni):I[r.o],h=r.t||63,S=r.e||63,l===I.tab&&(k=!!(2&_)),2===(a=p.length>=1?p[0]:"").length&&":"===a[0]&&(M="b"===(a=a[1])?I.bookm:"h"===a?I.history:"t"===a||"T"===a||"w"===a||"W"===a?(k="t"!==a&&"T"!==a,_|=0,_|="T"===a?2048:0,I.tab):"B"===a?(_|=64,I.omni):"H"===a?(_|=256,I.omni):"d"===a?I.domain:"s"===a?I.search:"o"===a?I.omni:null)&&(l=M,b=p.shift(),y|=1,g=g.slice(3),S=l[0]),p.length>0&&((a=p[0]).includes("\u3002")||a.includes("\uff1a"))&&((T=i.Me(a,x=p.length<2))!==a?(p[0]=T,g=T+g.slice(a.length),x=x&&!/^[.\u3002]\w+([.\u3002]\w*)?$/.test(a)):x=x&&a.includes("\uff1a")&&!/\uff1a([^\/\d]|\d[^\0-\xff])/.test(a)),$=true,R=h&S,s=2===l.length,g&&(y|=2),o.setupQueryTerms(p,c,f),E.pu(l)}});