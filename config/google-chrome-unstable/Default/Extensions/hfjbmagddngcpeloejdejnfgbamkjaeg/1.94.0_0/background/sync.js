"use strict";__filename="background/sync.js",define(["require","exports","./store","./utils","./browser","./settings"],function(n,t,e,r,o,i){function u(){return new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,-5).replace("T"," ")}var l,f,c,a,s,d,S,g,y,v,p,m,b,O,N,w,J,_,j,T,h,k,x,D,q,P,Q,z;Object.defineProperty(t,"__esModule",{value:true}),r=__importStar(r),i=__importStar(i),l=r.qt({findModeRawQueryList:1,innerCSS:1,keyboard:1,newTabUrl_f:1,vomnibarPage_f:1}),f=o.me.storage,a=null,s="",d=null,S=null,g=null,v=0,p=function(){return c||(c=f&&f.sync)},m=function(n){b(n,"sync")},b=function(n,t){var o,i,u,l;if("sync"===t)if(o=function(n){var t,e,o,i;if(d){for(t in r.qt(n),d)!(o=(e=t.split(":")[0])===t)&&e in d||N(e,null!=(i=o?d[t]:null)?i.newValue:n[e],n);d=null}},r.qt(n),i=e.N&&e.N(),d?Object.assign(d,n):d=n,i)i.then(function(){return b({},t)});else for(u in n=d,d=null,n){if(l=n[u],8===(u.includes(":")?8:N(u,null!=l?l.newValue:null)))return d=n,void p().get(o);delete n[u]}},O=function(){console.log.apply(console,["["+u()+"]"].concat([].slice.call(arguments)))},N=function(n,t,e){var r,o,u,l,f,c;if(n in i.Ne&&!(n in i.Fe)&&q(n)){if(r=i.Ne[n],o=t&&"object"==typeof t&&t.$_serialize||""){if("split"===o&&!e)return 8;if(8===(t=k(n,t,e)))return}null!=t?(u=g?r:i.Xe(n),(c="object"!=typeof r)?(f=t,l=u):(f=JSON.stringify(t),l=JSON.stringify(u)),f!==l&&(f===(u=c?r:JSON.stringify(r))&&(t=r),g||O("sync.this: update",n,"string"==typeof t?(t.length>32?t.slice(0,30)+"...":t).replace(/\n/g,"\\n"):t),w(n,t))):null!=localStorage.getItem(n)&&(g||O("sync.this: reset",n),w(n,r))}},w=function(n,t){s=n,i.Ve(n,t),s="",n in i.Le&&i.Qe({N:6,d:[i.Le[n]]})},J=function(n,t){q(n)&&n!==s&&(a||(setTimeout(D,800),a=r.Lt()),a[n]=t)},_=function(n,t){var r,i,u;p()?(i=f.local,u=function(){var t=o.ae();if(t)return O("storage.local: Failed to update",n,":",t.message||t),t},null==t?i.remove(n,u):i.set(((r={})[n]=t,r),u)):e.w(e.B)},j=function(n){return n.replace(/[<`\u2028\u2029]/g,function(n){return"<"===n?"`l":"`"===n?"`d":"\u2028"===n?"`r":"`n"})},T=function(n){return n.replace(/"|\\[\\"]/g,function(n){return'"'===n?"`q":'\\"'===n?"`Q":"`S"})},h=function(n){var t={Q:'\\"',S:"\\\\",d:"`",l:"<",n:"\u2029",q:'"',r:"\u2028"};return n.replace(/`[QSdlnqr]/g,function(n){return t[n[1]]})},k=function(n,t,e){var r,o,u,l,f="";switch(t.$_serialize){case"split":for(r=t.k,o=t.s,u=0;u<o;u++){if(!(l=e[n+":"+u])||"string"!=typeof l||!l.startsWith(r))return 8;f+=l.slice(r.length)}break;case"single":return JSON.parse(h(JSON.stringify(t.d)));default:return O("Error: can not support the data format in synced settings data:",n,":",t.$_serialize),null}return"string"==typeof i.Ne[n]?f=h(f):(f=h(JSON.stringify(f)),JSON.parse(f.slice(1,-1)))},x=function(n,t,e){var r,o,u,l,f,c,a,s,d,g,y,v;if(t&&!("string"!=typeof t?"object"!=typeof t:t.length<8192/6-40)&&(o="",!((r=JSON.stringify(t)).length<8192/6-40))){if(function(n){return n.replace(/[^\x00-\xff]/g,function(n){var t=n.charCodeAt(0);return"\\u"+(t>4095?"":"0")+t.toString(16)})},4*(r=j(r)).length<8093)return r;if((o=e.encode(r)).length<8093)return r;for(u=0,l=Date.now().toString(36)+":",f={},r="string"==typeof i.Ne[n]?r.slice(1,-1):T(r),S||(S=new TextDecoder),c=0,a=(o=e.encode(r)).length;c<a;){for(s=Math.min(c+8134,a),d=void 0,g=0;s<a&&128==(192&o[s]);s--);if((g=(r=(d=S.decode(o.subarray(c,s))).slice(-6)).lastIndexOf("\\"))>r.length-2)d+="b",g=1;else if(g>0&&"u"===r[g+1])for(y=g=r.length-g;y++<6;d+="b");else g=0;if(d=JSON.parse('"'+d+'"'),g&&((v=d.endsWith("b"))||(s-=g),d=d.slice(0,g>1&&v?g-6:-1)),f[n+":"+u++]=l+d,c=s,u>=13)break}return f[n]={$_serialize:"split",k:l,s:u},f}},D=function(){var n,t,u,l,f,c,s,d,g=a,y=[],v=[],m=[],b=r.Lt(),N={};if(a=null,g&&e.O===J){for(t in n=new TextEncoder,g)for(c="string"==typeof(f=i.Ne[u=t])||"object"==typeof f&&"vimSync"!==u?0:13,null!=(l=g[u])?(s=x(u,l,n))&&"object"==typeof s?(b[u]=s,c=s[u].s):(N[u]=s?{$_serialize:"single",d:JSON.parse(s)}:l,v.push(u)):(m.push(u),y.push(u));c<13;c++)m.push(u+":"+c);for(u in S=n=null,y.length>0&&O("sync.cloud: reset",y.join(", ")),m.length>0&&p().remove(m),v.length>0&&(O("sync.cloud: update",v.join(", ")),p().set(N)),d=function(n){p().set(b[n],function(){var t=o.ae();return t?O("Failed to update",n,":",t.message||t):O("sync.cloud: update (serialized) "+n),t})},b)d(u)}},q=function(n){return!(n in l)},P=function(n){e.i(null),v&&clearTimeout(v),v=setTimeout(function(){v=0,f.local.get(function(n){var t,e,o,u,l,c,a,s,d;if(!i.Xe("vimSync")&&localStorage.length){for(O("storage.local: backup all settings from localStorage"),r.qt(n),t=0,e=localStorage.length;t<e;t++)(o=localStorage.key(t))in i.Ne&&(q(o)||"keyboard"===o)&&(u=i.Ne[o],l=n[o],a=c=i.Xe(o),s=l,"object"==typeof u&&(s=JSON.stringify(l),a=JSON.stringify(c)),a!==s&&_(o,c),delete n[o]);(d=Object.keys(n)).length>0&&f.local.remove(d)}})},n)},Q=function(n,t,u){var l,c,a,d,S,v,m,w,J,j;if(2&t&&f.local.get(function(n){var l,f,c,a,d=o.ae();if(d&&e.b(null),d||!e.Jn&&true===i.Xe("vimSync"))return(t-=2)||u(),d;for(c in r.qt(n),f=void 0!==(l=n.vimSync)||Object.keys(n).length>0,delete n.vimSync,f&&O("storage.local: restore settings to localStorage"),n)c in i.Ne&&(s=c,i.Ve(c,a=null==(a=n[c])?i.Ne[c]:a));s="",null!=l&&i.Ve("vimSync",l),setTimeout(function(){i.Qe({N:6,d:e.yn})},100),(t-=2)||u()}),2!==t){if(r.qt(n),!(l=n.vimSync||i.Xe("vimSync")))return y=l,e.w(_),void(--t||u());for(a in n.vimSync||(O("sync.cloud: enable vimSync"),n.vimSync=l,p().set({vimSync:l})),c=[],n)a in i.Pe&&c.push(a);for(a of(d=[],S={},c))for(v=i.Pe[a],m=-1,w=void 0;m<13&&(w=m<0?a:a+":"+m)in n;m++)S[J=m<0?v:v+":"+m]=n[J]=n[w],delete n[w],d.push(w);for(c.length>0&&(f.onChanged.removeListener(b),e.w(e.B),p().remove(d),p().set(S,o.ae),c.length=0),m=0,j=localStorage.length;m<j;m++)!((a=localStorage.key(m))in n)&&a in i.Ne&&q(a)&&c.push(a);for(a of c)N(a,null);for(a in n)a.includes(":")||N(a,n[a],n);i.We("vimSync"),setTimeout(function(){--t||u()},4),g&&3!==t&&O("sync.cloud: download settings to localStorage")}},i.Je.vimSync=function(n){var t,r,o;if(y=n,p()){if(r=(t=p().onChanged)||f.onChanged,o=t?m:b,!n)return r.removeListener(o),void(e.O!==_&&(e.w(_),P(600)));e.O!==J&&(r.addListener(o),e.w(J),v&&clearTimeout(v),v=0,f.local.getBytesInUse(function(n){n>0&&f.local.get(function(n){delete n.vimSync,O("switch to sync.cloud, when old settings data in storage.local is:","\n"+JSON.stringify(n,null,2)),v=setTimeout(function(){v=0,f.local.clear()},8e3)})}))}},e.b(function(){if(g);else{if(localStorage.length)return null;g=new Promise(function(n){y?p().get(function(t){var r=o.ae();return r?(e.b(null),n()):Q(t,1,n),r}):Q({},2,n)}).then(function(){g=null})}return g});false===(y=i.Xe("vimSync"))||!y&&!e.Jn?(e.i((z=true===e.j)?null:P),z&&P(6e3),e.w(_)):p()?p().get(function(n){var t=o.ae();if(t)return O("Error: failed to get storage:",t,"\n\tSo disable syncing temporarily."),i.Je.vimSync=void 0,e.w(e.B),e.b(null),t;g=Promise.resolve(),g=new Promise(function(t){return Q(n,3,t)}).then(function(){g=null})}):(e.w(e.B),e.b(null))});