"use strict";__filename="background/others.js",define(["require","exports","./store","./browser","./utils","./settings","./i18n","./normalize_urls","./parse_urls","./open_urls"],function(e,n,t,o,i,r,u,l,a,c){Object.defineProperty(n,"__esModule",{value:true}),i=__importStar(i);var s,f,m,d,p,g,v,_=(r=__importStar(r)).Je.showActionIcon=function(n){var i,l=o.me.action||o.me.browserAction;l?(t.T(n),new Promise(function(n,t){e(["/background/action_icon.js"],n,t)}).then(__importStar).then(function(e){e.ti()}),i=u._r("name"),n||(i+="\n\n"+u._r("noActiveState")),l.setTitle({title:i})):r.Je.showActionIcon=void 0};r.Xe("showActionIcon")?_(true):t.M(t.B),setTimeout(function(){new Promise(function(n,t){e(["/background/sync.js"],n,t)}).then(__importStar)},100),(function(){function e(){b&&(b.So=null),h=y=b=v=null,S&&clearTimeout(S),w&&clearTimeout(w),k=M=P=S=w=0,_="",i.$t()}function n(){var t=Date.now()-k;if(t>5e3||t<-5e3)return e();S=setTimeout(n,3e4)}function r(){var e,n;if(w=0,(e=b)&&!e.Do)return b=null,e.So?((n=Date.now())<k&&(k=n-1e3),f(e.la,e.So)):void 0}function s(e,n,r,l,c){var s,f,m,p,w,T,S,k,j,U,C,F,I,V,q,x;if(e.So){for(b=null,s=n.length>0?n[0]:null,M=l,P=c,y=[],m=new Set,p=(" "+t.qn.s+" ").includes(" type-letter "),w=0,T=r?0:1,S=n.length;w<S;w++)j=(k=n[w]).title,C=k.e,F="",I=null!=k.s,V=g&&!(r&&0===w)&&("tab"===C?k.s!==t.Cn:"history"===C&&!I),m.has(U=k.u)?U=":"+(w+T)+" "+U:m.add(U),U=i.vt(U,1).replace(/%20/g," "),V&&(F=" ~"+(w+T)+"~"),q={content:U=a.je(U),description:F=(j||p?(j?j+" <dim>":"<dim>")+(p?"["+k.e[0].toUpperCase()+"] ":"")+(j?"-</dim> <url>":"</dim><url>"):"<url>")+k.textSplit+"</url>"+(F&&"<dim>"+F+"</dim>")},V&&(q.deletable=true),(V||I)&&(h||(h=new Map),h.has(U)||h.set(U,{Po:C,Qi:I?k.s:null})),y.push(q);v=e.la,r?"search"===s.e?(f=((x=s.p)&&"<dim>"+(i.It(x)+d)+"</dim>")+"<url>"+s.textSplit+"</url>",D=2,(s=n[1])&&"math"===s.e&&(y[1].description=s.textSplit+" = <url><match>"+s.t+"</match></url>")):(D=3,f=y[0].description):1!==D&&(f="<dim>"+u._r("OpenC")+"</dim><url>%s</url>",D=1),r&&(_=n[0].u,h&&y.length>0&&_!==y[0].content&&h.set(_,h.get(y[0].content)),y.shift()),f&&o.me.omnibox.setDefaultSuggestion({description:f}),e.So(y),i.$t()}else b===e&&(b=null)}function f(e,o){var u,l,a,c;e=e.trim().replace(i.Mt," "),b&&(b.So=(u=e===b.la)?o:null,u)||(e!==v?1===M&&e.startsWith(v)?o([]):(b={So:o,la:e,Do:false},w||(l=Date.now(),(a=t.qn.t+k-l)>30&&a<3e3?w=setTimeout(r,a):(b.Do=true,S||(S=setTimeout(n,3e4)),k=l,h=y=null,_="",c=M<2||!e.startsWith(v)?0:3===M?e.includes(" ")?0:8:P,t.x.pu(e,{o:"omni",t:c,r:j,c:T,f:1},s.bind(null,b))))):y&&o(y))}function m(e,n,o){return e?":"===e[0]&&/^:([1-9]|1[0-2]) /.test(e)&&(e=e.slice(" "===e[2]?3:4)):e=l.Ee(""),"file://"===e.slice(0,7).toLowerCase()&&(e=/\.(?:avif|bmp|gif|icon?|jpe?g|a?png|tiff?|webp)$/i.test(e)?l.he("show image "+e,false,0):e),null!=o?t.fn[5]({s:o}):c.openUrlReq({u:e,r:"currentTab"===n?0:"newForegroundTab"===n?-1:-2})}var d,p,g,v,_,b,w,h,T,y,S,k,D,M,P,j,U=o.me.omnibox;U&&(d=u._r("colon")+u._r("NS"),g=!!(p=U.onDeleteSuggestion)&&"function"==typeof p.addListener,v=null,_="",b=null,w=0,h=null,T=128,y=null,S=0,D=0,M=0,P=0,j=t.Un<60?6:12,U.onInputStarted.addListener(function(){if(o.getCurWnd(false,function(e){var n=e&&e.width;T=n?Math.floor((n-160/devicePixelRatio)/7.72):128}),S)return e()}),U.onInputChanged.addListener(f),U.onInputEntered.addListener(function n(o,u){var l,a,c=b;if(c&&c.So){if(c.So=n.bind(null,o,u),c.Do)return;return w&&clearTimeout(w),r()}return o=o.trim().replace(i.Mt," "),null===v&&o?t.x.pu(o,{o:"omni",t:0,r:3,c:T,f:1},function(e,n){return n?m(e[0].u,u,e[0].s):m(o,u)}):(_&&o===v&&(o=_),a=null===(l=null==h?void 0:h.get(o))||void 0===l?void 0:l.Qi,e(),m(o,u,a))}),g&&p.addListener(function(e){var n=parseInt(e.slice(e.lastIndexOf("~",e.length-2)+1))-1,o=y&&y[n].content,i=o&&(null==h?void 0:h.get(o))||null,r=i&&i.Po;r?(":"===o[0]&&(o=o.slice(o.indexOf(" ")+1)),t.fn[22]({t:r,s:i.Qi,u:o},null)):console.log("Error: want to delete a suggestion but no related info found (may spend too long before deleting).")}))})(),s=0,f=false,m=0,d=t.zn?"edge:":"chrome:",p=t.zn?"":d+"//newtab/",g=t.zn?"":d+"//new-tab-page/",v=function(e){0===e.frameId&&e.url.startsWith(d)&&s&(e.url.startsWith(p)||e.url.startsWith(g)?2:1)&&!m&&o.ne(e.tabId)},o.ee([{origins:["chrome://*/*"]},t.Un>79&&!t.zn?{origins:["chrome://new-tab-page/*"]}:null],function e(n){if(1&(s=(n[0]?1:0)+(n[1]?2:0))&&!r.Xe("allBrowserUrls")&&(s^=1),f!==!!s){var i=o.ce();if(!i)return false;i.onCommitted[(f=!f)?"addListener":"removeListener"](v)}m=m||s&&setTimeout(function(){s?o.ve.query({url:d+"//*/*"},function(e){for(var n of(m=0,e||[]))!t.Pn.has(n.id)&&s&(n.url.startsWith(p)||n.url.startsWith(g)?2:1)&&o.ne(n.id);return o.ae()}):m=0},120),s&&!r.Je.allBrowserUrls&&(r.Je.allBrowserUrls=e.bind(null,n,false))}),t.Ln&&t.Ln.then(function(e){var n=e.reason;if("install"===n)n="";else{if("update"!==n)return;n=e.previousVersion}setTimeout(function(){var i,a;o.ve.query({status:"complete"},function(e){var n,t=/^(file|ftps?|https?):/;for(n of e)t.test(n.url)&&o.ne(n.id)}),console.log("%cVimium C%c has been %cinstalled%c with %o at %c%s%c.","color:red","color:auto","color:#0c85e9","color:auto",e,"color:#0c85e9",new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,-5).replace("T"," "),"color:auto"),t.u.rt&&console.log("Sorry, but some commands of Vimium C require the permission to run in incognito mode."),n?(r.We("vomnibarPage"),parseFloat(t.u.ft)<=parseFloat(n)||(t.j?t.j(6e3):t.i(true),r.We("newTabUrl"),r.Xe("notifyUpdate")&&(n="vimium_c-upgrade-notification",i={type:"basic",iconUrl:location.origin+"/icons/icon128.png",title:"Vimium C "+u._r("Upgrade"),message:u._r("upgradeMsg",[t.u.at])+u._r("upgradeMsg2")+"\n\n"+u._r("clickForMore")},t.Un<67&&(i.isClickable=true),t.Un>=70&&(i.silent=true),(a=o.me.notifications)&&a.create(n,i,function(e){var i;if(i=o.ae())return i;n=e||n,a.onClicked.addListener(function e(o){o===n&&(a.clear(n),t.fn[20]({u:l.Ee("vimium://release")}),a.onClicked.removeListener(e))})})))):(t.N&&t.N()||Promise.resolve()).then(function(){return gA.ao?new Promise(function(e){return setTimeout(e,200)}):0}).then(function(){t.fn[20]({u:t.u._t+"#commands"})})},500)}),t.G(null),setTimeout(function(){globalThis.document.body.innerHTML="",i.$t()},1e3)});