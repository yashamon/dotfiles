"use strict";__filename="background/ports.js",define(["require","exports","./store","./utils","./browser","./exclusions","./i18n"],function(n,r,u,o,t,e,l){var i,f,c,a,s,v,d,_,b,m,g;Object.defineProperty(r,"__esModule",{value:true}),r.getParentFrame=r.complainNoSession=r.complainLimits=r.eo=r.ensuredExitAllGrab=r.showHUD=r.safePost=r.isNotVomnibarPage=r.ensureInnerCSS=r.indexFrame=r.isExtIdAllowed=r.findCPort=r.nr=r.rr=r.OnConnect=r.sendResponse=void 0,i=function(n,r){if(90!==n.H)u.fn[n.H](n,r);else{var o=u.fn[n.c](n.a,r,n.i);o!==r&&r.postMessage({N:4,m:n.i,r:o})}},r.sendResponse=function(n,r,o){var t=u.Pn.get(n.s.ur);if(t&&t.oo.includes(n))try{n.postMessage({N:4,m:r,r:o})}catch(n){}},r.OnConnect=function(n,r){var o,l,a,v,d,_,b=s(n),m=b.Ae,g=m===u.An.vomnibarPage_f;if(r>3||g){if(999===r)return void(b.ur>=0&&!b.or&&t.removeTempTab(b.ur,n.sender.tab.windowId,b.Ae));if(16&r||g)return void c(n,r,g||m===u.u.gt)}null!==(a=void 0!==(l=(o=b.ur)>=0?u.Pn.get(o):void(o=b.ur=u.getNextFakeTabId()))?l.tr:null)?(d=a.er,_=2===(v=a.Wn)?3:1):(v=null===(d=e.lr?e.ir(m,b):null)?0:d?1:2,_=0),b.Wn=v,void 0!==l&&(_|=4&l.fr,32&r&&(_|=128,l.fr|=128),b.fr=_),4&r?(b.fr|=8&r,n.postMessage({N:1,p:d,f:3&_}),n.postMessage({N:6,d:u.yn})):n.postMessage({N:0,f:_,c:u.yn,p:d,m:u._n,t:u.an,k:u.mn}),n.onDisconnect.addListener(f),n.onMessage.addListener(i),void 0!==l?(2&r&&(u.xn&&l.cr.s.Wn!==v&&u.R(o,v),l.cr=n),1&r&&!l.ar&&(l.ar=n),l.oo.push(n)):(u.Pn.set(o,{cr:n,ar:1&r?n:null,oo:[n],tr:null,fr:0}),0!==v&&u.xn&&u.R(o,v))},f=function(n){var r,o,t=n.s.ur,e=u.Pn.get(t);e&&(r=(o=e.oo).lastIndexOf(n),n.s.or?(r===o.length-1?--o.length:r>=0&&o.splice(r,1),o.length?n===e.cr&&(e.cr=o[0]):u.Pn.delete(t)):r>=0&&u.Pn.delete(t))},c=function(n,r,e){if(r>15){if(e)return n.s.ur<0&&(n.s.ur=4&r?u.getNextFakeTabId():u.cPort?u.cPort.s.ur:u.Cn),n.s.fr|=256,u.Sn.push(n),n.onDisconnect.addListener(a),n.onMessage.addListener(i),void(4&r||n.postMessage({N:42,l:u.qn,s:o.n(false)}))}else n.s.ur<0||u.Un<50||0===n.s.or||t.ve.executeScript(n.s.ur,{file:u.u.bt,frameId:n.s.or,runAt:"document_start"},t.ae);n.disconnect()},a=function(n){var r=u.Sn,o=r.lastIndexOf(n);o===r.length-1?--r.length:o>=0&&r.splice(o,1)},s=function(n){var r=n.sender,u=r.tab||{id:-1,incognito:false},o=r.url;return r.tab=null,n.s={or:r.frameId||0,sr:u.incognito,Wn:0,fr:0,ur:u.id,Ae:o}},v=function(n,o,l){var i;return(n=n||(null===(i=u.Pn.get(u.Cn))||void 0===i?void 0:i.ar))&&e.lr&&(o||e.vr)?n.s.Ae:new Promise(function(o){var e=u.Un>48&&n&&n.s.or?t.ce():null;n?(e?e.getFrame:t.tabsGet)(e?{tabId:n.s.ur,frameId:n.s.or}:n.s.ur,function(u){var i=u?u.url:"";return!i&&e&&(l.N=3,r.safePost(n,l)),o(i),t.ae()}):t.getCurTab(function(n){return o(n&&n.length?t.getTabUrl(n[0]):""),t.ae()})})},r.rr=v,d=function(n,o){var t,e;if(u.set_cPort(u.cPort||(null===(t=u.Pn.get(u.Cn))||void 0===t?void 0:t.ar)),"string"!=typeof(e=r.rr(u.cPort,o,n)))return e.then(function(r){return n.u=r,r&&u.fn[n.H](n,u.cPort),r});n.u=e,u.fn[n.H](n,u.cPort)},r.nr=d,r.findCPort=function(n){var r=u.Pn.get(n?n.s.ur:u.Cn);return r?r.cr:null},r.isExtIdAllowed=function(n){var r,o,t=null!=n.id?n.id:"unknown_sender",e=n.url,l=n.tab,i=u.kn,f=i.get(t);return true!==f&&l&&(o=(r=u.Pn.get(l.id))?r.dr:null,r&&(null==o||o!==t&&"string"==typeof o)&&(r.dr=null==o?t:2)),null!=f?f:e===u.An.vomnibarPage_f||(console.log("%cReceive message from an extension/sender not in the allow list: %c%s","background-color:#fffbe5","background-color:#fffbe5;color:red",t),i.set(t,false),false)},r.indexFrame=function(n,r){var o,t=u.Pn.get(n);for(o of t?t.oo:[])if(o.s.or===r)return o;return null},r.ensureInnerCSS=function(n){if(8&n.fr)return null;var r=u.Pn.get(n.ur);return r&&(r.fr|=4),n.fr|=12,u.Dn},r.isNotVomnibarPage=function(n,r){var u=n.s,o=u.fr;return!(256&o)&&(r||512&o||(console.warn("Receive a request from %can unsafe source page%c (should be vomnibar) :\n %s @ tab %o","color:red","color:auto",u.Ae.slice(0,128),u.ur),u.fr|=512),true)},r.safePost=function(n,r){try{return n.postMessage(r),1}catch(n){return 0}},_=function(n,o){o&&(n.startsWith(u.u.ut+"-")&&n.includes("://")&&(n=n.slice(n.indexOf("/",n.indexOf("/")+2)+1)||n),n=n.length>41?n.slice(0,41)+"\u2026":n+"."),u.cPort&&!r.safePost(u.cPort,{N:12,H:r.ensureInnerCSS(u.cPort.s),k:o?n?20:o:1,t:n})&&u.set_cPort(null)},r.showHUD=_,r.ensuredExitAllGrab=function(n){var r,u={N:8};for(r of n.oo)4&r.s.fr||(r.s.fr|=4,r.postMessage(u));n.fr|=4},r.eo=function(n,r){var t,e=o.At(u.Pn),l=u.Cn,i=function(r){var o=u.Pn.get(r),t=0;return null!=o&&(t=Math.min(o.oo.length,8),n(o)),t};e.length<50?((t=e.indexOf(l))>=0&&(e.splice(t,1),n(u.Pn.get(l))),o.a(e,i,r)):e.forEach(i)},b=function(n){r.showHUD(l._r("notAllowA",[n]))},r.complainLimits=b,m=function(){r.complainLimits("control tab sessions")},r.complainNoSession=m,g=function(n,u,o){return u&&t.ce()?1===o&&true?t.te(t.ce().getFrame,{tabId:n,frameId:u}).then(function(u){var o=u?u.parentFrameId:0;return o>0?r.indexFrame(n,o):null}):t.te(t.ce().getAllFrames,{tabId:n}).then(function(t){var e,l=false,i=u;if(!t)return null;do{for(e of(l=false,t))if(e.frameId===i){l=(i=e.parentFrameId)>0;break}}while(l&&0<--o);return i>0&&i!==u?r.indexFrame(n,i):null}):Promise.resolve(null)},r.getParentFrame=g});