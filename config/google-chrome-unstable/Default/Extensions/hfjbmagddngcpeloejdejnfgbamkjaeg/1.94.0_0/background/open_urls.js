"use strict";__filename="background/open_urls.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./parse_urls","./ports","./exclusions","./i18n","./run_commands","./clipboard","./tools"],function(n,r,u,e,t,i,o,l,f,c,a,s,d){var v,p,w,m,g,b,y,h,I,P,$,_,T,k,x,j,z,L,M,N;Object.defineProperty(r,"__esModule",{value:true}),r.su=r.openUrlReq=r.openUrl=r.goToNextUrl=r.openUrlWithActions=r.openShowPage=r.openJSUrl=r.parseReuse=r.du=r.parseOpenPageUrlOptions=r.preferLastWnd=r.newTabIndex=void 0,e=__importStar(e),v={current:0,reuse:1,newwnd:2,newbg:-2,lastwndfg:-5,lastwnd:-5,lastwndbg:-6,iflastwnd:-7,lastwndbgbg:-8,lastwndbginactive:-8},r.newTabIndex=function(n,r,u,e){return"before"===r||"left"===r||"prev"===r||"previous"===r?n.index:"after"===r||"next"===r||"right"===r?n.index+1:"default"===r?void 0:false!==e&&null!=t.getGroupId(n)?"start"===r||"begin"===r?n.index:"end"===r?void 0:n.index+1:"start"===r||"begin"===r?0:"end"===r?u?3e4:void 0:n.index+1},r.preferLastWnd=function(n){return n.find(function(n){return n.id===u.Mn})||n[n.length-1]},r.parseOpenPageUrlOptions=function(n){return{g:n.group,i:n.incognito,m:n.replace,o:n.opener,r:n.reuse,p:n.position,w:n.window}},p=function(n){return n===!!n?n:n?"force"===n||("reverse"===n?2!==u.wn:"same"===n||"keep"===n?2===u.wn:null):null},w=function(n){return"popup"===n||"normal"===n?n:void 0},m=function(n,r,e){var i=function(r){return!(n&&r.type!==n||null!=e&&r.incognito!==e||"minimized"===r.state)};return(u.Mn<0?Promise.resolve(null):new Promise(function(n){t.de.get(u.Mn,function(r){return n(r?i(r)?r:null:(u.un(-1),null)),t.ae()})})).then(function(n){return n||new Promise(function(n){return t.de.getAll(function(e){var t=e.filter(function(n){return i(n)&&n.id!==u.vn}),o=t.length>0?t.sort(function(n,r){return r.id-n.id})[0]:null;o&&u.Mn<0&&u.un(o.id),n(o||!r?o:e.find(function(n){return n.id===u.vn})||e.find(function(n){return n.focused})||null)})})})},r.du=function(n,r){n=n.slice(0,128).split("?")[0].replace(/\\/g,"/");var e=2===u.yn.o&&/\/globalroot\/device\/condrv|\bdevice\/condrv\/kernelconnect/.test(n);return e&&(u.set_cPort(r||u.cPort),l.showHUD(c._r("harmfulURL"))),e},g=function(n,u,t,o){if(o instanceof Promise)o.then(g.bind(0,n,u,t));else switch(e.$t(),o[1]){case 1:l.showHUD(o[0],15),a.runNextCmdBy(1,u);break;case 5:case 7:a.replaceCmdOptions(u),7===o[1]||u.$p?n=0:(a.overrideCmdOptions({},true),a.overrideOption("$p",1)),r.openUrlWithActions(i.Ee(o[0]),n,t);break;case 4:n>=3&&o[0]&&a.runNextCmdBy(1,u);break;case 6:a.runNextCmdBy(1,u)}},b=function(n,r,u){n?a.runNextOnTabLoaded(r,u):a.runNextCmdBy(0,r)},y=function(n,r,u,e){var i=function(r){return b(r,n,r),t.ae()};if(e){if(e.length>0&&e[0].incognito&&t.re(r))return void t.tabsCreate({url:r},i)}else if(t.re(r)&&true!==u)return void t.getCurTab(y.bind(null,n,r,true));e?t.tabsUpdate(e[0].id,{url:r},i):t.tabsUpdate({url:r},i)},h=function(n,r,u,e,i,o){t.makeWindow({url:n,focused:r,incognito:u,type:"string"==typeof n||1===n.length?w(e.window):void 0,left:i.left,top:i.top,width:i.width,height:i.height},null!=i.state?i.state:o&&"minimized"!==o.state?o.state:"",function(n){b(n,e,n&&n.tabs[0])})},I=function(n,e,i,o,l){var f,c,a=-2!==e,s=o?o.windowId:u.vn,d=l.find(function(n){return n.id===s}),v=null!=d&&d.incognito;!i.window&&2!==e&&(v||(l=l.filter(function(n){return n.incognito&&"normal"===n.type})).length>0)?(f={url:n[0],active:a,windowId:v?s:r.preferLastWnd(l).id},v&&(f.index=r.newTabIndex(o,i.position,c=true===i.opener,i.group),c&&(f.openerTabId=o.id)),t.openMultiTabs(f,u.cRepeat,true,n,v&&i.group,o,function(n){!v&&a&&t.selectWnd(n),b(n,i,n)})):h(n,true,true,i,i,d)},r.parseReuse=function(n){return null==n?-1:"string"!=typeof n?isNaN(+n)?-1:0|n:(n=n.toLowerCase().replace("window","wnd").replace(/-/g,""))in v?v[n]:-1},P=function(n,r,i){var o,l,f,c,a,s,d,v,p=r&&r.length>0?t.getTabUrl(r[0]):"",w=[i,u.get_cOptions().host_mask||u.get_cOptions().host_mark,u.get_cOptions().tabid_mask||u.get_cOptions().tabId_mask||u.get_cOptions().tabid_mark||u.get_cOptions().tabId_mark,u.get_cOptions().title_mask||u.get_cOptions().title_mark,u.get_cOptions().id_mask||u.get_cOptions().id_mark||u.get_cOptions().id_marker],m=[];for(o=0;o<w.length;o++)if((f=(l=null!=w[o]?w[o]+"":"")?n.indexOf(l):-1)>=0){for(a of(c=f+l.length,m));m.push([f,c,0===o?/[%$]s/.test(l)?e.k(p):p:1===o?new URL(p).host:2===o?p&&""+r[0].id:3===o?p&&""+e.k(r[0].title):t.me.runtime.id])}if(m.length){for(v of(s="",d=0,m.sort(function(n,r){return n[0]-r[0]}),m))s=s+n.slice(d,v[0])+v[2],d=v[1];n=s+n.slice(d)}return n},$=function(n,e,i,o){var l=p(o.incognito);(e>-4?new Promise(function(n){t.getCurWnd(false,function(r){return n(r||null),t.ae()})}):m(w(o.window),true,l)).then(function(n){return n&&new Promise(function(r){t.ve.query({active:true,windowId:n.id},function(u){return n.tabs=u,r(n),t.ae()})})}).then(function(f){var c,s=!!f&&!f.focused&&f.id!==u.vn,d=-7===e&&!s;if(f&&(s||-7===e&&(null==l||f.incognito===!!l)))c=f.tabs&&f.tabs.length>0?t.selectFrom(f.tabs):null,t.openMultiTabs({url:n[0],active:e>-6||d,windowId:f.id,pinned:!!o.pinned,index:c?r.newTabIndex(c,o.position,false,o.group):void 0},u.cRepeat,!!o.incognito&&"string"==typeof o.incognito,n,o.group,c,function(n){e>-6?s&&t.selectWnd(n):n&&e>-8&&!d&&t.selectTab(n.id),b(n,o,e>-6&&-2!==e&&n)});else{if(-7===e&&a.runNextCmdBy(0,o))return;h(n,e>-8,null!=l?!!l:i,o,o,f)}})},_=function(n,e,i,o){var l,f,c=o&&o[0],a=!!c&&c.incognito||2===u.wn,s=-2!==e&&-8!==e,d=2===e||e<-3||!!i.window,v=p(i.incognito),w=null!=v&&"string"==typeof i.incognito;if(!w&&n.some(t.re))d=a||d;else if(a)d=false===v||d;else if(v&&e>-4)return void t.de.getAll(I.bind(null,n,e,i,c));d?$(n,e,a,i):(f={url:n[0],active:s,windowId:c?c.windowId:void 0,openerTabId:l=i.opener&&c?c.id:void 0,pinned:!!i.pinned,index:c?r.newTabIndex(c,i.position,null!=l,i.group):void 0},t.openMultiTabs(f,u.cRepeat,w,n,i.group,c,function(n){s&&n&&t.selectWndIfNeed(n),b(n,i,s&&n)}))},T=function(n,e,i,o,l,c){var s,d=i?"string"==typeof i?f.Jt(i):"object"==typeof i&&i.t&&i.v?i:null:null,v=2===e||1===e,g=1===e&&l.q||{},y=w(1===e?g.w:o.window),h=p(1!==e?o.incognito:g.i),I=true===(1!==e?o.group:g.g);u.set_cRepeat(1),1===e?(g.m=null,g.g=I):(a.overrideOption("group",I,o),null!=o.replace&&a.overrideOption("replace",d,o)),s=e<-3&&d?m(y,-7===e,h):Promise.resolve(!v&&u.vn>=0?{id:u.vn}:null),Promise.all([s,!I||c?null:new Promise(function(n){t.getCurTab(function(r){c=r||[],n()})})]).then(function(n){var r=n[0];return d&&(r||v)?new Promise(function(n){t.ve.query(r?{windowId:r.id}:{windowType:y||void 0},function(r){var i,o,l=null!=h?!h:e>-4?2!==u.wn:-2,a=(r||[]).filter(function(n){return f.Gt(d,n.url)&&n.incognito!==l});return I&&a.length>0&&c.length>0&&(i=t.getGroupId(c[0]),r&&(a=a.filter(function(n){return t.getGroupId(n)===i}))),a.sort(function(n,r){var e=u.jn.get(r.id),t=u.jn.get(n.id);return t?e?e.i-t.i:1:e?-1:r.id-n.id}),1===e&&(o=a.filter(function(n){return n.windowId===u.vn}),a=o.length>0?o:a),n(a.length?a[0]:null),t.ae()})}):null}).then(function(i){var f,s;null==i||i.id===u.Cn&&1!==e?1===e?r.su(l):a.runNextCmdBy(0,o)||(c?_([n],e,o,c):t.getCurTab(_.bind(null,[n],e,o))):(f=-2!==e&&-8!==e,s=i.windowId!==u.vn&&e>-6,t.tabsUpdate(i.id,{url:n},function(n){return n&&(f&&(t.selectTab(n.id),n.active=true),s&&t.selectWnd(n)),b(n,1===e?l.f||{}:o,-2!==e&&e>-6&&n),t.ae()}))})},r.openJSUrl=function(n,r,i){if(!/^(void|\(void\))? ?(0|\(0\))?;?$/.test(n.slice(11).trim())){if(!i&&u.cPort){if(l.safePost(u.cPort,{N:5,u:n,f:a.parseFallbackOptions(r)}))return;u.set_cPort(null)}var o=function(u){if(-1===u||t.ae()){var o=e.jt(n.slice(11));return t.te(t.ve.executeScript,{code:o}).then(function(n){void 0===n&&i&&i(),b(void 0!==n,r,null)}),t.ae()}a.runNextOnTabLoaded(r,null)};u.Un<71?t.tabsUpdate({url:n},o):o(-1)}},k=function(n,e,i,o){var l,f,c,s=u.u.dt;return!(n.length<s.length+3||!n.startsWith(s))&&(o?(n=n.slice(s.length),l=o.incognito,n.startsWith("#!image ")&&l&&(n="#!image incognito=1&"+n.slice(8).trim()),u.e((f=[n,null,0])[1]=function(){return clearTimeout(f[2]),u.e(null),f[0]}),f[2]=setTimeout(function(){f[0]="#!url vimium://error (vimium://show: sorry, the info has expired.)",f[2]=setTimeout(function(){u.C===f[1]&&u.e(null),f[0]="",f[1]=null},2e3)},1200),u.set_cRepeat(1),0!==e||l?l&&[0,-2,-1].indexOf(e)>=0?t.tabsCreate({url:s,active:-2!==e},function(n){b(n,i,n)}):(i.incognito=false,_([s],e,i,[o])):((c=u.Un>=54&&!o.url.split("#",2)[1]?t.me.extension.getViews({tabId:o.id}):[]).length>0&&c[0].location.href.startsWith(s)&&c[0].onhashchange?c[0].onhashchange():t.tabsUpdate(o.id,{url:s}),a.runNextOnTabLoaded(i,null)),true):(t.getCurTab(function(u){if(!u||u.length<=0)return t.ae();r.openShowPage(n,e,i,u[0])}),true))},r.openShowPage=k,x=function(n){var e,o,l,f,c=u.get_cOptions(),s=c.urls;if(2!==c.$fmt){if(1!==c.$fmt)for(e=0;e<s.length;e++)s[e]=i.Ee(s[e]+"");a.overrideOption("$fmt",2)}for(o of s)if(r.du(o))return t.ae();f=1===(l=r.parseReuse(c.reuse))||0===l?-1:l,u.set_cOptions(null),_(s,f,c,n)},j=function(n,o,l){var f,c,s,d,v,p,w;"string"!=typeof n||(n||9!==o?(c=u.get_cOptions().url_mask,s=u.get_cOptions().url_mark,null==c&&null==s||(n=P(n,l,null!=c?c:s)),9!==o&&(d=(u.get_cOptions().keyword||"")+"",n=(null!==(f=u.get_cOptions().testUrl)&&void 0!==f?f:!d)?i.Ee(n,d,o):i.be(n.trim().split(e.Mt),d||"~")),(v=u.get_cOptions().goNext)&&n&&"string"==typeof n&&(n=u.P(n,8192),n=r.goToNextUrl(n,u.cRepeat,v)[1]),n="string"==typeof n?i.pe(n):n):n=u.An.newTabUrl_f),p=u.get_cOptions(),w=r.parseReuse(p.reuse),u.set_cOptions(null),e.$t(),"string"!=typeof n?g(o,p,l,n):r.openShowPage(n,w,p)||(e.Pt(n)?r.openJSUrl(n,p):r.du(n)?a.runNextCmdBy(0,p):1===w?T(n,w,p.replace,null,{u:n,p:p.prefix,q:r.parseOpenPageUrlOptions(p),f:a.parseFallbackOptions(p)},l):0===w?y(p,n):p.replace?T(n,w,p.replace,p,null,l):l?_([n],w,p,l):t.getCurTab(_.bind(null,[n],w,p)))},r.openUrlWithActions=j,z=function(n,f){var s,d,v,p,w,m,g,b,y,h,I,P,$;if(null===f)return l.complainLimits("read clipboard"),void a.runNextCmd(0);if(!(f=f.trim()))return l.showHUD(c._r("noCopied")),void a.runNextCmd(0);if(v="string"==typeof(d=u.get_cOptions().copied)&&d.includes("any"),("urls"===d||v)&&(s=f.split(/[\r\n]+/g)).length>1){for(g of(p=[],w=v&&u.get_cOptions().keyword?u.get_cOptions().keyword+"":null,m=false,s))if(g=g.trim()){if(g=i.Ee(g,w,0),!(v||i._e<2)){p.length=0,m=true;break}p.push(g)}if(p.length>1)return u.set_cOptions(a.copyCmdOptions(e.Lt(),u.get_cOptions())),u.get_cOptions().urls=p,u.get_cOptions().$fmt=1,void(n&&n.length>0?x(n):t.getCurTab(x));if(m)return void(a.runNextCmd(0)||l.showHUD("The copied lines are not URLs"))}i.xe.test(f)?f=f.slice(1,-1):(null!=(b=u.get_cOptions().testUrl)?b:!u.get_cOptions().keyword)&&(f=o.Ue(f,b)),(y=f.indexOf("://")+3)>3&&e.Dt.test(f)&&(h=void 0,I=(f=/^ttps?:/i.test(f)?"h"+f:f).indexOf("/",y)+1||f.length,P=f.slice(y,I),f=($=P.startsWith("0.0.0.0")?7:P.includes(":::")&&(h=/^(\[?::\]?):\d{2,5}$/.exec(P))?h[1].length:0)?f.slice(0,y)+($>6?"127.0.0.1":"[::1]")+f.slice(y+$):f),r.openUrlWithActions(f,2,n)},r.goToNextUrl=function(n,r,u){var e=false;return n=n.replace(/\$(?:\{(\d+)[,\/#@](\d*):(\d*)(:-?\d*)?\}|\$)/g,function(n,t,i,o,l){var f,c,a,s,d;return"$$"===n?"$":(e=true,c=t&&parseInt(t)||1,a=i&&parseInt(i)||0,s=o&&parseInt(o)||0,(d=l&&parseInt(l.slice(1))||1)<0&&(a=(f=[s,a])[0],s=f[1]),r*=d,c="absolute"!==u?c+r:r>0?a+r-1:r<0?s+r:c,""+Math.max(a||1,Math.min(c,s?s-1:c)))}),[e,n]},L=function(n){var e,i,o,l;if(u.get_cOptions().urls)u.get_cOptions().urls instanceof Array&&(n&&n.length>0?x(n):t.getCurTab(x));else{if((null!=u.get_cOptions().url_mask||null!=u.get_cOptions().url_mark)&&!n)return t.ae()||void t.getCurTab(r.openUrl);(e=u.get_cOptions().url)?(e=(i=s.eu(u.get_cOptions()))?u.P(e+"",0,i):e+"",r.openUrlWithActions(e,3,n)):u.get_cOptions().copied?(o=u.V(s.eu(u.get_cOptions())))instanceof Promise?o.then(z.bind(null,n)):z(n,o):(l=u.get_cOptions().url_f,r.openUrlWithActions(l||"",9,n))}},r.openUrl=L,M=function(n,t){var f,c,s,d,v,w,m,g,b;if(e.qt(n),c=null!=t&&l.isNotVomnibarPage(t,true),u.set_cPort(c?t:l.findCPort(t)||u.cPort),s=n.u,d=n.n&&a.parseFallbackOptions(n.n)||{},w=((v=n.o||e.Lt()).k||"")+"",m=null!==(f=v.t)&&void 0!==f?f:!w,g=v.s,d.group=!c||v.g,d.incognito=null!=p(v.i)?v.i:n.i,d.replace=v.m,d.position=v.p,d.reuse=null!=v.r?v.r:n.r,d.window=v.w,s)":"===s[0]&&!c&&/^:[bhtwWBHdso]\s/.test(s)&&(s=s.slice(2).trim()),s=u.P(s,n.f?0:c?524288:16384,g),n.f?s=s!==n.u?i.Ee(s):s:m||!c?(s=m?o.Ue(s,m):s,s=i.Ee(s,w,c?-1:3),b=i._e,null==n.h||2!==b&&1!==b?c&&3===b&&s.startsWith("vimium:")&&(s=i.Ee(s)):s=(n.h?"https":"http")+s.slice("s"===s[4]?5:4)):s=i.be(s.trim().split(e.Mt),w||"~"),d.opener=c?false!==v.o:u.An.vomnibarOptions.actions.includes("opener"),d.url_f=s;else{if(false===n.c)return;d.copied=null==n.c||n.c,d.keyword=w,d.testUrl=v.t,d.sed=g}u.set_cRepeat(1),a.replaceCmdOptions(d),r.openUrl()},r.openUrlReq=M,N=function(n,e){var o,l,f=function(e){var i,f,d,v=null!==(i=p(l.i))&&void 0!==i?i:2===u.wn&&null;return null!==v&&e&&(e=e.filter(function(n){return n.incognito===v})),l.g&&o.length>0&&(f=t.getGroupId(o[0]),e&&(e=e.filter(function(n){return t.getGroupId(n)===f}))),e&&e.length>0?(d=e.filter(function(n){return n.windowId===u.vn}),void c(d.length>0?d:e)):(n.f&&a.runNextCmdBy(0,n.f)||(o.length<=0||l.w||2===u.wn&&!o[0].incognito?t.makeWindow({url:n.u,type:w(l.w),incognito:2===u.wn&&!t.re(n.u)},"",function(n){s(n&&n.tabs&&n.tabs.length>0?n.tabs[0]:null)}):t.openMultiTabs({url:n.u,index:r.newTabIndex(o[0],l.p,false,true),openerTabId:l.o&&o[0]?o[0].id:void 0,windowId:o[0].windowId,active:true},1,null,[null],l.g,o[0],s)),t.ae())},c=function(r){var e,i,o,l=n.u;n.p&&r.sort(function(n,r){return n.url.length-r.url.length}),(e=t.selectFrom(r)).url.length>r[0].url.length&&(e=r[0]),!l.startsWith(u.u._t)||u.Pn.get(e.id)||n.s?(i=u.zn?e.url.replace(/^edge:/,"chrome:"):e.url,o=u.zn?l.replace(/^edge:/,"chrome:"):l,t.tabsUpdate(e.id,{url:i.startsWith(o)?void 0:l,active:true},s),t.selectWndIfNeed(e)):(t.tabsCreate({url:l},s),t.ve.remove(e.id))},s=function(r){if(!r)return n.f&&a.runNextCmdBy(0,n.f),t.ae();a.runNextOnTabLoaded(n.f||{},r,n.s&&function(){d.hr.Kr(n,r)})},v=i.pe(n.u.split("#",1)[0]);r.du(v,e)||((null==(l=n.q||(n.q={})).g||v.startsWith(u.u._t))&&(l.g=false),l.m?T(n.u,null!=l.r&&r.parseReuse(l.r)||1,l.m,null,n):t.getCurTab(function(r){o=r;var u,e=w(l.w)||"normal";return!v.startsWith("file:")&&!v.startsWith("ftp")||v.includes(".",v.lastIndexOf("/")+1)||(u=v+(n.p?"/*":"/")),n.p&&(v+="*"),t.ve.query({url:u||v,windowType:e},function(n){return n&&n.length>0||!u?f(n):t.ve.query({url:v,windowType:e},f),t.ae()}),t.ae()}))},r.su=N});