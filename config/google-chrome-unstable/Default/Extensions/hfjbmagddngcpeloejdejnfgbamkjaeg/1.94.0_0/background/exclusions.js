"use strict";__filename="background/exclusions.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./settings","./ports"],function(n,t,o,u,r,i,e,l){var f,c,s,a,v,m,p,d,h,$;Object.defineProperty(t,"__esModule",{value:true}),t.Ft=t.St=t.Ht=t.ir=t.Bt=t.vr=t.lr=t.Gt=t.Jt=t.Kt=void 0,u=__importStar(u),e=__importStar(e),t.Kt=function(n,t){var o,r;return t=t&&t.replace(/<(\S+)>/g,"$1"),"^"===n[0]?(o=u.m(n.startsWith("^$|")?n.slice(3):n,"",0))||console.log("Failed in creating an RegExp from %o",n):"`"===n[0]&&((r=u.l(n.slice(1),0))||console.log("Failed in creating an URLPattern from %o",n)),o?{t:1,v:o,k:t}:r?{t:3,v:r,k:t}:{t:2,v:n.startsWith(":vimium://")?i.he(n.slice(10),false,-1):n.slice(1),k:t}},t.Jt=function(n){var t,o,r,e;return"^"===n[0]?(n=n.startsWith("^$|")?n.slice(3):n,t=".*$".includes(n.slice(-2))?n.endsWith(".*$")?3:n.endsWith(".*")?2:0:0,n=0!==t&&"\\"!==n[n.length-t]?n.slice(0,-t):n,(o=u.m(n,""))?{t:1,v:o}:null):"`"===n[0]?(r=u.l(n.slice(1)))?{t:3,v:r}:null:"localhost"===n||!n.includes("/")&&n.includes(".")&&(!/:(?!\d+$)/.test(n)||u.zt(n,6))?(n=(n=(n=n.toLowerCase()).endsWith("*")?n.slice(0,/^[^\\]\.\*$/.test(n.slice(-3))?-2:-1):n).startsWith(".*")&&!/[(\\[]/.test(n)?"*."+n.slice(2):n,e=void 0,(o=u.m("^https?://"+(n.startsWith("*")&&"."!==n[1]?"[^/]"+n:(e=n.replace(/\./g,"\\.")).startsWith("*")?e.replace("*\\.","(?:[^./]+\\.)*?"):e),"",0))?{t:1,v:o}:n.includes("*")?null:{t:2,v:"https://"+(n.startsWith(".")?n.slice(1):n)+"/"}):{t:2,v:(t=(n=(n=(":"===n[0]?n.slice(1):n).replace(/([\/?#])\*$/,"$1")).startsWith("vimium://")?i.he(n.slice(9),false,-1):n).indexOf("://"))>0&&n.indexOf("/",t+3)<0?n+"/":n}},t.Gt=function(n,t){return 1===n.t?n.v.test(t):2===n.t?t.startsWith(n.v):n.v.test(t)},t.lr=f=false,t.vr=c=false,a=[],v=function(n){if(0===n.length)return a=[],void t.Ft();a=n.map(function(n){return t.Kt(n.pattern,n.passKeys)}),t.Ft()},m=function(n){return(n?[t.Kt(n,"")]:a).map(function(n){return{t:n.t,v:1===n.t?n.v.source:2===n.t?n.v:{hash:n.v.hash,hostname:n.v.hostname,pathname:n.v.pathname,port:n.v.port,protocol:n.v.protocol,search:n.v.search}}})},t.Bt=m,p=function(n,r){var i,e,l,f,c="";for(e of a)if(1===e.t?e.v.test(n):2===e.t?n.startsWith(e.v):e.v.test(n)){if(0===(l=e.k).length||"^"===l[0]&&l.length>2||s)return l&&l.trim();c+=l}return!c&&r.or&&n.lastIndexOf("://",5)<0&&!u.Dt.test(n)&&null!=(f=null===(i=o.Pn.get(r.ur))||void 0===i?void 0:i.ar)?t.ir(f.s.Ae,f.s):c?c.trim():null},t.ir=p,d=function(){var n=r.ce()&&r.ce().onHistoryStateUpdated?function(n){o.fn[8](n)}:null;return d=function(){return n},n},t.Ht=function(){var n,t,o,r=u.Lt(),i=0;for(n of a)if(t=n.k){if("^"===t[0]&&t.length>2)return true;for(o of t.split(" "))r[o]=1,i++}return i?r:null},h=function(n){var u,r,i=a.length>0?null:{N:1,p:null,f:0};n?i||e.Qe({N:3,H:8}):(u=null!=o.On||void 0!==o.On&&e.Xe("showActionIcon"),r=a,l.eo(function(n){var r,e,l,f=n.cr.s.Wn,c=n.cr.s;for(r of n.oo){if(e=null,l=0,i){if(0===r.s.Wn)continue}else if(l=null===(e=t.ir(r.s.Ae,r.s))?0:e?1:2,!e&&r.s.Wn===l)continue;n.tr||(r.postMessage(i||{N:1,p:e,f:0}),r.s.Wn=l)}u&&f!==c.Wn&&o.R(c.ur,c.Wn)},function(){return r===a}))},t.St=h,$=function(){var n,o=a.length>0,u=d(),i=o&&e.Xe("exclusionListenHash");u&&(f!==o&&(t.lr=f=o,n=r.ce().onHistoryStateUpdated,o?n.addListener(u):n.removeListener(u),f&&(s=e.Xe("exclusionOnlyFirstMatch"))),c!==i&&(t.vr=c=i,n=r.ce().onReferenceFragmentUpdated,i?n.addListener(u):n.removeListener(u)))},t.Ft=$,e.Je.exclusionRules=function(n){var u=!a.length,r=o.mn;v(n),setTimeout(function(){setTimeout(t.St,10,u),o.mn===r&&e.We("keyMappings",null)},1)},e.Je.exclusionOnlyFirstMatch=function(n){s=n},e.Je.exclusionListenHash=t.Ft,"[]"!==e.Ze.getItem("exclusionRules")&&v(e.Xe("exclusionRules"))});