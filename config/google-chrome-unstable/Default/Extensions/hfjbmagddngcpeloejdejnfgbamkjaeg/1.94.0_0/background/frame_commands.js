"use strict";__filename="background/frame_commands.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./settings","./ports","./ui_css","./i18n","./key_mappings","./run_commands","./open_urls","./tools"],function(n,t,e,o,i,l,r,u,a,f,s,c,m,v){var d,p,g,h,_;Object.defineProperty(t,"__esModule",{value:true}),t.focusFrame=t.framesGoNext=t.toggleZoom=t.mainFrame=t.framesGoBack=t.openImgReq=t.captureTab=t.enterVisualMode=t.showVomnibar=t.initHelp=t.performFind=t.parentFrame=t.nextFrame=void 0,o=__importStar(o),r=__importStar(r),d=function(){var n,o=e.cPort,i=-1,l=e.Pn.get(o.s.ur),r=l&&l.oo;if(r&&r.length>1){for(i=r.indexOf(o),n=Math.abs(e.cRepeat);n>0;n--)(i+=e.cRepeat>0?1:-1)===r.length?i=0:i<0&&(i=r.length-1);o=r[i]}t.focusFrame(o,0===o.s.or,o!==e.cPort&&l&&o!==l.cr?3:2,e.get_cOptions())},t.nextFrame=d,p=function(){var n=e.cPort.s,o=n.ur>=0&&e.Pn.get(n.ur)?null:"Vimium C can not access frames in current tab";o&&u.showHUD(o),u.getParentFrame(n.ur,n.or,e.cRepeat).then(function(n){n?t.focusFrame(n,true,4,e.get_cOptions()):t.mainFrame()})},t.parentFrame=p,t.performFind=function(){var n=e.cPort.s,t=e.cRepeat<0?-e.cRepeat:e.cRepeat,o=e.get_cOptions().index,i=o?"other"===o?t+1:"count"===o?t:o>=0?-1-(0|o):0:0,l=!!i||!e.get_cOptions().active,r=null;32&n.fr||(n.fr|=32,r=a.ni(n)),c.sendFgCmd(1,true,c.wrapFallbackOptions({c:i>0?e.cRepeat/t:e.cRepeat,l:l,f:r,m:!!e.get_cOptions().highlight,n:!!e.get_cOptions().normalize,r:true===e.get_cOptions().returnToViewport,s:!i&&t<2&&!!e.get_cOptions().selected,p:!!e.get_cOptions().postOnEsc,e:!!e.get_cOptions().restart,q:e.get_cOptions().query?e.get_cOptions().query+"":l||e.get_cOptions().last?v.gr.Zr(n.sr,"",i<0?-i:i):""}))},t.initHelp=function(t,i){var l=e.Nn||[];Promise.all([new Promise(function(t,o){n([e.u.HelpDialogJS],t,o)}).then(__importStar),null!=l[0]?null:o.o("help_dialog.html"),null!=l[1]?null:f.getI18nJson("help_dialog"),null!=l[2]?null:f.getI18nJson("params.json")]).then(function(n){var o,l,u=n[0],a=n[1],f=n[2],m=n[3],v=t.w&&(null===(o=e.Pn.get(i.s.ur))||void 0===o?void 0:o.ar)||i,d=v.s.Ae.startsWith(e.u._t),p=t.a||{};v.s.fr|=64,e.set_cPort(v),l=e.Nn||e.Z([null,null,null]),a&&(l[0]=a),f&&(l[1]=f),m&&(l[2]=m),c.sendFgCmd(17,true,{h:u.mo(d),o:e.u._t,e:!!p.exitOnClick,c:r.Xe("showAdvancedCommands",true)||d&&!!s.na})},null)},t.showVomnibar=function(n){var t,i,l,r,u,a,f,s,m,v,d=e.cPort,p=e.get_cOptions().url;if(null!=p&&true!==p&&"string"!=typeof p&&(p=null,delete e.get_cOptions().url),!d){if(!(d=(null===(t=e.Pn.get(e.Cn))||void 0===t?void 0:t.ar)||null))return;e.set_cPort(d)}"bookmark"===e.get_cOptions().mode&&c.overrideOption("mode","bookm"),l=d.s.Ae,r=!(i=e.An.vomnibarPage_f).startsWith(e.u.ut),u=l.startsWith(e.u.ut),a=n||!i.startsWith(location.origin)?e.u.gt:i,f=(n=n||(r?u||i.startsWith("file:")&&!l.startsWith("file:///")||i.startsWith("http:")&&!/^http:/.test(l)&&!/^http:\/\/localhost[:/]/i.test(i):d.s.sr||u&&!i.startsWith(l.slice(0,l.indexOf("/",l.indexOf("://")+3)+1))))||i===a||d.s.ur<0,s=e.get_cOptions().trailingSlash,m=e.get_cOptions().trailing_slash,v=c.copyCmdOptions(o.qt({v:f?a:i,i:f?null:a,t:f?0:r?2:1,s:null!=s?!!s:null!=m?!!m:null,j:f?"":e.u.wt,e:!!e.get_cOptions().exitOnClick,k:o.n(true)}),e.get_cOptions()),c.portSendFgCmd(d,6,true,v,e.cRepeat),v.k="omni",e.set_cOptions(v)},t.enterVisualMode=function(){var n,t,o,i,l,r,u;t="string"==typeof(n=e.get_cOptions().mode)?n.toLowerCase():"",i=null,l="",r=null,u=null,16&~(o=e.cPort.s).fr&&(l=e.Rn,32&o.fr||(o.fr|=32,i=a.ni(o)),r=s.Vt,u=s.Wt,o.fr|=16),c.sendFgCmd(5,true,c.wrapFallbackOptions({m:"caret"===t?3:"line"===t?2:1,f:i,g:u,k:r,t:!!e.get_cOptions().richText,s:!!e.get_cOptions().start,w:l}))},t.captureTab=function(n,t){var o=e.get_cOptions().show,l=!e.get_cOptions().png?Math.min(Math.max(0|e.get_cOptions().jpeg,0),100):0,r=n&&n[0],u=r?r.id:e.Cn,a=r?r.windowId:e.vn,f=r?r.title:"";f="title"===e.get_cOptions().name||!f||u<0?f||""+u:u+"-"+f,f+=l>0?".jpg":".png",i.ve.captureVisibleTab(a,l>0?{format:"jpeg",quality:l}:{format:"png"},function(n){var l,r,u;if(!n)return t(0),i.ae();l=function(n){var l,a,s="string"!=typeof n?URL.createObjectURL(n):n;if(s.startsWith("blob:")&&(g&&(clearTimeout(g[0]),URL.revokeObjectURL(g[1])),g=[setTimeout(function(){g&&URL.revokeObjectURL(g[1]),g=null},o?5e3:3e4),s]),o)return r(s),void t(1);a=e.cPort&&(null===(l=e.Pn.get(e.cPort.s.ur))||void 0===l?void 0:l.ar)||e.cPort,i.downloadFile(s,f,a?a.s.Ae:null,function(n){n||u(s),t(n)})},r=function(n){e.fn[23]({o:"pixel=1&",u:n,f:f,a:false,r:-1,q:{r:e.get_cOptions().reuse,m:e.get_cOptions().replace,p:e.get_cOptions().position,w:e.get_cOptions().window}},e.cPort)},u=function(n){var t=document.createElement("a");t.href=n,t.download=f,t.target="_blank",t.click()},n.startsWith("data:")?fetch(n).then(function(n){return n.blob()}).then(l):l(n)})},t.openImgReq=function(n,t){var i,r,a,s,v,d,p,g,h,_,w=n.u;if(/^<svg[\s>]/i.test(w)){if(r=(new DOMParser).parseFromString(w,"image/svg+xml").firstElementChild)for(a of(r.removeAttribute("id"),r.removeAttribute("class"),[].slice.call(r.querySelectorAll("script,use"))))a.remove();if(!r||!r.lastElementChild)return e.set_cPort(t),void u.showHUD(f._r("invalidImg"));r.setAttribute("xmlns","http://www.w3.org/2000/svg"),w="data:image/svg+xml,"+encodeURIComponent(r.outerHTML),n.f=n.f||"SVG Image"}if(!o.xt(w))return e.set_cPort(t),void u.showHUD(f._r("invalidImg"));s=e.u.dt+"#!image ",n.f&&(s+="download="+o.k(n.f)+"&"),false!==n.a&&(s+="auto=once&"),n.o&&(s+=n.o),d=(v=n.q||o.Lt()).k,p=null!==(i=v.t)&&void 0!==i?i:!d,h=(g=v.s?e.P(w,32768,v.s):w)!==w,w=g,c.replaceCmdOptions({opener:true,reuse:null!=v.r?v.r:n.r,replace:v.m,position:v.p,window:v.w}),e.set_cRepeat(1),_=d||h?p?l.Ee(w,d,2):l.be(w.trim().split(o.Mt),d,2):w,m.openUrlWithActions("string"!=typeof _||!p||_.startsWith(location.protocol)&&!_.startsWith(location.origin)?_:s+_,9)},h=function(n,o,l){var r,a,s,v,d,p,g,h,_,w=!!i.ve.goBack;if(!w&&(l?i.getTabUrl(l):(o.s.or?e.Pn.get(o.s.ur).ar:o).s.Ae).startsWith(e.u.ut)&&true)return e.set_cPort(o),u.showHUD(f._r("noTabHistory")),void c.runNextCmd(0);if(r=c.hasFallbackOptions(n.o)?(c.replaceCmdOptions(n.o),c.getRunNextCmdBy(0)):i.ae,a=function(n,t){i.ve.executeScript(n.id,{code:"history.go("+t+")",runAt:"document_start"},r)},s=l?l.id:o.s.ur,v=n.s,d=m.parseReuse(n.o.reuse||0))p=n.o.position,i.ve.duplicate(s,function(e){var o,l,u;if(!e)return r();-2===d&&i.selectTab(s),w?((o=c.parseFallbackOptions(n.o)||{}).reuse=0,t.framesGoBack({s:v,o:o},null,e)):a(e,v),l=e.index--,null!=(u="end"===p?3e4:m.newTabIndex(e,p,false,true))&&u!==l&&i.ve.move(e.id,{index:u},i.ae)});else if(g=v>0?i.ve.goForward:i.ve.goBack,w||g)for(h=0,_=v>0?v:-v;h<_;h++)g(s,h?i.ae:r);else a(l,v)},t.framesGoBack=h,_=function(){var n=e.Pn.get(e.cPort?e.cPort.s.ur:e.Cn),o=n&&n.ar;o&&o===n.cr&&e.get_cOptions().$else&&"string"==typeof e.get_cOptions().$else?c.runNextCmd(0):o&&t.focusFrame(o,true,o===n.cr?2:4,e.get_cOptions())},t.mainFrame=_,t.toggleZoom=function(n){i.te(i.ve.getZoom).then(function(t){var o,l,r,u,a,f,s,c,m,v,d;if(t){if(o=e.cRepeat<-4?-e.cRepeat:e.cRepeat,(e.get_cOptions().in||e.get_cOptions().out)&&(o=0,e.set_cRepeat(e.get_cOptions().in?e.cRepeat:-e.cRepeat)),r=e.get_cOptions().level,u=Math,e.get_cOptions().reset)l=1;else if(null!=r&&!isNaN(+r)||o>4)a=u.max(.1,u.min(0|e.get_cOptions().min||.25,.9)),f=u.max(1.1,u.min(0|e.get_cOptions().min||5,100)),l=null==r||isNaN(+r)?o>1e3?1:o/(o>49?100:10):1+r*e.cRepeat,l=u.max(a,u.min(l,f));else{for(s=0,c=9,m=[.25,1/3,.5,2/3,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5],v=0,d=0;v<m.length&&(d=Math.abs(m[v]-t))<c;v++)s=v,c=d;l=m[s+e.cRepeat<0?0:u.min(s+e.cRepeat,m.length-1)]}Math.abs(l-t)>.005?i.ve.setZoom(l,i.ue(n)):n(0)}else n(0)})},t.framesGoNext=function(n,t){var o,i,l,r,u=e.get_cOptions().patterns,a=false;if(u&&u instanceof Array||(u=(u=u&&"string"==typeof u?u:(a=true,n?e.An.nextPatterns:e.An.previousPatterns)).split(",")),a||!e.get_cOptions().$fmt){for(i of(o=[],u))if((i=i&&(i+"").trim())&&o.push(".#[".includes(i[0])?i:i.toLowerCase()),200===o.length)break;u=o,a||(c.overrideOption("patterns",u),c.overrideOption("$fmt",1))}l=u.map(function(n){return Math.max(n.length+12,4*n.length)}),r=Math.max.apply(Math,l),c.sendFgCmd(10,true,c.wrapFallbackOptions({r:e.get_cOptions().noRel?"":t,n:n,exclude:e.get_cOptions().exclude,match:e.get_cOptions().match,evenIf:e.get_cOptions().evenIf,p:u,l:l,m:r>0&&r<99?r:32}))},t.focusFrame=function(n,t,o,i){n.postMessage({N:7,H:t?u.ensureInnerCSS(n.s):null,m:o,k:e.cKey,c:0,f:i&&c.parseFallbackOptions(i)||{}})}});