"use strict";__filename="background/run_keys.js",define(["require","exports","./store","./utils","./browser","./ports","./exclusions","./i18n","./key_mappings","./run_commands"],function(n,e,t,r,o,u,i,l,f,a){var s,c,p,v,y,d,k,b,_,m,g,$;Object.defineProperty(e,"__esModule",{value:true}),e.parseEmbeddedOptions=e.runKeyInSeq=e.parseKeySeq=e.runKeyWithCond=void 0,r=__importStar(r),s=Math.abs,c=["expect","keys","options","mask"],p=0,v=function(n){var e,t,o=r.Lt(),u=[],i="";for(e in n)e.includes("$")||(e.startsWith("o.")?e.length>2&&(o[i=e.slice(2)]=n[e]):c.includes(e)||u.push(e));for(t of u)o[i=t]=n[t];return i?o:null},y=function(n,l){var f,a,s,c,p,v,y=n.host,d=n.iframe,k=n.fullscreen,b=n.element;if(void 0===y&&(y=n.host=null!=n.url?n.url:null,delete n.url),"string"==typeof y&&(y=n.host=i.Jt(y)),null!=y){if(s=void 0,null!=(a=l.url)||2!==y.t||(s=y.v.indexOf("/",y.v.indexOf("://")+3))!==y.v.length-1&&-1!==s||(a=(c=(null===(f=t.Pn.get(t.cPort?t.cPort.s.ur:t.Cn))||void 0===f?void 0:f.ar)||t.cPort)?c.s.Ae:null),null==a&&(a=u.rr(null,true))instanceof Promise)return a.then(function(n){var r;l.url=n||(t.cPort?((null===(r=t.Pn.get(t.cPort.s.ur))||void 0===r?void 0:r.ar)||t.cPort).s.Ae:""),e.runKeyWithCond(l)}),0;if(!i.Gt(y,a))return 1}if(null!=d){if(!t.cPort&&false!==d)return 1;if("string"==typeof d&&(d=n.iframe=i.Jt(d)||true),"boolean"==typeof d){if(d!==!!(t.cPort&&t.cPort.s.or))return 1}else if(!i.Gt(d,t.cPort.s.Ae))return 1}if(null==k);else{if(null==l.fullscreen)return o.getCurWnd(false,function(n){return l.fullscreen=!!n&&n.state.includes("fullscreen"),e.runKeyWithCond(l),o.ae()}),0;if(!!k!==l.fullscreen)return 1}if(b&&"*"!==b&&(p="string"==typeof b?[]:b,"string"==typeof b&&(n.element=b.split(",").some(function(n){var e=(n="*"===n[0]?n.slice(1):n).indexOf("#"),t=n.indexOf("."),o=n.length;return n&&p.push({tag:n.slice(0,e<0?t<0?o:t:t<0?e:Math.min(t,e)),id:e>=0?n.slice(e+1,t>e?t:o):"",classList:r.g(t>=0?n.slice(t+1,e>t?e:o):"")}),"*"===n||n.includes(" ")})?(p.length=0,"*"):p),v=l.element,p.length)){if(null==v)return t.cPort&&u.safePost(t.cPort,{N:14,n:performance.now(),c:l}),t.cPort?0:1;if(!p.some(function(n){return 0===v?"body"===n.tag&&!n.id&&!n.classList:(!n.tag||v[0]===n.tag)&&(!n.id||v[1]===n.id)&&(!n.classList.length||v[2].length>0&&n.classList.every(function(n){return v[2].includes(n)}))}))return 1}return 2},d=function(n){var e,t,r,o=n.expect;return n.$normalized?o:(e=function(n){return n?"string"==typeof n?n.trim().split(/[, ]+/):n instanceof Array?n:[]:[]},t=[],o&&(o instanceof Array?t=o.map(function(n){return n instanceof Array?{env:n[0],keys:e(n[1]),options:n[2]}:n&&"object"==typeof n?{env:n.env||n,keys:e(n.keys),options:n.options}:null}):"object"==typeof o?t=Object.keys(o).map(function(n){var t=o[n],r=t&&"object"==typeof t&&!(t instanceof Array);return{env:n,keys:e(r?t.keys:t),options:r?t.options:null}}):"string"==typeof o&&/^[^{].*?[:=]/.test(o)&&(r=o.includes(":")?/:/:/=/,t=o.split(o.includes(";")?/[;\s]+/g:/[,\s]+/g).map(function(n){return n.split(r)}).map(function(n){return 2!==n.length?null:{env:n[0],keys:e(n[1]),options:null}}))),t=t.map(function(n){return n&&n.env&&"__proto__"!==n.env&&n.keys.length?n:null}),a.overrideOption("expect",t,n),a.overrideOption("keys",e(n.keys),n),a.overrideOption("$normalized",true,n),t)},k=function(n){var o,i,l,k,b,_,g,$,j,h,z,w,A,x,N,O,T,M,q,I,K=s(t.cRepeat),S=t.Pn.get(t.cPort?t.cPort.s.ur:t.Cn);for(l of(t.cPort||t.set_cPort(S?S.cr:null),n=n||t.get_cEnv()||{},t.set_cEnv(null),i=d(t.get_cOptions())))if(l){if("string"==typeof(b=k=l.env)){if(!f.oa)return void u.showHUD("No environments have been declared");if(void 0===(b=f.oa.get(b)))return void u.showHUD('No environment named "'+k+'"');if("string"==typeof b&&(b=f.ea(b,2),f.oa.set(k,b)),null===b)continue}if(0===(_=y(b,n)))return;if(2===_){o=l;break}}if(g=o?o.keys:t.get_cOptions().keys,z=o?"string"==typeof o.env?"["+o.env+"]: ":"("+i.indexOf(o)+")":"",0===g.length)u.showHUD(z+"Require keys: comma-seperated-string | string[]");else if(K>g.length&&1!==g.length)u.showHUD(z+"Has no such a key");else if(($=g[h=1===g.length?0:t.cRepeat>0?K-1:g.length-K])&&("string"==typeof $||"object"==typeof $&&$.tree&&"object"==typeof $.tree&&"number"==typeof $.tree.t)){if(w=void 0,"string"==typeof $){if(null!=(A=t.get_cOptions().mask)){if(!(x=a.fillOptionWithMask($,A,"",c)).ok)return void u.showHUD((x.result?"Too many potential keys":"No key")+" to fill masks");A=x.ok>0,$=x.result}w=(N=$.startsWith("#")?$.split("+",1)[0]:"").length>1?e.parseEmbeddedOptions(N.slice(1)):null,j=e.parseKeySeq($.slice(N?N.length+1:0)),$={tree:j,options:w},A||(g[h]=$)}else j=$.tree,w=$.options;if(O=1===g.length?t.cRepeat:1,T=o&&o.options||t.get_cOptions().options||(t.get_cOptions().$masked?null:v(t.get_cOptions())),T=w&&T?a.copyCmdOptions(a.copyCmdOptions(r.Lt(),w),T):T||w,3===j.t)return void u.showHUD(j.val);if(0===j.val.length)return;M=p=(p+1)%64||1,q="<v-runkey:$1>".replace("$1",""+M),j.val.length>1||0!==j.val[0].t?(I={$seq:{keys:j,repeat:O,options:T,cursor:j,timeout:0,id:q,fallback:a.parseFallbackOptions(t.get_cOptions())},$then:q,$else:"-"+q,$retry:-999},a.replaceCmdOptions(I),t.sn.set(q,f.Yt("runKey",I)),e.runKeyInSeq(I.$seq,1,null,n)):m(j.val[0],{keys:j,repeat:O,options:T,cursor:j,timeout:0,id:q,fallback:null},n)}else u.showHUD(z+"The key is invalid")},e.runKeyWithCond=k,e.parseKeySeq=function(n){var e,t,o,u,i,l,f=/^([$%][a-z]\+?)*([\d-]\d*\+?)?([$%][a-z]\+?)*(<([a-z]-){0,4}\w+(:i)?>|[A-Z_a-z]\w*(\.\w+)?)(#[^()?:+]*)?/,a={t:1,val:[],par:null},s=a;for(t=n.length>1?0:n.length;t<n.length;t++)switch(n[t]){case"(":(e=a).val.push(a={t:1,val:[],par:a});break;case")":e=a;do{e=e.par}while(2===e.t);a=e;break;case"?":case":":for(e="?"===n[t]?null:a;e&&2!==e.t;)e=e.par;e&&!e.val.f||(a.par={t:2,val:{cond:a,t:null,f:null},par:(e=a.par)||(s={t:1,val:[],par:null})},e?1===e.t?e.val.splice(e.val.indexOf(a),1,a.par):e.val.t===a?e.val.t=a.par:e.val.f=a.par:s.val.push(a.par),e=a.par),a={t:1,val:[],par:e},"?"===n[t]?e.val.t=a:e.val.f=a;break;case"+":break;default:for(;t<n.length&&!"()?:+".includes(n[t]);){if(!(o=f.exec(n.slice(t))))return{t:3,val:"Invalid key item: "+((u=n.slice(t)).length>16?u.slice(0,15)+"\u2026":u),par:null};(l=(i=o[0]).indexOf("#"))>0&&/[#&]#/.test(i.slice(l))&&(i=n.slice(t)),a.val.push({t:0,val:i,par:a}),t+=i.length}t--}return 1===n.length&&s.val.push({t:0,val:n,par:s}),r.$t(),s},b=function(n,e){var t,r,o=true,u=n;for(0===u.t&&(u=(r=(t=u.par).val.indexOf(u))<t.val.length-1&&e>0?t.val[r+1]:(o=false,t));u&&0!==u.t;)if(o&&1===u.t&&u.val.length>0)u=u.val[0];else if(o&&2===u.t)u=u.val.cond;else{if(!u.par){u=null;break}1===u.par.t?((o=(r=(t=u.par).val.indexOf(u))<t.val.length-1)&&e<0&&(e=1),u=o?t.val[r+1]:t):u=(o=u===(t=u.par).val.cond)&&(e>0?t.val.t:(e=1,t.val.f))||(o=false,t)}return u},e.runKeyInSeq=function(n,e,r,o){var i,f=b(n.cursor,e),s=!f||!(b(f,1)||b(f,-1)),c=n.fallback,v=n.id;if(s&&(t.sn.delete(v),clearTimeout(n.timeout||0),"<v-runkey:$1>".replace("$1",""+p)==v&&(p=Math.max(--p,0)),f&&(delete t.get_cOptions().$then,delete t.get_cOptions().$else,c&&(n.options=n.options?Object.assign(c,n.options):c))),f)i=s?0:n.timeout=setTimeout(function(){var n=t.sn.get(v),e=n&&n.ra;e&&e.$seq&&e.$seq.timeout===i&&t.sn.delete(v)},3e4),m(f,n,o);else{if(c&&(c.$f?c.$f.t=r&&r.t||c.$f.t:c.$f=r,a.runNextCmdBy(e>0?1:0,c,1)))return;e<0&&r&&r.t&&u.showHUD(l._r(""+r.t))}},_=function(n){var t,r,o,u,i,l,f,a,s=n.val;return"string"!=typeof s?s:(r=!!(t=/^([$%][a-zA-Z]\+?|-)+/.exec(s))&&t[0].includes("-"),o=!t||"+-".includes(t[0].slice(-1)),u=t?t[0].replace(/[+-]/g,"").replace(/%/g,"$"):"",s=t?s.slice(t[0].length):s,i=(r?-1:1)*((t=/^\d+/.exec(s))&&parseInt(t[0],10)||1),s=t?s.slice(t[0].length):s,f=(l=(s=o||t||!s.startsWith("+")?s:s.slice(1)).indexOf("#",1))>0?s.slice(0,l):s,a=null,l>0&&l+1<s.length&&(s=s.slice(l+1),a=e.parseEmbeddedOptions(s)),n.val={prefix:u,count:i,key:"__proto__"!==f?f:"<v-__proto__>",options:a})},e.parseEmbeddedOptions=function(n){var e,t,o=/(^|&)#/.exec(n),u=o?n.slice(o.index+o[0].length):"",i=function(n){return"\\u"+(n.charCodeAt(0)+65536).toString(16).slice(1)},l=function(n){return/\s/.test(n)?JSON.stringify(n).replace(/\s/g,i):n};return n=(o?n.slice(0,o.index):n).split("&").map(function(n){var e=n.split("=",1)[0],t=n.slice(e.length);return e+(t?"="+l(r.jt(t.slice(1))):"")}).join(" "),u&&(n=(n?n+" ":"")+(e=u.split("=",1)[0])+((t=u.slice(e.length))?"="+l(t.slice(1)):"")),f.ea(n,2)},m=function(n,e,t){var o=_(n),u=e.cursor===e.keys,i=u||o.prefix.includes("$c"),l=e.options&&o.options?a.copyCmdOptions(a.copyCmdOptions(r.Lt(),o.options),e.options):e.options||o.options;e.cursor=n,$(o.key,o.count*(i?e.repeat:1),l,t,null,u)},t.D(function(n,e,r){var o,u,i,l=/^\d+|^-\d*/.exec(n),f=1;for(null!=l&&(n=n.slice((o=l[0]).length),f="-"!==o?parseInt(o,10)||1:-1),u=1;(u=n.indexOf("#",u)+1)&&(i=n.slice(0,u-1),!t.sn.has(i)&&!/^[a-z]+(\.[a-z]+)?$/i.test(i)););t.set_cPort(e),t.set_cKey(0),t.set_cOptions(null),$(u?n.slice(0,u-1):n,f,u?n.slice(u):null,null,r)}),g=function(n){for(var e=t.get_cOptions();e&&e!==n;)e=e.$o;return e===n},$=function(n,o,i,l,s,c){var p,v,y,d,k,b=n,_="__proto__"!==n&&t.sn.get(n)||!n.includes("<")&&t.sn.get(b="<v-"+n+">")||null,m=true;null==_&&n in f.Qt&&(m=false,_=f.Yt(n,null)),null!=_?36===_.ma&&_.pa&&_.ra&&"object"==typeof _.ra&&g(_.ra)?u.showHUD('"runKey" should not call itself'):("string"==typeof i&&(i=i?e.parseEmbeddedOptions(i):null),v=(p=t.get_cOptions())&&a.parseFallbackOptions(p),y=p&&p.$f,(i&&"object"==typeof i||v||y)&&(d=f.Xt(_),_=m?Object.assign({},_):_,k=r.Lt(),i&&a.copyCmdOptions(k,r.qt(i)),v&&a.copyCmdOptions(k,r.qt(v)),d&&a.copyCmdOptions(k,d),k.$f=y,i&&"$count"in i?k.$count=i.$count:d&&"$count"in d&&(i&&"count"in i||(k.$count=d.$count)),_.ra=k,2!==_.ma||_.pa||(_.da=0),f.Zt(_)),r.$t(),c&&36===_.ma&&_.pa?setTimeout(function(){t.set_cEnv(l),a.executeCommand(_,o,t.cKey,t.cPort,0,s)},0):(t.set_cEnv(l),a.executeCommand(_,o,t.cKey,t.cPort,0,s))):u.showHUD('"'+(/^\w+$/.test(n)?b:n)+'" has not been mapped')}});