"use strict";__filename="background/filter_tabs.js",define(["require","exports","./store","./utils","./browser","./ports","./exclusions"],function(n,u,r,e,l,t,i){var a,o,c;Object.defineProperty(u,"__esModule",{value:true}),u.vu=u.hu=u.bu=u.mayRequireActiveTab=u.getNecessaryCurTabInfo=u.mu=u.getNearTabInd=u.gu=u.ku=u.getTabRange=void 0,e=__importStar(e),i=__importStar(i),u.getTabRange=function(n,u,e,l){var t,i=r.cRepeat,a=i>0;return l&&(i+=a?l:-l),(t=n+i)<=u&&t>-2?a?[n,t]:[t+1,n+1]:!r.get_cOptions().limited&&(Math.abs(i)<2*(e||u)||i<10)?Math.abs(i)<u?a?[u-i,u]:[0,-i]:[0,u]:a?[n,u]:[0,n+1]},a=function(n,e,t,i,a,o){var c=function(i){var o,c,f,s;if(!i||!i.length)return a(0),l.ae();o=l.selectFrom(i).index,f=(c=u.getTabRange(o,i.length,0,e))[0],s=c[1],t(i,n?[f,o,s]:[o+1===s||r.cRepeat>0&&f!==o?f:s-1,o,s],a)};i?0===i.length?l.getCurWnd(true,function(n){c(n?n.tabs:[])}):Math.abs(r.cRepeat)>1?c(i):e?i[0].index+r.cRepeat<0?l.fe(c):l.ve.query({windowId:i[0].windowId,index:i[0].index+r.cRepeat},function(n){return n&&n.length&&(true===o||l.le(n[0])&&(!o||o(n[0])))?t(n,[0,0,1],a):l.fe(c),l.ae()}):t(i,[0,0,1],a):a(0)},u.ku=a,u.gu=function(){var n=0,u=-1;return r.jn.forEach(function(e,l){e.i>n&&l!==r.Cn&&(n=e.i,u=l)}),u},u.getNearTabInd=function(n,u,r){var e,l;for(e=n.length>1?0:1;e<n.length;e++)if((l=n[e].index)>u||l===u)return r||l===u?e:e>0?e-1:0;return n.length-1},u.mu=function(n,u){1===Math.abs(n)?l.getCurTab(function(r){var e=r[0].index+n;e>=0?l.ve.query({windowId:r[0].windowId,index:e},function(e){return e?u(n>0?[r[0],e[0]]:[e[0],r[0]]):l.getCurTabs(u),l.ae()}):l.getCurTabs(u)}):l.getCurTabs(u)},o=function(n){if(!n)return null;var r=u.mayRequireActiveTab(n);return r>2?l.te(l.getCurTab).then(function(n){return n&&n[0]||null}):r?Promise.resolve(t.rr(null,r>1)).then(function(n){return n?{url:n}:null}):null},u.getNecessaryCurTabInfo=o,u.mayRequireActiveTab=function(n){var u,r,e,l,t=0;for(u of(n+"").split(/[&+]/)){if(e=(r=u.split("=",1)[0]).includes(".")?"":r||u,l=u.slice(e?e.length+1:0),e&&"same"===l&&"hidden"!==e)return 3;if(!l&&e){if(e.startsWith("title")||"group"===e)return 3;t="hash"===e?2:t||("host"===e||"url"===e?1:0)}}return t},c=function(n,u){return""===(n=n&&n.toLowerCase())||"1"===n||"true"===n?!u||null:"only"===n||"0"!==n&&"false"!==n&&null},u.bu=function(n,u,r){var e=n?(n+"").split(/[&+]/).find(function(n){return n.startsWith(u)}):null,l=e?e.slice(1+u.length):null;return null!==l?c(l,r):null},u.hu=function(n,u,r,a){var o,f,s,d,v,h,b,m,g,k,p,_=false,w=null,x=null,M=null,j=null,y=0,I=null,S=null;for(h of(r+"").split(/[&+]/))switch(m=(b=h.split("=",1)[0]).includes(".")?"":b||h,k=(g=h.slice(m?m.length+1:0))&&e.jt(g),y++,m){case"title":case"title*":f=k||n&&n.title||void 0;break;case"url":case"hash":"url"===m&&k?s=i.Jt(k):(p=n?l.getTabUrl(n):null,_=_||"hash"===m,s=p?i.Jt(":"+(_?p:p.split("#",1)[0])):null);break;case"host":case"":d=k||(m&&n?null===(o=e.xt(l.getTabUrl(n)))||void 0===o?void 0:o.host:"");break;case"group":v=k||(n?null!=l.getGroupId(n)?l.getGroupId(n)+"":null:void 0);break;case"hidden":w=null;break;case"highlight":case"highlighted":S="same"==k?n?n.highlighted:null:c(k);break;case"incognito":case"incognito":I="same"==k?n?n.incognito:null:c(k);break;case"pinned":j="same"==k?n?n.pinned:null:c(k,1);break;case"mute":case"muted":x="same"==k?n?l.isTabMuted(n):null:c(k);break;case"audible":case"audio":M="same"==k?n?n.audible:null:c(k);break;default:y--}return a&&(a.known=y>0),0===y?u.slice(0):(u=u.filter(function(n){var u,r;return(!f||(n.title||"").includes(f))&&(!s||i.Gt(s,l.getTabUrl(n)))&&(!d||d===(null===(u=e.xt(l.getTabUrl(n)))||void 0===u?void 0:u.host))&&(null===w||w!==l.le(n))&&(null===j||j===n.pinned)&&(null===x||x===l.isTabMuted(n))&&(null===M||M===n.audible)&&(null===S||S===n.highlighted)&&(null===I||S===n.incognito)&&(void 0===v||v===(null!==(r=l.getGroupId(n))&&void 0!==r?r:"")+"")}),u.length||t.showHUD("No tabs matched the filter parameter"),u)},u.vu=function(n,u){var e,t,i=function(n,u){n.index=u},a=function(n,u){return n<u?-1:n>u?1:0},o=n.map(function(n,u){return{tab:n,index:u,time:null,rhost:null,group:l.getGroupId(n)}}),c=-1,f=false;for(t of(u instanceof Array?u.slice(0):(true===u?"time":u+"").split(/[, ]+/g)).reverse())e="r"===t[0]?-1:1,t.includes("time")&&!t.includes("creat")||t.includes("recen")?(null==o[0].time&&o.forEach(function(n){var u=n.tab.id,e=r.jn.get(u);n.time=u===r.Cn?1:null!=e?2047-e.i:u+2}),e="r"===t[0]&&"e"!==t[1]?-1:1,c=1):t.endsWith("host")||t.endsWith("url")?(o[0].rhost||o.forEach(function(n){var u,r,e,l=n.tab.url,t=l.indexOf("://")+3,i=t>3?l.indexOf("/",t):0;i<t?n.rhost=l:(e=(r=(u=l.slice(t,i)).lastIndexOf(":"))>0&&u.lastIndexOf(":",r-1)>0,n.rhost=e?u:u.slice(0,r>0?r:u.length).split(".").reverse().join(".")+(r>0?" "+u.slice(1):""))}),c=t.includes("url")?3:2):c="title"===t?4:t.includes("creat")||"id"===t?5:t.includes("window")?6:t.includes("index")||"reverse"===t?7:-1,c<0||(o.sort(function(n,u){return(1===c?n.time-u.time:c<4?a(n.rhost,u.rhost)||(3===c?a(n.tab.url,u.tab.url):0):4===c?a(n.tab.title,u.tab.title):5===c?n.tab.id-u.tab.id:6===c?n.tab.windowId-u.tab.windowId:n.index-u.index)*e||n.index-u.index}),o.forEach(i),f=true);return f&&o.some(function(n){return null!=n.group})&&o.sort(function(n,u){return null==n.group?null==u.group?n.index-u.index:1:null==u.group||n.group<u.group?-1:n.group>u.group?1:n.index-u.index}),f?o.map(function(n){return n.tab}):n}});