"use strict";__filename="background/request_handlers.js",define(["require","exports","./store","./utils","./browser","./parse_urls","./settings","./ports","./exclusions","./ui_css","./i18n","./key_mappings","./run_commands","./run_keys","./open_urls","./frame_commands","./tools"],function(n,r,t,u,e,o,i,f,l,s,a,c,v,d,m,p,b){var _,g,y;Object.defineProperty(r,"__esModule",{value:true}),u=__importStar(u),i=__importStar(i),_=-1,t.y([function(n,r){var u,e,o=n.k,l=i.Ge;if(!(o>=0&&o<l.length))return t.set_cPort(r),f.complainLimits(a._r("notModify",[o]));u=l[o],e=t.N&&t.N(),i.Xe(u)!==n.v&&(e?e.then(function(){i.Ve(u,n.v)}):i.Ve(u,n.v))},function(n,r){var t="object"==typeof n;return b.gr.Zr(r.s.sr,t?n.q:"",t?1:n)},function(n,r){var t=o.He(n);if(null==n.i)return t;r.postMessage({N:44,i:n.i,s:t})},function(n,r){var i=n.u,l=n.e,s=o.qe(n);u.$t(),n.e=s,null==s.p?(t.set_cPort(r),f.showHUD(s.u)):l||i!==s.u?r?v.sendFgCmd(0,false,{r:1,url:s.u}):e.tabsUpdate({url:s.u}):(t.set_cPort(r),f.showHUD("Here is just root"),n.e={p:null,u:"(just root)"})},function(n,r){var u,e,i=o.He(n);if(!i||!i.k)return t.set_cPort(r),f.showHUD(a._r("noEngineFound")),void(n.n&&v.runNextCmdBy(0,n.n));e=n.o||{},u=n.t.trim()&&t.P(n.t.trim(),524288,e.s).trim()||(n.c?t.V(e.s):""),Promise.resolve(u).then(function(u){var o=null===u?"It's not allowed to read clipboard":(u=u.trim())?"":a._r("noSelOrCopied");if(o)return t.set_cPort(r),f.showHUD(o),void(n.n&&v.runNextCmdBy(0,n.n));e.k=null==e.k?i.k:e.k,t.fn[6]({u:u,o:e,r:0,n:v.parseFallbackOptions(n.n)||{}},r)})},function(n,r){var u,o=n.s,i=false!==n.a;t.set_cPort(f.findCPort(r)),"number"!=typeof o?e.se()?(e.se().restore(o[1],function(){var n=e.ae();return n&&f.showHUD(a._r("noSessionItem")),n}),i||((u=r.s.ur)>=0||(u=t.Cn),u>=0&&e.selectTab(u))):f.complainNoSession():e.selectTab(o,function(n){return e.ae()?f.showHUD(a._r("noTabItem")):e.selectWnd(n),e.ae()})},m.openUrlReq,function(n,r){var u,e,o,i;(e=t.Pn.get(u=r.s.ur))?r!==(i=e.cr)&&(e.cr=r,t.xn&&(o=r.s.Wn)!==i.s.Wn&&t.R(u,o)):t.xn&&t.R(u,r.s.Wn)},function(n,r){var u,e,o,i,s,a,c=r;if((c||(c=f.indexFrame(n.tabId,n.frameId)))&&(e=(u=c.s).Ae,o=n.url,!(i=t.Pn.get(u.ur))||!i.tr)){if(s=l.lr?l.ir(u.Ae=r?n.u:o,u):null,u.Wn!==(a=null===s?0:s?1:2))u.Wn=a,t.xn&&i.cr===c&&t.R(u.ur,a);else if(!s||s===l.ir(e,u))return;c.postMessage({N:1,p:s,f:0})}},function(n,r){var u,e=n.t||0;t.set_cPort(r),t.set_cRepeat(e||t.cRepeat>0?1:-1),t.set_cKey(n.k),v.replaceCmdOptions(n.f||{}),2!==e?1===e?p.parentFrame():p.nextFrame():(u=t.Pn.get(r.s.ur))?p.focusFrame(u.cr,u.oo.length<=2,1,t.get_cOptions()):f.safePost(r,{N:45,l:t.cKey})},function(n,r){var u,e,o,i=t.Pn.get(r.s.ur);if(i&&(r.s.fr|=4,i.fr|=4,!(i.oo.length<2)))for(e of(u={N:8},i.oo))o=e.s.fr,e.s.fr|=4,4&o||e.postMessage(u)},function(n,r,u){var o,i,l=r.s.ur,s=t.Pn.get(l),a=n.u;if(!s||s.oo.length<2)return false;for(i of s.oo)if(i.s.Ae===a){if(o){o=null;break}o=i}return o?(t.set_cKey(n.k),y(n,r,o,1),true):!!e.ce()&&(e.ce().getAllFrames({tabId:r.s.ur},function(e){var o,i,s=0,a=r.s.or;for(o of e)if(o.parentFrameId===a){if(s){s=0;break}s=o.frameId}(i=s&&f.indexFrame(l,s))&&(t.set_cKey(n.k),y(n,r,i,1)),f.sendResponse(r,u,!!i)}),r)},p.initHelp,function(n,r){t.Pn.get(r.s.ur).fr|=4,r.s.fr|=12,r.postMessage({N:12,H:t.Dn})},function(n,r){var e=n.i;if(t.set_cKey(0),null!=n.c)v.replaceCmdOptions({url:n.u,newtab:n.n,keyword:n.o.k}),t.set_cRepeat(1);else{if(true!==n.r)return;if(null==t.get_cOptions()||"omni"!==t.get_cOptions().k){if(e)return;t.set_cOptions(u.Lt()),t.set_cRepeat(1)}else if(e&&t.get_cOptions().v===t.u.gt)return}t.set_cPort(r),p.showVomnibar(e)},function(n,r){f.isNotVomnibarPage(r,false)||t.x.pu(n.q,n,g.bind(r,0|n.i))},function(n,r){var e,o=n.u||n.s;if(n.d)if("string"!=typeof o)for(e=o.length;0<=--e;)o[e]=u.yt(o[e]+"");else o=u.yt(o);else"string"==typeof o&&o.length<4&&o.trim()&&" "===o[0]&&(o="");o=o&&t.I(o,n.j,n.e),t.set_cPort(r),o=n.s&&"object"==typeof n.s?"["+n.s.length+"] "+n.s.slice(-1)[0]:o,f.showHUD(n.d?o.replace(/%[0-7][\dA-Fa-f]/g,decodeURIComponent):o,n.u?14:15)},function(n,r){var e,o,i,f,l,s,a=null!=r?r.s:null;null===a||4&a.fr||(a.fr|=4,(e=t.Pn.get(a.ur))&&(e.fr|=4)),i=1,null!=(f=/^\d+|^-\d*/.exec(o=n.k))&&(o=o.slice((l=f[0]).length),i="-"!==l?parseInt(l,10)||1:-1),(s=t.sn.get(o))||(f=o.match(c.ia),i=1,s=t.sn.get(o=f[f.length-1])),u.$t(),s&&(n.e&&t.set_cEnv({element:u.d(n.e)}),v.executeCommand(s,i,n.l,r,0,null))},v.waitAndRunKeyReq,function(n,r){switch(t.set_cPort(r),n.a){case 1:return b.hr.Pr(n,r);case 0:return b.hr.Dr(n,r);case 2:return b.hr.xr(n.u);default:return}},m.su,v.onConfirmResponse,function(n,r){var u,o,i=n.t,l=n.s,s=n.u,c="history"===i&&null!=l?"session":i,v="tab"===c?c:c+" item",d=function(n){f.showHUD(a._r(n?"delSug":"notDelSug",[a.$r("sugs",c[0])||v]))};t.set_cPort(f.findCPort(r)),"tab"===c&&t.Cn===l?f.showHUD(a._r("notRemoveCur")):"session"!==c?t.x._u("tab"===c?l:s,c,d):(null===(u=e.se())||void 0===u?void 0:u.forgetClosedTab)&&(o=l,e.se().forgetClosedTab(o[0],o[1]).then(function(){return 1},t.B).then(d))},p.openImgReq,function(n,r){t.set_cPort(null),m.openJSUrl(n.u,{},function(){t.set_cPort(r),f.showHUD(a._r("jsFail"))})},function(n,r){var u;2!==n.c&&4!==n.c?y(n,r,(null===(u=t.Pn.get(r.s.ur))||void 0===u?void 0:u.ar)||null,n.f):f.getParentFrame(r.s.ur,r.s.or,1).then(function(u){var e;y(n,r,u||(null===(e=t.Pn.get(r.s.ur))||void 0===e?void 0:e.ar)||null,n.f)})},s.ii,function(n,r){v.replaceCmdOptions({active:true,returnToViewport:true}),t.set_cPort(r),t.set_cRepeat(1),p.performFind()},p.framesGoBack,function(){return a.jr&&a.jr(),a.br},function(n,r){r.s.fr|=8},function(n,r){v.replaceCmdOptions({mode:n.c?"caret":"",start:true}),t.set_cPort(r),t.set_cRepeat(1),p.enterVisualMode()},function(n){if(performance.now()-n.r.n<500){var r=n.r.c;r.element=u.d(n.e),d.runKeyWithCond(r)}},function(n,r){e.downloadFile(n.u,n.f,n.r,n.m?function(u){u||t.fn[23]({r:-1,f:n.f,u:n.u},r)}:null)},function(n,r,t){return setTimeout(function(){f.sendResponse(r,t,0)},n),r},function(n,r){var u=r.s.ur,e=t.Pn.get(u>=0?u:t.Cn);t.fn[17](n,e?e.cr:null)}]),g=function(n,r,e,o,i,l,s,a){var c,v,d,m,p,b=this.s.Ae,g=2===n?2:0;if(1===n&&t.Un>=58)if(b=b.slice(0,b.indexOf("/",b.indexOf("://")+3)+1),null!=(m=-1!==_?null===(c=t.Pn.get(_))||void 0===c?void 0:c.ar:null)&&(m.s.Ae.startsWith(b)?g=1:_=-1),g);else for(p of t.Pn.values())if((d=(v=p.ar)&&v.s)&&d.Ae.startsWith(b)){g=1,_=d.ur;break}f.safePost(this,{N:43,a:e,c:a,i:g,l:r,m:o,r:s,s:i,t:l}),u.$t()},y=function(n,r,u,e){u&&2!==u.s.Wn?u.postMessage({N:7,H:e||4!==n.c?f.ensureInnerCSS(r.s):null,m:e?4:0,k:e?t.cKey:0,f:{},c:n.c,n:n.n||0,a:n.a}):(n.a.$forced=1,v.portSendFgCmd(r,n.c,false,n.a,n.n||0))}});