"use strict";__filename="background/parse_urls.js",define(["require","exports","./store","./utils","./normalize_urls"],function(e,r,u,n,t){var i,l,f,a,s,o;Object.defineProperty(r,"__esModule",{value:true}),r.ke=r.Re=r.je=r.Me=r.Ue=r.qe=r.He=void 0,n=__importStar(n),i=function(e){var i,l,f,a,s,o,p=e.u,c=p.toLowerCase(),g=null,m=false;if(!n.Dt.test(t.ge(c)))return n.$t(),null;if(e.p)return{k:"",s:0,u:null!=(f=r.qe(e)).p?f.u:p,e:null!=f.p?f.p:f.u};for(a=u.An.searchEngineRules,(l=n.v(c))&&(c=c.slice(l),p=p.slice(l)),l=a.length;0<=--l&&(!c.startsWith((i=a[l]).Oe)||!(g=p.slice(i.Oe.length).match(i.Te))););if(!g||!i)return c.startsWith(s=u.u.dt)?{k:"vimium://show",u:p=p.slice(s.length).replace(/^#!?/,""),s:p.startsWith("image")&&p.lastIndexOf("&",p.indexOf(":")+1)+1||p.indexOf(" ")+1}:(n.$t(),null);for(g.length>1&&!i.Te.global&&g.shift(),o=i.Be,g.length>1?m=true:o instanceof RegExp?(g=(c=g[0]).match(o))?(g.shift(),m=true):g=[c]:g=g[0].split(o),c="",l=0;l<g.length;l++)c+=" "+n.jt(g[l]);return c=c.trim().replace(n.Mt," "),n.$t(),{k:i.De,u:c,s:m?c.lastIndexOf(" ")+1:0}},r.He=i,r.qe=function(e){var r,i,f,a,s,o,p,c,g,m,_,v,$,h,d,b,w,x,k,z,R,j=e.u,E=j.toLowerCase();if(1===e.p&&(r=u.P(j,131072,e.s))!==j&&r&&r!==j+"/"&&r+"/"!==j&&(i=t.Ee(r,null,-2),0===t._e))return{u:i,p:"(sed)"};if(!n.Dt.test(t.ge(E)))return{u:"This url has no upper paths",p:null};if(f=encodeURIComponent,a="",c=false,m=null,v=0,$=0,h=false,(_=j.lastIndexOf("#")+1)&&(a=j.slice(_+ +("!"===j.substr(_,1))),((_=(s=n.jt(a)).lastIndexOf("/"))>0||0===_&&s.length>1)&&(h=s!==a,"/"===(m=(o=(b=/([^&=]+=)([^&\/=]*\/[^&]*)/).exec(s)||/(^|&)([^&\/=]*\/[^&=]*)(?:&|$)/.exec(s))?o[2]:s)||m.includes("://")?m=null:o?h?(s="https://example.com/",s=encodeURI(s+m).slice(s.length),(_=(a.indexOf(s)+1||a.indexOf(s=f(m))+1)-1)<0&&(h=false,_=a.indexOf(s=m)),$=_+s.length,_<0&&"&"!==o[1]&&((_=a.indexOf(s=o[1]))<0&&(h=true,s=f(o[1].slice(0,-1)),_=a.indexOf(s)),_>=0&&($=a.indexOf("&",_+=s.length)+1)),_>=0?v=_:(d=b.exec(a))?(m=n.jt(d[2]),$=(v=d.index+d[1].length)+d[2].length):"&"!==(s=o[1])&&(_=j.length-a.length,a=s+f(m),j=j.slice(0,_)+a,v=s.length,$=0)):v=o.index+o[1].length:v=0,m&&(v+=_=j.length-a.length,$>0&&($+=_)))),!m){if(E.startsWith(u.u.ut)&&!e.f)return{u:"An extension has no upper-level pages",p:null};a="",v=j.indexOf("/",j.indexOf("://")+3),E.startsWith("filesystem:")&&(v=j.indexOf("/",v+1)),_=j.indexOf("?",v=v<0?0:v),$=j.indexOf("#",v),m=j.slice(v,_=(_=$<0?_:_<0?$:_<$?_:$)>0?_:j.length),$=0,h=false}if(_=e.p,p=m.startsWith("/"),!a&&E.startsWith("file:")){if(m.length<=1||11===j.length&&j.endsWith(":/")){if(!e.f)return{u:"Here has been the root path",p:null};_=0}c=true,e.f||1===_&&(_=-1)}else c=!(a||!E.startsWith("ftp"))||(null!=e.t?!!e.t:null!=e.r?!!e.r:m.length>1&&m.endsWith("/")||/\.([a-z]{2,3}|apng|jpeg|tiff)$/i.test(m));return x=(w=m.slice(+p,m.length-+m.endsWith("/")).split("/")).length,k=_<0?_+x:_,g=x<=1&&_<=-2&&j.lastIndexOf("#",v)>0,w.length=_=k>x?x:_>0?k-1:k>0?k:0,m=w.join("/"),(s=e.a||"")&&(m+="/"===s[0]?s:"/"+s),m=m?("/"===m[0]?"":"/")+m+(!c||m.endsWith("/")?"":"/"):"/",!$&&j.lastIndexOf("git",v-3)>0&&(m=l(j,m)||m),!g||m&&"/"!==m?(s=h?f(m):m,j=j.slice(0,v)+($?s+j.slice($):s)):j=j.split("#",1)[0],(z=u.P(j,64,e.s)||j)!==j&&(R=t.Ee(z,null,-2),j=0===t._e?R:j),{u:j,p:m}},l=function(e,r){var u,t,i,l=n.xt(e),f=l?l.host:"";if(f&&/git\b|\bgit/i.test(f)&&/^[\w\-]+(\.\w+)?(:\d{2,5})?$/.test(f)&&((u=r.split("/"))[t=u.length-1]||(t--,u.pop()),i=u[t],f.startsWith("github."))){if(3===t)return"pull"===i||"milestone"===i||"commit"===i?r+"s":"tree"===i||"blob"===i?u.slice(0,3).join("/"):null;if(4===t&&"releases"===u[3]&&("tag"===u[4]||"edit"===u[4]))return u.slice(0,4).join("/");if(t>3)return"blob"===u[3]?(u[3]="tree",u.join("/")):null}},f=function(e,u){return"string"==typeof u&&u.toLowerCase().startsWith("whole")?r.Me(e):a(e)},r.Ue=f,a=function(e){var u,n,i,l,f,a,s,o=e.indexOf("\uff1a")+1||e.indexOf(":")+1;if(o&&"/"!==e[o]){if("link"!==(n=e.slice(0,o-1).trim().toLowerCase())&&"\u94fe\u63a5"!==n)return e;if(!(o=(u=e.slice(o).trim()).indexOf("\uff1a")+1||u.indexOf(":")+1)||!/^[\w+-]+((?:\.[\w+-])*\.[a-z]{2,6})?\//.test(u))return e}else{if(!o||"/"!==e.substr(o+1,1))return e;u=e}return l=!!(i=/\s|[^=][\u3002\uff0c\uff1b]([^a-z?&#-]|$)/.exec(u))&&1===i[0].length,a=/["(\u2018\u201c\u300a\uff08\uff1c]/,(s=((f=i?u.slice(0,i.index+(l?0:1)):null)||u).includes("#~:text=")?0:7)&&f&&(l?",.;\u3002\uff0c\uff1b".lastIndexOf(f.slice(-1),2)>=0?(u=f.slice(0,-1),s=3):'")\u2019\u201d\u300b\uff09\uff1e'.includes(f.slice(-1))&&(s=a.test(f.slice(o))?0:(u=f.slice(0,-1),1)):(u=f,s=3)),4&s&&",.;\u3002\uff0c\uff1b".includes(u.slice(-1))&&(u=u.slice(0,-1)),2&s&&'")\u2019\u201d\u300b\uff09\uff1e'.includes(u.slice(-1))&&(a.test(u.slice(o))?s=0:u=u.slice(0,-1)),u&&",.;\u3002\uff0c\uff1b".includes(u[0])&&(u=u.slice(1).trim()),1&s&&u&&a.test(u[0])&&(u=u.slice(1)),u=r.Me(u,false,true),t._e<=2&&!u.startsWith("vimium:")?u:e},r.Me=function(e,r,u){var n,i,l=+e.includes("\u3002")+2*+e.includes("\uff1a");return l||u?(n=e.indexOf("//"),(n=e.indexOf("/",n>=0?n+2:0))>=0&&n<4?e:(i=n>0?e.slice(0,n):e,/^(data|javascript)[:\uff1a]/i.test(i)?e:(1&l&&(i=i.replace(/\u3002/g,".")),2&l&&(i=i.replace("\uff1a",":").replace("\uff1a",":")),n>0&&(i+=e.slice(n)),t.Ee(i,null,-2),t._e<3?i:1!==l||!r||/[^.\w\u3002-]/.test(e)?e:e.replace(/\u3002/g,".")))):e},r.je=function(e){var r,n,t,i,l;if(2===u.yn.o&&e.startsWith("file://")){if((r=e.indexOf("/",7))<0||r===e.length-1)return r<0?e+"/":e;n=7===r?":"===e.charAt(9)?3:"%3a"===e.substr(9,3).toLowerCase()?5:0:0,e=n?e[8].toUpperCase()+":\\"+e.slice(n+8):7===r?e:"\\\\"+e.slice(7),l=(i=(t=/[?#]/.exec(e))?t.index:0)?e.slice(i):"",e=(e=i?e.slice(0,i):e).replace(/\/+/g,"\\"),e=i?e+l:e}return e},s=function(e,u){var i,l,f,a,s,p,c,g,m,_,v,$=[],h=t.ze,d=/\s/,b=function(e){return!!((e=e.trim())&&"__proto__"!==e&&e.length<51)&&(u.set(e,s),true)};for(c of e.replace(/\\\\?\n/g,function(e){return 3===e.length?"\\\n":""}).split("\n"))if(!((c=c.trim())<"$")){p=0;do{p=c.indexOf(":",p+1)}while(92===c.charCodeAt(p-1));p<=0||!(a=c.slice(0,p).trimRight())||(i=a.replace(/\\:/g,":").split("|"),(c=c.slice(p+1).trimLeft())&&(g="",(p=(a=c.replace(/\\\s/g,"\\s")).search(d))>0?(e=c.slice(p),c=a.slice(0,p),(p=e.search(/\sblank=/i))>=0&&(m=e.slice(p+7).search(d),g=e.slice(p+7,(m=m>0?p+7+m:0)||void 0),e=e.slice(0,p)+(m?e.slice(m):"")),p=e.search(/\sre=/i)):(c=a,e=""),c=c.replace(/\\s/g," ").trim().replace(/([^\\]|^)%(s)/gi,"$1$$$2").replace(/\\%/g,"%"),s={De:"",B:g,Ae:c},0!==(i=i.filter(b)).length&&(-1===p?(h.lastIndex=0,(_=h.exec(c))&&(p=_.index+1)&&((a=_[2])?c=c.replace(h,"$$$1"):a="s"===_[1]?"+":" ",c=t.Ee(c,null,-1),t._e>2?p=(c=c.replace(/%24(s)/gi,"$$$1")).search(h)+1:0!==t._e&&(p+=2===t._e?7:5),(l=o(c.toLowerCase(),p))&&(a.includes("$")?(a=a.replace(t.$e,"(.*)"),f=new RegExp("^"+a,/[a-z]/i.test(a)?"i":"")):f=a.trim()||" ",$.push({Oe:l.Oe,Te:l.Te,De:i[0].trimRight(),Be:f})))):47===e.charCodeAt(p+4)?(a=p>1?e.slice(1,p).trim():"",p=(e=e.slice(p+5)).search(/[^\\]\//)+1,c=e.slice(0,p),p=(e=e.slice(p+1)).search(d),(v=n.m(c,p>=0?e.slice(0,p):e))&&(a=r.ke(a),$.push({Oe:a,Te:v,De:i[0].trimRight(),Be:s.Ae.lastIndexOf("$S")>=0?" ":"+"})),e=p>=0?e.slice(p+1):""):e=e.slice(p+4),e=e.trimLeft(),s.De=e?n.jt(e):i[i.length-1].trimLeft())))}return $},r.Re=s,o=function(e,u){return u<1||!n.Dt.test(e)?null:(t=e.slice(0,u-1),(u=Math.max(t.lastIndexOf("?"),t.lastIndexOf("#"))+1)?(l=i=t.slice(u),t=t.slice(0,t.search(/[#?]/)),(f=i.lastIndexOf("&")+1)&&(l=i.slice(f)),l&&l.indexOf("=")>=1?(i="[#&?]",e="([^#&]*)"):(l=i,i="#"===e[u-1]?"#":l?"[#?]":"\\?",e="([^#&?]*)")):(i="^([^#?]*)",(l=e.slice(t.length+2))&&(u=l.search(/[#?]/)+1)&&(l=l.slice(0,u-1)),e=""),l=l&&n.t(l).replace(/\\\+|%20| /g,"(?:\\+|%20| )"),{Oe:t=r.ke(t),Te:new RegExp(i+l+e,/[a-z]/i.test(l)?"i":"")});var t,i,l,f},r.ke=function(e){var r=e.slice(0,9).toLowerCase(),u=n.v(r);return u?e=e.slice(u):"vimium://"===r&&(e=t.he(e.slice(9),false,-1)),e}});